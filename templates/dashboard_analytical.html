{% extends "base.html" %}

{% block title %}Analytical Dashboard{% endblock %}

{% block body_attributes %}class="analytical-page"{% endblock %}
{% block html_attributes %}class="analytical-page"{% endblock %}

{# Override and completely remove the navbar #}
{% block navbar %}{% endblock %}

{% block head %}
<!-- Load Font Awesome in the head to ensure icons are available when content renders -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<!-- Chart.js for data visualization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Modern design styling for Analytical Dashboard -->
<style>
    /* Global styles for analytical dashboard */
    html.analytical-page, body.analytical-page {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow-x: hidden;
        font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: transparent !important;
        color: #ffffff;
        scroll-behavior: smooth;
    }
    
    /* Override base.html gray background for analytical dashboard */
    html.analytical-page, body.analytical-page, 
    .analytical-page .container, .analytical-page .container-fluid, 
    .analytical-page main, .analytical-page .content, 
    .analytical-page .content-wrapper, .analytical-page .dashboard-wrapper,
    .analytical-page .row, .analytical-page .col, 
    .analytical-page div[class^="col-"], .analytical-page .card-body, 
    .analytical-page .card-footer, .analytical-page #main-content, 
    .analytical-page .page-content, .analytical-page .dashboard, 
    .analytical-page section, .analytical-page .tab-content, 
    .analytical-page .tab-pane {
        background-color: transparent !important;
        background: transparent !important;
    }
    
    /* Remove the gray overlay pseudo-element from base.html */
    body.analytical-page::before {
        display: none !important;
    }
    
    /* Hide the default navigation header for analytical dashboard */
    body.analytical-page nav.navbar {
        display: none !important;
    }

    /* Video background for analytical dashboard */
    .video-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        overflow: hidden;
    }
    
    /* Modern dashboard title */
    .dashboard-title {
        font-weight: 600;
        font-size: 2.2rem;
        letter-spacing: 0.5px;
        margin-bottom: 1.5rem;
        background: linear-gradient(90deg, #ffffff, #e0e0e0);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .dashboard-subtitle {
        font-weight: 400;
        opacity: 0.8;
    }
    
    /* Modern form controls */
    .modern-select {
        background: rgba(30, 41, 59, 0.8);
        color: white;
        border: 1px solid rgba(78, 152, 227, 0.3);
        border-radius: 8px;
        padding: 10px 15px;
        transition: all 0.3s ease;
    }
    
    .modern-select:focus {
        box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.3);
        border-color: rgba(79, 172, 254, 0.5);
        outline: none;
    }
    
    .modern-btn {
        background: linear-gradient(135deg, #4facfe, #00f2fe);
        border: none;
        box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .modern-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(79, 172, 254, 0.6);
    }
    
    .modern-btn-secondary {
        background: rgba(30, 41, 59, 0.6);
        border: 1px solid rgba(78, 152, 227, 0.3);
        box-shadow: 0 4px 15px rgba(30, 41, 59, 0.3);
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 500;
        transition: all 0.3s ease;
        color: white;
    }
    
    .modern-btn-secondary:hover {
        background: rgba(30, 41, 59, 0.8);
        transform: translateY(-2px);
    }

    .video-background video {
        position: absolute;
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        object-fit: cover;
        opacity: 0.9;
    }

    /* Modern glass panels with blur effect - Now with gradient borders */
    .glass-panel {
        background: rgba(30, 41, 59, 0.65) !important;
        backdrop-filter: blur(12px) !important;
        -webkit-backdrop-filter: blur(12px) !important;
        border-radius: 20px !important;
        border: 1px solid rgba(78, 152, 227, 0.3) !important;
        box-shadow: 0 8px 32px 0 rgba(15, 23, 42, 0.5) !important;
        padding: 20px;
        margin-bottom: 24px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .glass-panel::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        z-index: 1;
    }

    .glass-panel:hover {
        box-shadow: 0 12px 40px 0 rgba(16, 24, 40, 0.6) !important;
        transform: translateY(-5px);
    }

    /* Card styling with glassmorphism - updated with modern gradients */
    .card {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-radius: 15px;
        border: 1px solid rgba(78, 152, 227, 0.2);
        box-shadow: 0 8px 24px 0 rgba(15, 23, 42, 0.3);
        overflow: hidden;
        transition: all 0.3s ease;
        height: 100%;
        margin-bottom: 20px;
        position: relative;
    }
    
    .card::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px 0 rgba(15, 23, 42, 0.4);
    }
    
    .card:hover::after {
        opacity: 1;
    }

    .card-header {
        background: rgba(30, 41, 59, 0.8);
        border-bottom: 1px solid rgba(78, 152, 227, 0.2);
        padding: 15px 20px;
    }

    .card-title {
        margin-bottom: 0;
        color: #fff;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .card-body {
        padding: 20px;
    }

    /* Chart container styling with glassmorphism */
    .chart-container {
        position: relative;
        height: 350px;
        margin-bottom: 0;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.08);
        padding: 10px;
    }
    
    /* Metric cards styles - modern vertical design */
    .metric-card {
        padding: 20px 15px;
        border-radius: 15px;
        position: relative;
        overflow: hidden;
        width: 170px;
        min-height: 220px;
        margin-right: 15px;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        background: rgba(30, 41, 59, 0.75);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(78, 152, 227, 0.2);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
    }

    .metric-icon {
        position: relative;
        width: 60px;
        height: 60px;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 50%;
        margin: 0 auto 15px;
        font-size: 26px;
        /* Ensure top-center positioning */
        top: 0;
        left: 50%;
        transform: translateX(-50%);
    }
    
    .blue-glow .metric-icon {
        background: rgba(79, 172, 254, 0.2);
        box-shadow: 0 0 15px rgba(79, 172, 254, 0.5);
        color: #4facfe;
    }
    
    .green-glow .metric-icon {
        background: rgba(0, 230, 118, 0.2);
        box-shadow: 0 0 15px rgba(0, 230, 118, 0.5);
        color: #00e676;
    }
    
    .purple-glow .metric-icon {
        background: rgba(153, 102, 255, 0.2);
        box-shadow: 0 0 15px rgba(153, 102, 255, 0.5);
        color: #9966ff;
    }
    
    .orange-glow .metric-icon {
        background: rgba(255, 153, 0, 0.2);
        box-shadow: 0 0 15px rgba(255, 153, 0, 0.5);
        color: #ff9900;
    }
    
    .teal-glow .metric-icon {
        background: rgba(20, 184, 166, 0.2);
        box-shadow: 0 0 15px rgba(20, 184, 166, 0.5);
        color: #14b8a6;
    }
    
    .red-glow .metric-icon {
        background: rgba(244, 67, 54, 0.2);
        box-shadow: 0 0 15px rgba(244, 67, 54, 0.5);
        color: #f44336;
    }
    
    .metric-value {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 10px 0;
        background: linear-gradient(90deg, #ffffff 0%, #e0e0e0 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .metric-label {
        font-size: 1rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 15px;
        line-height: 1.2;
        /* Ensure label doesn't overflow in narrow cards */
        max-width: 95%;
    }
    
    .metric-footer {
        margin-top: auto;
        width: 100%;
    }
    
    .metric-progress {
        width: 100%;
        height: 4px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 2px;
        overflow: hidden;
        margin-top: 5px;
    }
    
    /* Progress bar color variants */
    .progress-bar {
        height: 100%;
        transition: width 0.8s ease-in-out;
    }
    
    /* Custom progress bar styles */
    .w-full {
        width: 100%;
    }
    
    /* Dynamic width classes for progress bars */
    .w-20 { width: 20%; }
    .w-25 { width: 25%; }
    .w-30 { width: 30%; }
    .w-40 { width: 40%; }
    .w-50 { width: 50%; }
    .w-60 { width: 60%; }
    .w-70 { width: 70%; }
    .w-75 { width: 75%; }
    .w-80 { width: 80%; }
    .w-90 { width: 90%; }
    .w-100 { width: 100%; }
    
    .progress-blue {
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .progress-green {
        background: linear-gradient(90deg, #0ba360 0%, #3cba92 100%);
    }
    
    .progress-orange {
        background: linear-gradient(90deg, #f09819 0%, #edde5d 100%);
    }
    
    .progress-purple {
        background: linear-gradient(90deg, #8e2de2 0%, #4a00e0 100%);
    }
    
    .progress-teal {
        background: linear-gradient(90deg, #2193b0 0%, #6dd5ed 100%);
    }
    
    .progress-red {
        background: linear-gradient(90deg, #f44336 0%, #ff7961 100%);
    }

    /* Main content styles - full width now */
    .analytical-content {
        width: 100%;
        background: transparent !important;
        padding: 20px;
        position: relative;
        z-index: 1;
        overflow-x: hidden;
        min-height: 100vh;
    }
    
    /* Improved glass panel styling */
    .glass-panel {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 12px;
        overflow: hidden;
    }
    
    /* Improved spacing for charts */
    .chart-container {
        padding: 10px;
    }
    
    /* Improved card styling */
    .card {
        border-radius: 10px;
        margin-bottom: 0;
    }
    
    /* Improved row spacing */
    .row {
        margin-right: -8px;
        margin-left: -8px;
    }
    
    .col, .col-lg-6, .col-12 {
        padding-right: 8px;
        padding-left: 8px;
    }
    
    /* Card height consistency */
    .card.h-100 {
        height: calc(100% - 10px) !important;
        margin: 5px 0;
    }
    
    /* Tag cloud styling */
    .tag-cloud {
        display: flex;
        flex-wrap: wrap;
        align-content: flex-start;
        gap: 8px;
        padding: 5px;
    }
    
    /* Sidebar toggle button for mobile */
    .sidebar-toggle {
        display: none;
        position: fixed;
        top: 15px;
        left: 15px;
        z-index: 1001;
        background: rgba(40, 60, 100, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 5px;
        padding: 5px 10px;
        color: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    
    /* Logo and site title in sidebar */
    .sidebar-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .sidebar-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: white;
        margin-top: 10px;
        letter-spacing: 1px;
        text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    /* Navigation links */
    .sidebar-nav {
        margin-bottom: 30px;
    }
    
    .sidebar-nav-item {
        display: block;
        padding: 12px 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        color: rgba(255, 255, 255, 0.9) !important;
        text-decoration: none;
        transition: all 0.2s ease;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .sidebar-nav-item:hover, .sidebar-nav-item.active {
        background: rgba(255, 255, 255, 0.2);
        color: white !important;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .sidebar-nav-item i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
    }
    
    /* Filter section in sidebar */
    .sidebar-filters {
        margin-bottom: 30px;
    }
    
    .sidebar-section-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: white;
        position: relative;
        padding-bottom: 8px;
    }
    
    .sidebar-section-title:after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 50px;
        height: 3px;
        background: linear-gradient(90deg, rgba(79, 172, 254, 0.8), rgba(0, 242, 254, 0.8));
        border-radius: 3px;
    }
    
    /* Responsive adjustments */
    @media (max-width: 992px) {
        .glass-sidebar {
            transform: translateX(-100%);
        }
        
        .glass-sidebar.show-sidebar {
            transform: translateX(0);
        }
        
        .main-content-with-sidebar {
            margin-left: 0;
            width: 100%;
        }
        
        .sidebar-toggle {
            display: block;
        }
    }
    
    /* Metric card container - eliminate vertical spacing */
    .metric-card-container {
        margin: 0 !important;
        padding: 0 !important;
    }
    
    /* CRITICAL: Override base template gray backgrounds for analytical dashboard */
    .analytical-page html, 
    .analytical-page body, 
    .analytical-page .container, 
    .analytical-page .container-fluid, 
    .analytical-page main, 
    .analytical-page .content, 
    .analytical-page .content-wrapper, 
    .analytical-page .dashboard-wrapper,
    .analytical-page .row, 
    .analytical-page .col, 
    .analytical-page div[class^="col-"], 
    .analytical-page .card-body, 
    .analytical-page .card-footer, 
    .analytical-page #main-content, 
    .analytical-page .page-content,
    .analytical-page .dashboard, 
    .analytical-page section, 
    .analytical-page .tab-content, 
    .analytical-page .tab-pane {
        background-color: transparent !important;
        background: transparent !important;
    }
    
    /* Hide the gray overlay pseudo-element from base template */
    .analytical-page body::before {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
    }
    
    /* Ensure all divs and containers are transparent */
    .analytical-page div:not(.glass-panel):not(.metric-card):not(.sidebar) {
        background-color: transparent !important;
        background: transparent !important;
    }
    
    /* Ensure all divs and containers are transparent */
    .analytical-page div:not(.glass-panel):not(.metric-card):not(.sidebar) {
        background-color: transparent !important;
        background: transparent !important;
    }
    
    /* Additional overrides for any remaining gray backgrounds */
    html, body {
        background-color: transparent !important;
        background: transparent !important;
    }
    
    /* Force hide any pseudo-elements that might create gray overlays */
    body::before, html::before, *::before {
        background-color: transparent !important;
        background: transparent !important;
        display: none !important;
    }

    /* Metric card content styles */
    .metric-value {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 10px 0;
        background: linear-gradient(90deg, #ffffff 0%, #e0e0e0 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .metric-label {
        font-size: 1rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 15px;
        line-height: 1.2;
    }

    .metric-footer {
        margin-top: auto;
        width: 100%;
    }

    .metric-progress {
        width: 100%;
        height: 4px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 2px;
        overflow: hidden;
        margin-top: 10px;
    }

    .progress-bar {
        height: 100%;
        border-radius: 2px;
        transition: width 0.6s ease;
    }

    .progress-blue {
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
    }

    .progress-orange {
        background: linear-gradient(90deg, #ff9900 0%, #ffb347 100%);
    }

    .progress-purple {
        background: linear-gradient(90deg, #9966ff 0%, #cc99ff 100%);
    }

    .progress-teal {
        background: linear-gradient(90deg, #14b8a6 0%, #5eead4 100%);
    }

    .progress-green {
        background: linear-gradient(90deg, #00e676 0%, #69f0ae 100%);
    }

    .progress-red {
        background: linear-gradient(90deg, #f44336 0%, #ff8a80 100%);
    }

    /* Glow effects for metric cards */
    .blue-glow {
        border-color: rgba(33, 150, 243, 0.3);
        box-shadow: 0 8px 32px rgba(33, 150, 243, 0.2);
    }
    
    /* Orange glow effect */
    .orange-glow {
        border-color: rgba(255, 152, 0, 0.3);
        box-shadow: 0 8px 32px rgba(255, 152, 0, 0.2);
    }
    
    /* Purple glow effect */
    .purple-glow {
        border-color: rgba(156, 39, 176, 0.3);
        box-shadow: 0 8px 32px rgba(156, 39, 176, 0.2);
    }
    
    /* Teal glow effect */
    .teal-glow {
        border-color: rgba(0, 150, 136, 0.3);
        box-shadow: 0 8px 32px rgba(0, 150, 136, 0.2);
    }
    
    /* Green glow effect */
    .green-glow {
        border-color: rgba(76, 175, 80, 0.3);
        box-shadow: 0 8px 32px rgba(76, 175, 80, 0.2);
    }
    
    /* Red glow effect */
    .red-glow {
        border-color: rgba(244, 67, 54, 0.3);
        box-shadow: 0 8px 32px rgba(244, 67, 54, 0.2);
    }

    /* Metric Card Container */
    .metric-card-container {
        display: flex;
        overflow-x: auto;
        padding: 20px 0;
        gap: 15px;
        margin-bottom: 20px;
        scrollbar-width: thin;
    }

    /* Complete Metric Card Styling */
    .metric-card {
        background: rgba(30, 41, 59, 0.75);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 20px 15px;
        width: 170px;
        min-height: 220px;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        transition: all 0.3s ease;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        margin-right: 15px;
    }
    
    /* Metric Values */
    .metric-value {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 5px 0;
        color: #fff;
    }
    
    /* Metric Labels */
    .metric-label {
        font-size: 1rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.7);
        margin: 0 0 15px;
    }
    
    /* Metric Footer with Progress Bar */
    .metric-footer {
        width: 100%;
        margin-top: auto;
    }
    
    .metric-progress {
        width: 100%;
        background: rgba(255, 255, 255, 0.1);
        height: 6px;
        border-radius: 3px;
        overflow: hidden;
    }
    
    /* Progress Bar Colors */
    .progress-blue {
        background: linear-gradient(90deg, #2196F3, #03A9F4);
        height: 6px;
        border-radius: 3px;
        transition: width 0.5s ease;
    }
    
    .progress-orange {
        background: linear-gradient(90deg, #FF9800, #FF5722);
        height: 6px;
        border-radius: 3px;
        transition: width 0.5s ease;
    }
    
    .progress-purple {
        background: linear-gradient(90deg, #9C27B0, #673AB7);
        height: 6px;
        border-radius: 3px;
        transition: width 0.5s ease;
    }
    
    .progress-teal {
        background: linear-gradient(90deg, #009688, #4DB6AC);
        height: 6px;
        border-radius: 3px;
        transition: width 0.5s ease;
    }
    
    .progress-green {
        background: linear-gradient(90deg, #4CAF50, #8BC34A);
        height: 6px;
        border-radius: 3px;
        transition: width 0.5s ease;
    }
    
    .progress-red {
        background: linear-gradient(90deg, #F44336, #E91E63);
        height: 6px;
        border-radius: 3px;
        transition: width 0.5s ease;
    }

    /* Metric icon styles */
    .metric-icon {
        position: relative;
        width: 60px;
        height: 60px;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 50%;
        margin: 0 auto 15px;
        font-size: 24px;
    }

    .blue-glow .metric-icon {
        background: rgba(79, 172, 254, 0.2);
        box-shadow: 0 0 15px rgba(79, 172, 254, 0.5);
        color: #4facfe;
    }

    .orange-glow .metric-icon {
        background: rgba(255, 153, 0, 0.2);
        box-shadow: 0 0 15px rgba(255, 153, 0, 0.5);
        color: #ff9900;
    }

    .purple-glow .metric-icon {
        background: rgba(153, 102, 255, 0.2);
        box-shadow: 0 0 15px rgba(153, 102, 255, 0.5);
        color: #9966ff;
    }

    .teal-glow .metric-icon {
        background: rgba(20, 184, 166, 0.2);
        box-shadow: 0 0 15px rgba(20, 184, 166, 0.5);
        color: #14b8a6;
    }

    .green-glow .metric-icon {
        background: rgba(0, 230, 118, 0.2);
        box-shadow: 0 0 15px rgba(0, 230, 118, 0.5);
        color: #00e676;
    }

    .red-glow .metric-icon {
        background: rgba(244, 67, 54, 0.2);
        box-shadow: 0 0 15px rgba(244, 67, 54, 0.5);
        color: #f44336;
    }

    .metric-progress-value {
        height: 100%;
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        border-radius: 2px;
        transition: width 1s ease-in-out;
        width: 0%;
    }

    /* Fixed Header Navigation Styles */
    .dashboard-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        background: rgba(30, 41, 59, 0.95);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        height: 70px;
        display: flex;
        align-items: center;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
    }
    
    .header-container {
        width: 100%;
        max-width: 100%;
        padding: 0 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .header-left .dashboard-title {
        color: #ffffff;
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .header-nav {
        display: flex;
        gap: 30px;
        align-items: center;
    }
    
    .header-nav .nav-link {
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        font-weight: 500;
        padding: 8px 16px;
        border-radius: 8px;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .header-nav .nav-link:hover {
        color: #ffffff;
        background: rgba(255, 255, 255, 0.1);
        transform: translateY(-1px);
    }
    
    .header-nav .nav-link.active {
        color: #ffffff;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .filter-controls {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .filter-controls .form-select {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #ffffff;
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 0.875rem;
        min-width: 120px;
    }
    
    .filter-controls .form-select:focus {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.3);
        box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.1);
        color: #ffffff;
    }
    
    .filter-controls .form-select option {
        background: #1e293b;
        color: #ffffff;
    }
    
    .filter-controls .btn {
        padding: 6px 16px;
        font-size: 0.875rem;
        border-radius: 6px;
        font-weight: 600;
    }
    
    /* Mobile Filters Panel */
    .mobile-filters-panel {
        position: fixed;
        top: 70px;
        left: 0;
        right: 0;
        z-index: 999;
        background: rgba(30, 41, 59, 0.95);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding: 15px 20px;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
    }
    
    .mobile-filters-content .form-select {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #ffffff;
        border-radius: 6px;
        font-size: 0.875rem;
    }
    
    .mobile-filters-content .form-select:focus {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.3);
        box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.1);
        color: #ffffff;
    }
    
    .mobile-filters-content .form-select option {
        background: #1e293b;
        color: #ffffff;
    }
    
    /* Main Content Spacing */
    .main-content {
        margin-top: 70px;
        padding: 20px;
        min-height: calc(100vh - 70px);
        width: 100%;
        position: relative;
        z-index: 1;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .header-center {
            display: none;
        }
        
        .header-container {
            padding: 0 15px;
        }
        
        .dashboard-header {
            height: 60px;
        }
        
        .main-content {
            margin-top: 60px;
        }
        
        .mobile-filters-panel {
            top: 60px;
        }
    }
</style>

<script>
// Wait for DOM to be ready before applying classes and initializing video
document.addEventListener('DOMContentLoaded', function() {
    // Apply analytical-page class and remove gray backgrounds
    document.documentElement.classList.add('analytical-page');
    document.body.classList.add('analytical-page');
    document.documentElement.style.backgroundColor = 'transparent';
    document.body.style.backgroundColor = 'transparent';
    
    // Function to update the progress bars based on data-value and data-max attributes
    function updateBarIndicators() {
        var progressBars = document.querySelectorAll('.metric-progress-value');
        for (var i = 0; i < progressBars.length; i++) {
            var bar = progressBars[i];
            var value = parseFloat(bar.getAttribute('data-value') || '0');
            var max = parseFloat(bar.getAttribute('data-max') || '100');
            var percent = (value / max) * 100;
            
            // Ensure at least a small visible portion of the progress bar
            percent = Math.max(percent, 2);
            // Cap at 100%
            percent = Math.min(percent, 100);
            
            bar.style.width = percent + '%';
        }
    }

    // Initialize all progress bars
    updateBarIndicators();
    
    // Initialize video background
    const video = document.querySelector('.video-background video');
    
    // Disable video for performance improvement if causing errors
    if (video) {
        video.addEventListener('error', function(e) {
            console.log('Video error detected, disabling video for performance');
            var vidContainer = document.querySelector('.video-background');
            if (vidContainer) {
                // Replace video with a static gradient background for better performance
                vidContainer.innerHTML = '';
                vidContainer.style.background = 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)';
            }
        });
    }
    if (video && video.dataset.src) {
        try {
            video.src = video.dataset.src;
            video.load();
            
            // Ensure video plays
            video.play().catch(function(error) {
                console.log('Video autoplay failed:', error);
            });
        } catch(e) {
            console.error('Video initialization error:', e);
            // Add fallback styling
            document.querySelector('.video-background').style.backgroundColor = 'rgba(8, 23, 54, 0.9)';
        }
    }
    
    // Update progress bars when page loads
    updateBarIndicators();
    
    // Initialize charts
    initializeCharts();
    
    // Set up filter handlers for dropdown controls
    var filters = document.querySelectorAll('.filter-control');
    filters.forEach(function(filter) {
        filter.addEventListener('change', filterDashboard);
    });
    
    // Initialize filter button functionality 
    var applyFilterBtn = document.getElementById('applyFilter');
    if (applyFilterBtn) {
        applyFilterBtn.addEventListener('click', function(){
            filterDashboard();
        });
    }
    
    // Add tag filter functionality for clickable tags
    var tags = document.querySelectorAll('.tag');
    if (tags && tags.length > 0) {
        for (var i = 0; i < tags.length; i++) {
            tags[i].addEventListener('click', function() {
                filterByTag(this.textContent.trim());
            });
        }
    }
    
    // Reset filters button handler
    var resetBtn = document.getElementById('resetFiltersBtn');
    if (resetBtn) {
        resetBtn.addEventListener('click', function() {
            resetFilters();
        });
    }
    
    // Sidebar toggle functionality for mobile responsive design
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.querySelector('.main-content-with-sidebar');
    
    if (sidebarToggle && sidebar) {
        sidebarToggle.addEventListener('click', function() {
            sidebar.classList.toggle('show-sidebar');
            
            // Add a click handler to close sidebar when clicking outside on mobile
            if (sidebar.classList.contains('show-sidebar')) {
                document.addEventListener('click', function closeSidebar(e) {
                    if (!sidebar.contains(e.target) && e.target !== sidebarToggle) {
                        sidebar.classList.remove('show-sidebar');
                        document.removeEventListener('click', closeSidebar);
                    }
                });
            }
        });
    }
    
    // Initialize progress bars and set up event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Force CSS to be applied to Font Awesome icons
        document.querySelectorAll('.fas').forEach(function(icon) {
            icon.style.display = 'inline-block';
            icon.style.fontSize = '24px';
        });
        
        // Set up mobile filter toggle
        const toggleFiltersBtn = document.getElementById('toggleFilters');
        if (toggleFiltersBtn) {
            toggleFiltersBtn.addEventListener('click', toggleMobileFilters);
        }
        
        // Set initial widths for progress bars
        var progressBars = document.querySelectorAll('.metric-progress-value');
        console.log('Found ' + progressBars.length + ' progress bars to update');
        
        // First make sure all bars exist and are visible
        progressBars.forEach(function(bar) {
            // Ensure basic styling is applied
            bar.style.height = '6px';
            bar.style.borderRadius = '3px';
            bar.style.transition = 'width 1s ease-in-out';
        });
        
        // Then apply the width with a delay to allow transition animation
        setTimeout(function() {
            progressBars.forEach(function(bar) {
                var value = parseFloat(bar.getAttribute('data-value') || bar.style.width);
                var max = parseFloat(bar.getAttribute('data-max') || 100);
                var percent = (value / max) * 100;
                
                // Ensure at least a small visible portion
                percent = Math.max(percent, 5);
                // Cap at 100%
                percent = Math.min(percent, 100);
                
                console.log('Setting bar width to: ' + percent + '%', bar);
                bar.style.width = percent + '%';
            });
        }, 300);
    });
});

// All JavaScript functions defined outside of any event listeners

// Function to update progress bar indicators
function updateBarIndicators() {
    var progressBars = document.querySelectorAll('.metric-progress-value');
    for (var i = 0; i < progressBars.length; i++) {
        var bar = progressBars[i];
        var value = parseFloat(bar.getAttribute('data-value') || bar.style.width);
        var max = parseFloat(bar.getAttribute('data-max') || 100);
        var percent = (value / max) * 100;
        percent = Math.max(percent, 3);
        bar.style.width = percent + '%';
    }
}

// Chart initialization function
function initializeCharts() {
    initCategoryChart();
    initRatingDistributionChart();
    initTagActivityChart();
}

// Initialize the Top Rated Products by Category chart
function initCategoryChart() {
    var chartElement = document.getElementById('topRatedProductsChart');
    if (!chartElement) return;
    
    var ctx = chartElement.getContext('2d');
    var productCounts = [];
    
    // Create chart with empty data initially
    window.categoryChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Average Rating',
                data: [],
                backgroundColor: 'rgba(79, 172, 254, 0.7)',
                borderColor: 'rgba(79, 172, 254, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 5,
                    title: {
                        display: true,
                        text: 'Average Rating (1-5)',
                        color: 'rgba(255, 255, 255, 0.9)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: 'rgba(255, 255, 255, 0.9)'
                    }
                },
                title: {
                    display: true,
                    text: 'Top Rated Products by Category',
                    color: 'rgba(255, 255, 255, 0.9)',
                    font: {
                        size: 16
                    }
                },
                tooltip: {
                    callbacks: {
                        afterLabel: function(context) {
                            const index = context.dataIndex;
                            if (productCounts && productCounts.length > index) {
                                return `Products: ${productCounts[index]}`;
                            }
                            return '';
                        }
                    }
                }
            }
        }
    });
    
    // Fetch data from API right after chart initialization
    fetchCategoryData();
    
    // Function to fetch category data from API endpoint
    function fetchCategoryData() {
        fetch('/api/category-chart-data')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.category_names && data.category_names.length > 0) {
                    // Successfully got data from the API
                    const categoryNames = data.category_names;
                    const categoryRatings = data.category_ratings;
                    productCounts = data.product_counts || [];
                    
                    updateCategoryChart(categoryNames, categoryRatings);
                } else {
                    useFallbackCategoryData();
                }
            })
            .catch(error => {
                useFallbackCategoryData();
            });
    }
    
    // Function to update chart with the data
    function updateCategoryChart(names, ratings) {
        if (!names || !ratings || names.length === 0 || ratings.length === 0) {
            return;
        }
        
        // Sort data by ratings in descending order
        const combinedData = names.map((name, index) => {
            return { 
                name: name, 
                rating: ratings[index],
                count: productCounts[index] || 0
            };
        });
        
        combinedData.sort((a, b) => b.rating - a.rating);
        
        // Get sorted arrays
        const sortedNames = combinedData.map(item => item.name);
        const sortedRatings = combinedData.map(item => item.rating);
        const sortedCounts = combinedData.map(item => item.count);
        
        // Update the chart with sorted data
        window.categoryChart.data.labels = sortedNames;
        window.categoryChart.data.datasets[0].data = sortedRatings;
        
        // Update colors based on ratings
        window.categoryChart.data.datasets[0].backgroundColor = sortedRatings.map(rating => {
            if (rating >= 4.5) return 'rgba(0, 230, 118, 0.7)';
            if (rating >= 4.0) return 'rgba(79, 172, 254, 0.7)';
            if (rating >= 3.5) return 'rgba(255, 193, 7, 0.7)';
            if (rating >= 3.0) return 'rgba(255, 152, 0, 0.7)';
            return 'rgba(244, 67, 54, 0.7)';
        });
        
        window.categoryChart.data.datasets[0].borderColor = sortedRatings.map(rating => {
            if (rating >= 4.5) return 'rgba(0, 230, 118, 1)';
            if (rating >= 4.0) return 'rgba(79, 172, 254, 1)';
            if (rating >= 3.5) return 'rgba(255, 193, 7, 1)';
            if (rating >= 3.0) return 'rgba(255, 152, 0, 1)';
            return 'rgba(244, 67, 54, 1)';
        });
        
        // Update chart
        window.categoryChart.update();
    }
    
    // Function to use fallback sample data
    function useFallbackCategoryData() {
        const fallbackNames = ['Electronics', 'Clothing', 'Home', 'Sports', 'Books', 'Beauty', 'Toys', 'Automotive', 'Health', 'Garden'];
        const fallbackRatings = [4.7, 4.3, 4.1, 3.9, 4.5, 4.2, 3.8, 3.5, 4.0, 3.7];
        updateCategoryChart(fallbackNames, fallbackRatings);
    }
}

// Initialize the Rating Distribution Chart
function initRatingDistributionChart() {
    var chartElement = document.getElementById('ratingDistributionChart');
    if (!chartElement) {
        return;
    }
    
    var ctx = chartElement.getContext('2d');
    var parsedData;
    try {
        var ratingStr = '{{ rating_distribution|safe }}';
        if (ratingStr && ratingStr !== '[]' && ratingStr !== 'null') {
            parsedData = JSON.parse(ratingStr);
        } else {
            throw new Error('Invalid rating distribution data');
        }
    } catch (e) {
        parsedData = [];
    }
    
    if (!parsedData || !Array.isArray(parsedData) || parsedData.length === 0) {
        parsedData = [150, 230, 180, 320, 240];
    }
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['1 Star', '2 Stars', '3 Stars', '4 Stars', '5 Stars'],
            datasets: [{
                label: 'Rating Distribution',
                data: parsedData,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.7)',
                    'rgba(255, 159, 64, 0.7)',
                    'rgba(255, 205, 86, 0.7)',
                    'rgba(75, 192, 192, 0.7)',
                    'rgba(54, 162, 235, 0.7)'
                ],
                borderColor: [
                    'rgb(255, 99, 132)',
                    'rgb(255, 159, 64)',
                    'rgb(255, 205, 86)',
                    'rgb(75, 192, 192)',
                    'rgb(54, 162, 235)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: {
                        size: 14
                    },
                    bodyFont: {
                        size: 13
                    },
                    callbacks: {
                        label: function(context) {
                            return ' Products: ' + context.raw;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false,
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#f1f5f9'
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#f1f5f9'
                    }
                }
            }
        }
    });
}

// Initialize the Tag Activity Chart
function initTagActivityChart() {
    var ctx = document.getElementById('tagActivityChart');
    if (!ctx) {
        return;
    }
    ctx = ctx.getContext('2d');

    var tagActivity = [];
    var activityTagNames = [];
    
    try {
        var tagActivityStr = '{{ tag_activity|safe }}';
        var activityTagNamesStr = '{{ tag_names|safe }}';
        
        if (tagActivityStr && tagActivityStr !== '[]' && tagActivityStr !== 'null') {
            tagActivity = JSON.parse(tagActivityStr);
        } else {
            throw new Error('Invalid tag activity data');
        }
        
        if (activityTagNamesStr && activityTagNamesStr !== '[]' && activityTagNamesStr !== 'null') {
            activityTagNames = JSON.parse(activityTagNamesStr);
        }
    } catch (parseError) {
        tagActivity = [];
        activityTagNames = [];
    }
    
    if (!tagActivity || !Array.isArray(tagActivity) || tagActivity.length === 0) {
        tagActivity = [
            [12, 15, 18, 22, 25, 30],  // Tag 1
            [8, 10, 12, 15, 18, 20],   // Tag 2
            [20, 18, 16, 14, 15, 17],  // Tag 3
            [5, 8, 10, 12, 15, 18],    // Tag 4
            [15, 13, 12, 10, 8, 10]    // Tag 5
        ];
    }
    
    if (!activityTagNames || !Array.isArray(activityTagNames) || activityTagNames.length === 0) {
        activityTagNames = ['Electronics', 'Clothing', 'Home', 'Sports', 'Books'];
    }
    
    activityTagNames = activityTagNames.slice(0, 5);
    tagActivity = tagActivity.slice(0, Math.min(5, tagActivity.length));
    
    var monthLabels = [];
    var today = new Date();
    for (var i = 5; i >= 0; i--) {
        var d = new Date(today);
        d.setMonth(today.getMonth() - i);
        monthLabels.push(d.toLocaleDateString('default', { month: 'short' }));
    }
    
    var colors = [
        'rgba(75, 192, 192, 0.7)',    // Teal
        'rgba(153, 102, 255, 0.7)',   // Purple
        'rgba(255, 159, 64, 0.7)',    // Orange
        'rgba(54, 162, 235, 0.7)',     // Blue
        'rgba(255, 99, 132, 0.7)'      // Red
    ];
    
    var borderColors = [
        'rgba(75, 192, 192, 1)',    // Teal
        'rgba(153, 102, 255, 1)',   // Purple
        'rgba(255, 159, 64, 1)',    // Orange
        'rgba(54, 162, 235, 1)',     // Blue
        'rgba(255, 99, 132, 1)'      // Red
    ];
    
    var datasets = [];
    for (var i = 0; i < tagActivity.length && i < activityTagNames.length; i++) {
        datasets.push({
            label: activityTagNames[i],
            data: tagActivity[i],
            borderColor: borderColors[i % borderColors.length],
            backgroundColor: colors[i % colors.length],
            borderWidth: 2,
            tension: 0.3,  // Smooth curves
            fill: false,
            pointRadius: 3,
            pointHoverRadius: 5
        });
    }
    
    var tagActivityChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: monthLabels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Tag Activity Over Time',
                    color: '#e0e0e0',
                    font: {
                        size: 16
                    }
                },
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#e0e0e0',
                        padding: 10,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.7)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    titleFont: {
                        size: 14
                    },
                    bodyFont: {
                        size: 13
                    },
                    padding: 10,
                    displayColors: true,
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#e0e0e0'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: '#e0e0e0'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            },
            elements: {
                line: {
                    borderWidth: 2
                },
                point: {
                    radius: 3,
                    hoverRadius: 5
                }
            }
        }
    });
}

// Function to update all progress bars with smooth animations
function updateProgressBars() {
    var progressBars = document.querySelectorAll('.metric-progress-value');
    for (var i = 0; i < progressBars.length; i++) {
        var bar = progressBars[i];
        var value = parseFloat(bar.getAttribute('data-value') || bar.style.width);
        var max = parseFloat(bar.getAttribute('data-max') || 100);
        var percent = (value / max) * 100;
        percent = Math.max(percent, 3);
        bar.style.width = percent + '%';
    }
}

// Master filter function that affects all dashboard elements
function filterDashboard() {
    var tagFilter = document.getElementById('tagFilter');
    var tag = tagFilter && tagFilter.value ? tagFilter.value : 'all';
    
    var ratingFilter = document.getElementById('ratingFilter');
    var minRating = ratingFilter && ratingFilter.value ? parseFloat(ratingFilter.value) : 0;
    
    var sortFilter = document.getElementById('sortFilter');
    var sortBy = sortFilter && sortFilter.value ? sortFilter.value : 'rating-high';
    
    filterProductsTable(tag, minRating, sortBy);
    updateRatingDistributionChart(tag, minRating);
    updateTagActivityChart(tag, minRating);
    updateCategoryChart(tag, minRating);
    updateProgressBarsWithFilters(tag, minRating);
    
    document.querySelectorAll('.glass-panel').forEach(panel => {
        if (tag !== 'all' || minRating > 0) {
            panel.classList.add('filtered');
        } else {
            panel.classList.remove('filtered');
        }
    });
}

// Filter the products table in Deep Dive Analysis
function filterProductsTable(tag, minRating, sortBy) {
    var rows = document.querySelectorAll('#productsTable tbody tr');
    var visibleCount = 0;
    
    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var tagsAttr = row.getAttribute('data-tags');
        var rowTags = tagsAttr ? tagsAttr.split(',') : [];
        
        var rating = row.getAttribute('data-rating') ? 
            parseFloat(row.getAttribute('data-rating')) : 0;
        
        var reviewCount = row.getAttribute('data-reviews') ?
            parseInt(row.getAttribute('data-reviews')) : 0;
        
        var visible = true;
        
        if (tag !== 'all' && rowTags.indexOf(tag) === -1) {
            visible = false;
        }
        
        if (visible && rating < minRating) {
            visible = false;
        }
        
        row.style.display = visible ? '' : 'none';
        if (visible) visibleCount++;
    }
    
    var counter = document.getElementById('productsCounter');
    if (counter) {
        counter.textContent = visibleCount + ' products';
    }
    
    var tbody = document.querySelector('#productsTable tbody');
    if (tbody) {
        var visibleRows = Array.from(rows).filter(row => row.style.display !== 'none');
        
        visibleRows.sort(function(a, b) {
            if (sortBy === 'rating-high') {
                var ratingA = parseFloat(a.getAttribute('data-rating') || '0');
                var ratingB = parseFloat(b.getAttribute('data-rating') || '0');
                return ratingB - ratingA; 
            } 
            else if (sortBy === 'rating-low') {
                var ratingA = parseFloat(a.getAttribute('data-rating') || '0');
                var ratingB = parseFloat(b.getAttribute('data-rating') || '0');
                return ratingA - ratingB; 
            }
            else if (sortBy === 'count-high') {
                var countA = parseInt(a.getAttribute('data-reviews') || '0');
                var countB = parseInt(b.getAttribute('data-reviews') || '0');
                return countB - countA; 
            }
            else if (sortBy === 'count-low') {
                var countA = parseInt(a.getAttribute('data-reviews') || '0');
                var countB = parseInt(b.getAttribute('data-reviews') || '0');
                return countA - countB; 
            }
            return 0;
        });
        
        visibleRows.forEach(row => tbody.appendChild(row));
    }
}

// Update Rating Distribution Chart based on filters
var originalRatingDistribution;

function updateRatingDistributionChart(tag, minRating) {
    var chart = Chart.getChart('ratingDistributionChart');
    if (!chart) return;
    
    if (!originalRatingDistribution) {
        originalRatingDistribution = [...chart.data.datasets[0].data];
    }
    
    if (tag === 'all' && minRating === 0) {
        chart.data.datasets[0].data = [...originalRatingDistribution];
        chart.update();
        return;
    }
    
    var filteredData = originalRatingDistribution.map(function(value, index) {
        if (index + 1 < minRating) {
            return 0;
        }
        return tag !== 'all' ? Math.floor(value * 0.7) : value;
    });
    
    chart.data.datasets[0].data = filteredData;
    chart.update();
}

// Update Tag Activity Chart based on filters
function updateTagActivityChart(tag, minRating) {
    var chart = Chart.getChart('tagActivityChart');
    if (!chart) return;
    
    if (tag !== 'all') {
        var tagIndex = activityTagNames.indexOf(tag);
        if (tagIndex !== -1) {
            chart.data.datasets.forEach(function(dataset, i) {
                dataset.hidden = (dataset.label !== tag);
            });
        }
    } else {
        chart.data.datasets.forEach(function(dataset) {
            dataset.hidden = false;
        });
    }
    
    chart.update();
}

// Update Category Chart based on filters
function updateCategoryChart(tag, minRating) {
    var chart = Chart.getChart('topRatedProductsChart');
    if (!chart) return;
    
    if (tag === 'all' && minRating === 0) {
        fetch('/api/category-chart-data')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    chart.data.labels = data.category_names;
                    chart.data.datasets[0].data = data.category_ratings;
                    chart.data.datasets[1].data = data.product_counts;
                    chart.update();
                }
            })
            .catch(error => {
                console.error('Error fetching category data:', error);
            });
        return;
    }
    
    chart.data.datasets[0].data = chart.data.datasets[0].data.map(function(value) {
        return Math.max(value - (minRating / 5), 0);
    });
    
    chart.data.datasets[1].data = chart.data.datasets[1].data.map(function(value) {
        return Math.floor(value * (1 - (minRating / 10) * 0.2));
    });
    
    chart.update();
}

// Update progress bars with filtered data
function updateProgressBarsWithFilters(tag, minRating) {
    if (tag !== 'all' || minRating > 0) {
        var reduction = minRating > 0 ? (minRating / 10) : 0;
        reduction += (tag !== 'all' ? 0.1 : 0);
        
        document.querySelectorAll('.progress-bar').forEach(function(bar) {
            var originalValue = parseFloat(bar.getAttribute('data-original') || bar.style.width);
            if (!bar.getAttribute('data-original')) {
                bar.setAttribute('data-original', bar.style.width);
            }
            
            var newWidth = Math.max(originalValue * (1 - reduction), 0) + '%';
            
            bar.style.width = newWidth;
        });
    } else {
        document.querySelectorAll('.progress-bar').forEach(function(bar) {
            var originalValue = bar.getAttribute('data-original');
            if (originalValue) {
                bar.style.width = originalValue;
            }
        });
    }
}

// Function to handle filter form reset
function resetFilters() {
    document.getElementById('tagFilter').value = 'all';
    document.getElementById('ratingFilter').value = '0';
    document.getElementById('sortFilter').value = 'rating-high';
    
    document.querySelectorAll('.glass-panel').forEach(panel => {
        panel.classList.remove('filtered');
    });
    
    initializeCharts();
    
    var counter = document.getElementById('productsCounter');
    if (counter) {
        var totalRows = document.querySelectorAll('#productsTable tbody tr').length;
        counter.textContent = totalRows + ' products';
    }
}

// Master initialization function for all charts
function initializeCharts() {
    initCategoryChart();
    initRatingDistributionChart();
    initTagActivityChart();
    
    updateProgressBars();
}

// Filter by tag
function filterByTag(tagName) {
    var tagFilter = document.getElementById('tagFilter');
    
    if (tagFilter) {
        if (!tagName) {
            tagName = 'all';
        }
        tagFilter.value = tagName;
        filterDashboard();
    }
}

</script>

{% endblock head %}

{% block content %}
<!-- Video Background -->
<div class="video-background">
    <video data-src="/static/videos/statistical-graph-with-business-finance-concept-3d-rendering-video (2).mp4" muted loop playsinline autoplay preload="auto"></video>
</div>

<!-- Fixed Header Navigation -->
<header class="dashboard-header">
    <div class="header-container">
        <div class="header-left">
            <h1 class="dashboard-title">
                <i class="fas fa-chart-bar me-2"></i>
                Analytical
            </h1>
        </div>
        <div class="header-center">
            <nav class="header-nav">
                <a href="/" class="nav-link">
                    <i class="fas fa-home me-1"></i>
                    Home
                </a>
                <a href="/dashboard/strategic" class="nav-link">
                    <i class="fas fa-chess me-1"></i>
                    Strategic
                </a>
                <a href="/dashboard/tactical" class="nav-link">
                    <i class="fas fa-tasks me-1"></i>
                    Tactical
                </a>
                <a href="/dashboard/analytical" class="nav-link active">
                    <i class="fas fa-chart-bar me-1"></i>
                    Analytical
                </a>
            </nav>
        </div>
        <div class="header-right d-none d-md-flex">
            <div class="filter-controls">
                <select id="headerTagFilter" class="form-select form-select-sm me-2">
                    <option value="all">All Tags</option>
                    {% for tag in tags %}
                    <option value="{{ tag.TagName }}">{{ tag.TagName }}</option>
                    {% endfor %}
                </select>
                <select id="headerRatingFilter" class="form-select form-select-sm me-2">
                    <option value="0">All Ratings</option>
                    <option value="1">1+ Stars</option>
                    <option value="2">2+ Stars</option>
                    <option value="3">3+ Stars</option>
                    <option value="4">4+ Stars</option>
                    <option value="4.5">4.5+ Stars</option>
                </select>
                <select id="headerSortFilter" class="form-select form-select-sm me-2">
                    <option value="rating-high">Rating </option>
                    <option value="rating-low">Rating </option>
                    <option value="count-high">Count </option>
                    <option value="count-low">Count </option>
                </select>
                <button onclick="applyFilters()" class="btn btn-primary btn-sm me-1">Apply</button>
                <button onclick="resetFilters()" class="btn btn-outline-light btn-sm">Reset</button>
            </div>
        </div>
        <div class="header-right d-md-none">
            <button id="toggleFilters" class="btn btn-outline-light btn-sm">
                <i class="fas fa-filter"></i> Filters
            </button>
        </div>
    </div>
</header>

<!-- Mobile Filters Panel -->
<div id="mobileFiltersPanel" class="mobile-filters-panel" style="display: none;">
    <div class="mobile-filters-content">
        <div class="row g-2">
            <div class="col-3">
                <select id="mobileTagFilter" class="form-select form-select-sm">
                    <option value="all">All Tags</option>
                    {% for tag in tags %}
                    <option value="{{ tag.TagName }}">{{ tag.TagName }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-3">
                <select id="mobileRatingFilter" class="form-select form-select-sm">
                    <option value="0">All Ratings</option>
                    <option value="1">1+ Stars</option>
                    <option value="2">2+ Stars</option>
                    <option value="3">3+ Stars</option>
                    <option value="4">4+ Stars</option>
                    <option value="4.5">4.5+ Stars</option>
                </select>
            </div>
            <div class="col-3">
                <select id="mobileSortFilter" class="form-select form-select-sm">
                    <option value="rating-high">Rating </option>
                    <option value="rating-low">Rating </option>
                    <option value="count-high">Count </option>
                    <option value="count-low">Count </option>
                </select>
            </div>
            <div class="col-3">
                <button onclick="applyFilters()" class="btn btn-primary btn-sm w-100">Apply</button>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Container -->
<div id="mainContent" class="main-content">

<!-- Top metrics cards - vertically-oriented rectangles with horizontal scrolling -->
<div class="d-flex overflow-auto mb-4" style="padding: 10px 0; gap: 15px; position: relative; z-index: 1; border-radius: 8px;">
    <!-- Metric Card 1: Total Products -->
    <div style="background: rgba(30, 41, 59, 0.75); backdrop-filter: blur(10px); border: 1px solid rgba(33, 150, 243, 0.3); border-radius: 16px; padding: 20px 15px; width: 170px; min-height: 220px; display: flex; flex-direction: column; align-items: center; text-align: center; box-shadow: 0 8px 32px rgba(33, 150, 243, 0.2);">
        <div style="position: relative; width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; border-radius: 50%; margin: 0 auto 15px; font-size: 24px; color: #2196F3;">
            <i class="fas fa-box"></i>
        </div>
        <div style="font-size: 1.5rem; font-weight: 700; margin: 5px 0; color: #fff;">{{ total_products }}</div>
        <p style="font-size: 1rem; font-weight: 500; color: rgba(255, 255, 255, 0.7); margin: 0 0 15px;">Total Products</p>
        <div style="width: 100%; margin-top: auto;">
            <div style="width: 100%; background: rgba(255, 255, 255, 0.1); height: 6px; border-radius: 3px; overflow: hidden;">
                <div class="metric-progress-value" data-value="{{ total_products }}" data-max="15000" style="background: linear-gradient(90deg, #2196F3, #03A9F4); height: 6px; width: 0;"></div>
            </div>
        </div>
    </div>
    
    <!-- Metric Card 2: Average Rating -->
    <div style="background: rgba(30, 41, 59, 0.75); backdrop-filter: blur(10px); border: 1px solid rgba(255, 152, 0, 0.3); border-radius: 16px; padding: 20px 15px; width: 170px; min-height: 220px; display: flex; flex-direction: column; align-items: center; text-align: center; box-shadow: 0 8px 32px rgba(255, 152, 0, 0.2);">
        <div style="position: relative; width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; border-radius: 50%; margin: 0 auto 15px; font-size: 24px; color: #FF9800;">
            <i class="fas fa-star"></i>
        </div>
        <div style="font-size: 1.5rem; font-weight: 700; margin: 5px 0; color: #fff;">{{ "%.1f"|format(avg_rating|float) }}</div>
        <p style="font-size: 1rem; font-weight: 500; color: rgba(255, 255, 255, 0.7); margin: 0 0 15px;">Average Rating</p>
        <div style="width: 100%; margin-top: auto;">
            <div style="width: 100%; background: rgba(255, 255, 255, 0.1); height: 6px; border-radius: 3px; overflow: hidden;">
                <div class="metric-progress-value" data-value="{{ avg_rating }}" data-max="5" style="background: linear-gradient(90deg, #FF9800, #FF5722); height: 6px; width: 0;"></div>
            </div>
        </div>
    </div>
    
    <!-- Metric Card 3: Total Tags -->
    <div style="background: rgba(30, 41, 59, 0.75); backdrop-filter: blur(10px); border: 1px solid rgba(156, 39, 176, 0.3); border-radius: 16px; padding: 20px 15px; width: 170px; min-height: 220px; display: flex; flex-direction: column; align-items: center; text-align: center; box-shadow: 0 8px 32px rgba(156, 39, 176, 0.2);">
        <div style="position: relative; width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; border-radius: 50%; margin: 0 auto 15px; font-size: 24px; color: #9C27B0;">
            <i class="fas fa-tags"></i>
        </div>
        <div style="font-size: 1.5rem; font-weight: 700; margin: 5px 0; color: #fff;">{{ total_tags }}</div>
        <p style="font-size: 1rem; font-weight: 500; color: rgba(255, 255, 255, 0.7); margin: 0 0 15px;">Product Tags</p>
        <div style="width: 100%; margin-top: auto;">
            <div style="width: 100%; background: rgba(255, 255, 255, 0.1); height: 6px; border-radius: 3px; overflow: hidden;">
                <div class="metric-progress-value" data-value="{{ total_tags }}" data-max="20000" style="background: linear-gradient(90deg, #9C27B0, #673AB7); height: 6px; width: 0;"></div>
            </div>
        </div>
    </div>
    
    <!-- Metric Card 4: Lowest Rated Tag -->
    <div style="background: rgba(30, 41, 59, 0.75); backdrop-filter: blur(10px); border: 1px solid rgba(0, 150, 136, 0.3); border-radius: 16px; padding: 20px 15px; width: 170px; min-height: 220px; display: flex; flex-direction: column; align-items: center; text-align: center; box-shadow: 0 8px 32px rgba(0, 150, 136, 0.2);">
        <div style="position: relative; width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; border-radius: 50%; margin: 0 auto 15px; font-size: 24px; color: #009688;">
            <i class="fas fa-chart-line"></i>
        </div>
        <div style="font-size: 1.5rem; font-weight: 700; margin: 5px 0; color: #fff;">{{ lowest_rated_tag.AvgRating|float|round(1) }}</div>
        <p style="font-size: 1rem; font-weight: 500; color: rgba(255, 255, 255, 0.7); margin: 0 0 15px;">Lowest: {{ lowest_rated_tag.TagName }}</p>
        <div style="width: 100%; margin-top: auto;">
            <div style="width: 100%; background: rgba(255, 255, 255, 0.1); height: 6px; border-radius: 3px; overflow: hidden;">
                <div class="metric-progress-value" data-value="{{ lowest_rated_tag.AvgRating }}" data-max="5" style="background: linear-gradient(90deg, #009688, #4DB6AC); height: 6px; width: 0;"></div>
            </div>
        </div>
    </div>
    
    <!-- Metric Card 5: Most Tagged Product -->
    <div style="background: rgba(30, 41, 59, 0.75); backdrop-filter: blur(10px); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 16px; padding: 20px 15px; width: 170px; min-height: 220px; display: flex; flex-direction: column; align-items: center; text-align: center; box-shadow: 0 8px 32px rgba(76, 175, 80, 0.2);">
        <div style="position: relative; width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; border-radius: 50%; margin: 0 auto 15px; font-size: 24px; color: #4CAF50;">
            <i class="fas fa-thumbs-up"></i>
        </div>
        <div style="font-size: 1.5rem; font-weight: 700; margin: 5px 0; color: #fff;">{{ most_tags_count }}</div>
        <p style="font-size: 1rem; font-weight: 500; color: rgba(255, 255, 255, 0.7); margin: 0 0 15px;">Most Tagged</p>
        <div style="width: 100%; margin-top: auto;">
            <div style="width: 100%; background: rgba(255, 255, 255, 0.1); height: 6px; border-radius: 3px; overflow: hidden;">
                <div class="metric-progress-value" data-value="{{ most_tags_count }}" data-max="10" style="background: linear-gradient(90deg, #4CAF50, #8BC34A); height: 6px; width: 0;"></div>
            </div>
        </div>
    </div>
    
    <!-- Metric Card 6: Top Tag (replacing Recommendation Strength) -->
    <div style="background: rgba(30, 41, 59, 0.75); backdrop-filter: blur(10px); border: 1px solid rgba(244, 67, 54, 0.3); border-radius: 16px; padding: 20px 15px; width: 170px; min-height: 220px; display: flex; flex-direction: column; align-items: center; text-align: center; box-shadow: 0 8px 32px rgba(244, 67, 54, 0.2);">
        <div style="position: relative; width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; border-radius: 50%; margin: 0 auto 15px; font-size: 24px; color: #F44336;">
            <i class="fas fa-tag"></i>
        </div>
        <div style="font-size: 1.5rem; font-weight: 700; margin: 5px 0; color: #fff;">{{ popular_tags[0]['TagName'] if popular_tags else 'N/A' }}</div>
        <p style="font-size: 1rem; font-weight: 500; color: rgba(255, 255, 255, 0.7); margin: 0 0 15px;">Most Popular Tag</p>
        <div style="width: 100%; margin-top: auto;">
            <div style="width: 100%; background: rgba(255, 255, 255, 0.1); height: 6px; border-radius: 3px; overflow: hidden;">
                <div class="metric-progress-value" data-value="{{ popular_tags[0]['TagUsage'] if popular_tags else 0 }}" data-max="{{ (popular_tags[0]['TagUsage'] * 1.2)|round|int if popular_tags else 100 }}" style="background: linear-gradient(90deg, #F44336, #E91E63); height: 6px; width: 0;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Tag Cloud and Rating Distribution Row -->
<div class="row mb-4" style="position: relative; z-index: 1;">
    <!-- Section 2: Tag Cloud -->
    <div class="col-lg-6 mb-2">
        <div class="glass-panel h-100 pt-2 pb-2">
            <h2 class="text-white mb-1">Tag Cloud</h2>
            <p class="text-white-50 mb-1 small">Popular tags sized by frequency. Click on a tag to filter.</p>
            
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title"><i class="fas fa-tags me-2"></i>Product Tags</h5>
                </div>
                <div class="card-body">
                    <div class="tag-cloud" id="tagCloud" style="height: 300px; overflow-y: auto;">
                        {% for tag in popular_tags[:30] %}
                        <span class="tag-size-{{ tag.size }}" data-tag="{{ tag.TagName }}" onclick="filterByTag('{{ tag.TagName }}')">
                            <i class="fas fa-tag me-1"></i>{{ tag.TagName }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 3: Rating Analysis -->
    <div class="col-lg-6 mb-2">
        <div class="glass-panel h-100 pt-2 pb-2">
            <h2 class="text-white mb-1">Rating Distribution</h2>
            <p class="text-white-50 mb-1 small">Analysis of product rating distribution.</p>
            
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title"><i class="fas fa-chart-bar me-2"></i>Rating Distribution</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 240px; width: 100%; max-width: 100%;">
                        <canvas id="ratingDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section - Row with Two Charts -->
<div class="row" style="width: 100%; margin-right: 0; margin-left: 0;">
    <!-- Top Rated Products by Category -->
    <div class="col-lg-6 mb-4">
        <div class="glass-panel h-100">
            <h2 class="text-white mb-3">Top Products by Category</h2>
            <p class="text-white-50 mb-3">Analysis of highest rated products across categories.</p>
            
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title"><i class="fas fa-trophy me-2"></i>Products by Category</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 300px; width: 100%; max-width: 100%;">
                        <canvas id="topRatedProductsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tag Usage Trends -->
    <div class="col-lg-6 mb-4">
        <div class="glass-panel h-100">
            <h2 class="text-white mb-3">Tag Usage Trends</h2>
            <p class="text-white-50 mb-3">Analysis of tag usage trends over time.</p>
            
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title"><i class="fas fa-chart-line me-2"></i>Tag Usage Trends</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 300px; width: 100%; max-width: 100%;">
                        <canvas id="tagActivityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Section: Category Analysis removed - was duplicate of Top Rated Products by Category -->

<!-- Deep Dive Analysis -->
<div class="row mb-4" style="position: relative; z-index: 1;">
    <div class="col-12 mb-2">
        <div class="glass-panel pt-2 pb-2">
            <h2 class="text-white mb-1">Deep Dive Analysis</h2>
            <p class="text-white-50 mb-2 small">Detailed product rating analysis and top performers.</p>
            
            <div class="card mb-2">
                <div class="card-header py-1">
                    <h5 class="card-title mb-0"><i class="fas fa-trophy me-2"></i>Top Rated Products</h5>
                </div>
                <div class="card-body">
            <div class="table-responsive">
                <table class="table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Rating</th>
                    <th>Tags</th>
                    <th>Review Count</th>
                </tr>
            </thead>
            <tbody>
                {% for product in top_products %}
                <tr>
                    <td>{{ product.ProductName }}</td>
                    <td>
                        {% set rating = product.Rating|float %}
                        {% set full_stars = (rating|int) %}
                        {% set half_star = rating - full_stars >= 0.5 %}
                        {% set empty_stars = 5 - full_stars - (1 if half_star else 0) %}
                        
                        {% for i in range(full_stars) %}
                        <i class="fas fa-star text-warning"></i>
                        {% endfor %}
                        
                        {% if half_star %}
                        <i class="fas fa-star-half-alt text-warning"></i>
                        {% endif %}
                        
                        {% for i in range(empty_stars) %}
                        <i class="far fa-star text-muted"></i>
                        {% endfor %}
                        
                        {{ rating }}
                    </td>
                    <td>
                        {% for tag in product.Tags.split(',') %}
                        <span class="badge bg-info">{{ tag }}</span>
                        {% endfor %}
                    </td>
                    <td>{{ product.ReviewCount }}</td>
                </tr>
                {% endfor %}
                </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

</div> <!-- End of main-content container -->

<script>
// Toggle sidebar width function
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const toggleBtn = document.getElementById('toggleSidebar');
    
    if (sidebar.style.width === '250px') {
        // Collapse sidebar
        sidebar.style.width = '80px';
        mainContent.style.marginLeft = '100px';
        mainContent.style.width = 'calc(100% - 120px)';
        toggleBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
        
        // Hide text in sidebar
        document.querySelectorAll('#sidebar span, #sidebar .sidebar-filters, #sidebar label, #sidebar select, #sidebar button:not(#toggleSidebar)').forEach(el => {
            el.style.display = 'none';
        });
        
        // Center icons
        document.querySelectorAll('#sidebar .nav-link').forEach(link => {
            link.classList.add('text-center');
            link.style.paddingLeft = '0';
            link.style.paddingRight = '0';
        });
    } else {
        // Expand sidebar
        sidebar.style.width = '250px';
        mainContent.style.marginLeft = '270px';
        mainContent.style.width = 'calc(100% - 290px)';
        toggleBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
        
        // Show text in sidebar
        document.querySelectorAll('#sidebar span, #sidebar .sidebar-filters, #sidebar label, #sidebar select, #sidebar button:not(#toggleSidebar)').forEach(el => {
            el.style.display = '';
        });
        
        // Restore link alignment
        document.querySelectorAll('#sidebar .nav-link').forEach(link => {
            link.classList.remove('text-center');
            link.style.paddingLeft = '';
            link.style.paddingRight = '';
        });
    }
}

// Function to apply sidebar filters
function applySidebarFilters() {
    // Sync sidebar filters with top filters
    document.getElementById('tagFilter').value = document.getElementById('sideTagFilter').value;
    document.getElementById('ratingFilter').value = document.getElementById('sideRatingFilter').value;
    document.getElementById('sortFilter').value = document.getElementById('sideSortFilter').value;
    
    // Apply filters
    filterDashboard();
}

// Function to sync top filters with sidebar filters
function syncFiltersToSidebar() {
    document.getElementById('sideTagFilter').value = document.getElementById('tagFilter').value;
    document.getElementById('sideRatingFilter').value = document.getElementById('ratingFilter').value;
    document.getElementById('sideSortFilter').value = document.getElementById('sortFilter').value;
}

// Add syncFiltersToSidebar to the existing resetFilters and filterDashboard functions
const originalResetFilters = resetFilters;
resetFilters = function() {
    originalResetFilters();
    syncFiltersToSidebar();
};

const originalFilterDashboard = filterDashboard;
filterDashboard = function() {
    originalFilterDashboard();
    syncFiltersToSidebar();
};

// Initialize progress bars immediately with forced inline styles for maximum compatibility
document.addEventListener('DOMContentLoaded', function() {
    // Force CSS to be applied to Font Awesome icons
    document.querySelectorAll('.fas').forEach(function(icon) {
        icon.style.display = 'inline-block';
        icon.style.fontSize = '24px';
    });
    
    // Set up mobile filter toggle
    const toggleFiltersBtn = document.getElementById('toggleFilters');
    if (toggleFiltersBtn) {
        toggleFiltersBtn.addEventListener('click', toggleMobileFilters);
    }
    
    // Set initial widths for progress bars
    var progressBars = document.querySelectorAll('.metric-progress-value');
    console.log('Found ' + progressBars.length + ' progress bars to update');
    
    // First make sure all bars exist and are visible
    progressBars.forEach(function(bar) {
        // Ensure basic styling is applied
        bar.style.height = '6px';
        bar.style.borderRadius = '3px';
        bar.style.transition = 'width 1s ease-in-out';
    });
    
    // Then apply the width with a delay to allow transition animation
    setTimeout(function() {
        progressBars.forEach(function(bar) {
            var value = parseFloat(bar.getAttribute('data-value') || bar.style.width);
            var max = parseFloat(bar.getAttribute('data-max') || 100);
            var percent = (value / max) * 100;
            
            // Ensure at least a small visible portion
            percent = Math.max(percent, 5);
            // Cap at 100%
            percent = Math.min(percent, 100);
            
            console.log('Setting bar width to: ' + percent + '%', bar);
            bar.style.width = percent + '%';
        });
    }, 300);
});
</script>

<script>
// Mobile filter toggle functionality
function toggleMobileFilters() {
    const mobilePanel = document.getElementById('mobileFiltersPanel');
    if (mobilePanel) {
        if (mobilePanel.style.display === 'none' || !mobilePanel.style.display) {
            mobilePanel.style.display = 'block';
        } else {
            mobilePanel.style.display = 'none';
        }
    }
}

// Filter functions
function applyFilters() {
    // Get filter values from header (desktop) or mobile panel
    const tagFilter = document.getElementById('headerTagFilter') ? 
        document.getElementById('headerTagFilter').value : 
        document.getElementById('mobileTagFilter').value;
    const ratingFilter = document.getElementById('headerRatingFilter') ? 
        parseFloat(document.getElementById('headerRatingFilter').value) : 
        parseFloat(document.getElementById('mobileRatingFilter').value);
    const sortFilter = document.getElementById('headerSortFilter') ? 
        document.getElementById('headerSortFilter').value : 
        document.getElementById('mobileSortFilter').value;
    
    // Sync filter values between desktop and mobile
    syncFilterValues(tagFilter, ratingFilter, sortFilter);
    
    // Apply filters to charts and tables
    filterCharts(tagFilter, ratingFilter, sortFilter);
    filterTable(tagFilter, ratingFilter, sortFilter);
    
    // Hide mobile filters panel after applying
    const mobilePanel = document.getElementById('mobileFiltersPanel');
    if (mobilePanel && mobilePanel.style.display !== 'none') {
        mobilePanel.style.display = 'none';
    }
}

function syncFilterValues(tag, rating, sort) {
    // Sync header filters
    if (document.getElementById('headerTagFilter')) {
        document.getElementById('headerTagFilter').value = tag;
    }
    if (document.getElementById('headerRatingFilter')) {
        document.getElementById('headerRatingFilter').value = rating;
    }
    if (document.getElementById('headerSortFilter')) {
        document.getElementById('headerSortFilter').value = sort;
    }
    
    // Sync mobile filters
    if (document.getElementById('mobileTagFilter')) {
        document.getElementById('mobileTagFilter').value = tag;
    }
    if (document.getElementById('mobileRatingFilter')) {
        document.getElementById('mobileRatingFilter').value = rating;
    }
    if (document.getElementById('mobileSortFilter')) {
        document.getElementById('mobileSortFilter').value = sort;
    }
}

function resetFilters() {
    // Reset all filter selects to default values
    const filterSelects = [
        'headerTagFilter', 'headerRatingFilter', 'headerSortFilter',
        'mobileTagFilter', 'mobileRatingFilter', 'mobileSortFilter'
    ];
    
    filterSelects.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            if (id.includes('Tag')) {
                element.value = 'all';
            } else if (id.includes('Rating')) {
                element.value = '0';
            } else if (id.includes('Sort')) {
                element.value = 'rating-high';
            }
        }
    });
    
    // Apply the reset filters
    applyFilters();
}

// Filter implementation functions
function filterCharts(tagFilter, ratingFilter, sortFilter) {
    // This function would contain the logic to filter chart data
    console.log('Applying filters:', { tagFilter, ratingFilter, sortFilter });
    
    // You can add specific chart filtering logic here
    // For example, updating chart data based on filters
}

function filterTable(tagFilter, ratingFilter, sortFilter) {
    // This function would contain the logic to filter table data
    console.log('Filtering table with:', { tagFilter, ratingFilter, sortFilter });
    
    // You can add specific table filtering logic here
    // For example, showing/hiding table rows based on filters
}
</script>

{% endblock content %}
