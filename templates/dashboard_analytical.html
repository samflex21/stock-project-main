{% extends "base.html" %}

{% block title %}Analytical Dashboard{% endblock %}

{% block body_attributes %}class="analytical-page"{% endblock %}
{% block html_attributes %}class="analytical-page"{% endblock %}

{% block head %}
<!-- Chart.js for data visualization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Modern design styling for Analytical Dashboard -->
<style>
    /* Global styles for analytical dashboard */
    html.analytical-page, body.analytical-page {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow-x: hidden;
        font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: transparent;
        color: #ffffff;
        scroll-behavior: smooth;
    }

    /* Video background for analytical dashboard */
    .video-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        overflow: hidden;
    }
    
    /* Modern dashboard title */
    .dashboard-title {
        font-weight: 600;
        font-size: 2.2rem;
        letter-spacing: 0.5px;
        margin-bottom: 1.5rem;
        background: linear-gradient(90deg, #ffffff, #e0e0e0);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .dashboard-subtitle {
        font-weight: 400;
        opacity: 0.8;
    }
    
    /* Modern form controls */
    .modern-select {
        background: rgba(30, 41, 59, 0.8);
        color: white;
        border: 1px solid rgba(78, 152, 227, 0.3);
        border-radius: 8px;
        padding: 10px 15px;
        transition: all 0.3s ease;
    }
    
    .modern-select:focus {
        box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.3);
        border-color: rgba(79, 172, 254, 0.5);
        outline: none;
    }
    
    .modern-btn {
        background: linear-gradient(135deg, #4facfe, #00f2fe);
        border: none;
        box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .modern-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(79, 172, 254, 0.6);
    }
    
    .modern-btn-secondary {
        background: rgba(30, 41, 59, 0.6);
        border: 1px solid rgba(78, 152, 227, 0.3);
        box-shadow: 0 4px 15px rgba(30, 41, 59, 0.3);
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 500;
        transition: all 0.3s ease;
        color: white;
    }
    
    .modern-btn-secondary:hover {
        background: rgba(30, 41, 59, 0.8);
        transform: translateY(-2px);
    }

    .video-background video {
        position: absolute;
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        object-fit: cover;
        opacity: 0.9;
    }

    /* Modern glass panels with blur effect - Now with gradient borders */
    .glass-panel {
        background: rgba(30, 41, 59, 0.65) !important;
        backdrop-filter: blur(12px) !important;
        -webkit-backdrop-filter: blur(12px) !important;
        border-radius: 20px !important;
        border: 1px solid rgba(78, 152, 227, 0.3) !important;
        box-shadow: 0 8px 32px 0 rgba(15, 23, 42, 0.5) !important;
        padding: 20px;
        margin-bottom: 24px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .glass-panel::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        z-index: 1;
    }

    .glass-panel:hover {
        box-shadow: 0 12px 40px 0 rgba(16, 24, 40, 0.6) !important;
        transform: translateY(-5px);
    }

    /* Card styling with glassmorphism - updated with modern gradients */
    .card {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-radius: 15px;
        border: 1px solid rgba(78, 152, 227, 0.2);
        box-shadow: 0 8px 24px 0 rgba(15, 23, 42, 0.3);
        overflow: hidden;
        transition: all 0.3s ease;
        height: 100%;
        margin-bottom: 20px;
        position: relative;
    }
    
    .card::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px 0 rgba(15, 23, 42, 0.4);
    }
    
    .card:hover::after {
        opacity: 1;
    }

    .card-header {
        background: rgba(30, 41, 59, 0.8);
        border-bottom: 1px solid rgba(78, 152, 227, 0.2);
        padding: 15px 20px;
    }

    .card-title {
        margin-bottom: 0;
        color: #fff;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .card-body {
        padding: 20px;
    }

    /* Chart container styling with glassmorphism */
    .chart-container {
        position: relative;
        height: 350px;
        margin-bottom: 0;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.08);
        padding: 10px;
    }
    
    /* Metric cards styles - modern vertical design */
    .metric-card {
        padding: 1.25rem;
        border-radius: 16px;
        position: relative;
        overflow: hidden;
        width: 170px;
        min-height: 220px;
        margin-right: 15px;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        background: rgba(30, 41, 59, 0.75);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(78, 152, 227, 0.2);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    /* Modern tag cloud styling */
    .tag-cloud {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        padding: 15px;
    }
    
    .tag-cloud span {
        padding: 8px 18px;
        border-radius: 20px;
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(78, 152, 227, 0.2);
        cursor: pointer;
        transition: all 0.3s ease;
        color: white;
        display: inline-block;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    
    .tag-cloud span:hover {
        background: rgba(79, 172, 254, 0.2);
        border-color: rgba(79, 172, 254, 0.4);
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(79, 172, 254, 0.2);
    }
    
    /* Tag size variants with gradient backgrounds */
    .tag-size-1 { 
        font-size: 0.8rem; 
    }
    .tag-size-1 {
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.7), rgba(30, 41, 59, 0.6));
    }
    
    .tag-size-2 { 
        font-size: 0.9rem; 
    }
    .tag-size-2 {
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.75), rgba(44, 82, 130, 0.5));
    }
    
    .tag-size-3 { 
        font-size: 1rem; 
    }
    .tag-size-3 {
        background: linear-gradient(135deg, rgba(44, 82, 130, 0.6), rgba(78, 152, 227, 0.4));
    }
    
    .tag-size-4 { 
        font-size: 1.1rem; 
    }
    .tag-size-4 {
        background: linear-gradient(135deg, rgba(78, 152, 227, 0.5), rgba(79, 172, 254, 0.4));
    }
    
    .tag-size-5 { 
        font-size: 1.2rem; 
    }
    .tag-size-5 {
        background: linear-gradient(135deg, rgba(79, 172, 254, 0.6), rgba(0, 242, 254, 0.4));
    }
    /* Tag size classes with modern sizing */
    .tag-size-1 { font-size: 0.9rem; opacity: 0.8; }
    .tag-size-2 { font-size: 1.1rem; opacity: 0.85; }
    .tag-size-3 { font-size: 1.3rem; opacity: 0.9; }
    .tag-size-4 { font-size: 1.5rem; opacity: 0.95; }
    .tag-size-5 { font-size: 1.7rem; opacity: 1; }
    
    /* Modern rating progress bar */
    .rating-progress {
        height: 10px;
        width: 100%;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.2);
        overflow: hidden;
    }
    
    .rating-bar {
        border-radius: 10px;
        background: linear-gradient(to right, #4facfe, #00f2fe) !important;
        transition: width 1s ease-in-out;
    }

    /* Modern section header styling */
    .section-header {
        background: linear-gradient(135deg, rgba(16, 57, 144, 0.2), rgba(24, 119, 242, 0.2));
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-left: 4px solid #4facfe;
        padding: 20px;
        margin-bottom: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(31, 38, 135, 0.2);
        transition: all 0.3s ease;
    }
    
    .section-header h2 {
        margin-bottom: 8px;
        color: #ffffff;
        font-weight: 700;
        letter-spacing: 1px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .section-header p {
        margin-bottom: 0;
        color: rgba(255, 255, 255, 0.85);
        font-weight: 300;
        letter-spacing: 0.5px;
    }
    
    /* Table styling */
    .table {
        color: #fff;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        overflow: hidden;
    }
    
    .table thead th {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.1);
        color: #fff;
        font-weight: 600;
        letter-spacing: 0.5px;
        padding: 15px;
    }
    
    .table td {
        border-color: rgba(255, 255, 255, 0.1);
        padding: 12px 15px;
        vertical-align: middle;
    }
    
    .table tbody tr:hover {
        background: rgba(255, 255, 255, 0.1);
    }
    
    /* Badge styling */
    .badge {
        padding: 6px 10px;
        border-radius: 30px;
        font-weight: 500;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .badge.bg-info {
        background: linear-gradient(135deg, #0093E9, #80D0C7) !important;
    }
    
    /* Star rating styling */
    .fa-star.text-warning {
        color: #FFD700 !important;
        filter: drop-shadow(0 0 2px rgba(255, 215, 0, 0.5));
    }
    
    .fa-star-half-alt.text-warning {
        color: #FFD700 !important;
        filter: drop-shadow(0 0 2px rgba(255, 215, 0, 0.5));
    }
    
    .fa-star.text-muted {
        color: rgba(255, 255, 255, 0.3) !important;
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    
    ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
    }
    
    /* Metrics card styling - vertical design as per user preference */
    .metric-card {
        width: 170px;
        min-height: 220px;
        padding: 1.25rem;
        margin-right: 15px;
        border-radius: 16px;
        background: rgba(30, 41, 59, 0.75);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
    }
    
    .metric-icon {
        position: relative;
        width: 60px;
        height: 60px;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 50%;
        margin: 0 auto 15px;
        font-size: 26px;
        /* Ensure top-center positioning */
        top: 0;
        left: 50%;
        transform: translateX(-50%);
    }
    
    .blue-glow .metric-icon {
        background: rgba(79, 172, 254, 0.2);
        box-shadow: 0 0 15px rgba(79, 172, 254, 0.5);
        color: #4facfe;
    }
    
    .green-glow .metric-icon {
        background: rgba(0, 230, 118, 0.2);
        box-shadow: 0 0 15px rgba(0, 230, 118, 0.5);
        color: #00e676;
    }
    
    .purple-glow .metric-icon {
        background: rgba(153, 102, 255, 0.2);
        box-shadow: 0 0 15px rgba(153, 102, 255, 0.5);
        color: #9966ff;
    }
    
    .orange-glow .metric-icon {
        background: rgba(255, 153, 0, 0.2);
        box-shadow: 0 0 15px rgba(255, 153, 0, 0.5);
        color: #ff9900;
    }
    
    .teal-glow .metric-icon {
        background: rgba(20, 184, 166, 0.2);
        box-shadow: 0 0 15px rgba(20, 184, 166, 0.5);
        color: #14b8a6;
    }
    
    .red-glow .metric-icon {
        background: rgba(244, 67, 54, 0.2);
        box-shadow: 0 0 15px rgba(244, 67, 54, 0.5);
        color: #f44336;
    }
    
    .metric-value {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 10px 0;
        background: linear-gradient(90deg, #ffffff 0%, #e0e0e0 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .metric-label {
        font-size: 1rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 15px;
        line-height: 1.2;
        /* Ensure label doesn't overflow in narrow cards */
        max-width: 95%;
    }
    
    .metric-footer {
        margin-top: auto;
        width: 100%;
    }
    
    .metric-progress {
        width: 100%;
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        overflow: hidden;
        margin-top: 5px;
    }
    
    /* Progress bar color variants */
    .progress-bar {
        height: 100%;
        transition: width 0.8s ease-in-out;
    }
    
    /* Custom progress bar styles */
    .w-full {
        width: 100%;
    }
    
    /* Dynamic width classes for progress bars */
    .w-20 { width: 20%; }
    .w-25 { width: 25%; }
    .w-30 { width: 30%; }
    .w-40 { width: 40%; }
    .w-50 { width: 50%; }
    .w-60 { width: 60%; }
    .w-70 { width: 70%; }
    .w-75 { width: 75%; }
    .w-80 { width: 80%; }
    .w-90 { width: 90%; }
    .w-100 { width: 100%; }
    
    .progress-blue {
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .progress-green {
        background: linear-gradient(90deg, #0ba360 0%, #3cba92 100%);
    }
    
    .progress-orange {
        background: linear-gradient(90deg, #f09819 0%, #edde5d 100%);
    }
    
    .progress-purple {
        background: linear-gradient(90deg, #8e2de2 0%, #4a00e0 100%);
    }
    
    .progress-teal {
        background: linear-gradient(90deg, #2193b0 0%, #6dd5ed 100%);
    }
    
    .progress-red {
        background: linear-gradient(90deg, #f44336 0%, #ff7961 100%);
    }
</style>
{% endblock %}

{% block content %}
<!-- Video Background -->
<div class="video-background">
    <video data-src="/static/videos/Financial Background Video Data Visuals - High Resolution.mp4" muted loop playsinline autoplay preload="auto"></video>
</div>

<div class="container-fluid px-4 pt-4">
    <h1 class="mb-4 text-white dashboard-title">Analytical Dashboard <span class="dashboard-subtitle">— Recommendation System</span></h1>
    
    <!-- Top metrics cards - vertically-oriented rectangles with horizontal scrolling --> 
    <div class="d-flex overflow-auto pb-3 mb-4">
        <!-- Metric Card 1: Total Products -->
        <div class="metric-card blue-glow">
            <div class="metric-icon">
                <i class="fas fa-box"></i>
            </div>
            <div class="metric-value">{{ total_products }}</div>
            <p class="metric-label">Total Products</p>
            <div class="metric-footer">
                <div class="metric-progress">
                    <div class="progress-bar progress-blue w-100"></div>
                </div>
            </div>
        </div>
        
        <!-- Metric Card 2: Average Rating -->
        <div class="metric-card orange-glow">
            <div class="metric-icon">
                <i class="fas fa-star"></i>
            </div>
            <div class="metric-value">{{ "%.1f"|format(avg_rating|float) }}</div>
            <p class="metric-label">Average Rating</p>
            <div class="metric-footer">
                <div class="metric-progress">
                    <div class="progress-bar progress-orange metric-progress-value" data-value="{{ avg_rating }}" data-max="5"></div>
                </div>
            </div>
        </div>
        
        <!-- Metric Card 3: Total Tags -->
        <div class="metric-card purple-glow">
            <div class="metric-icon">
                <i class="fas fa-tags"></i>
            </div>
            <div class="metric-value">{{ total_tags }}</div>
            <p class="metric-label">Product Tags</p>
            <div class="metric-footer">
                <div class="metric-progress">
                    <div class="progress-bar progress-purple w-100"></div>
                </div>
            </div>
        </div>
        
        <!-- Metric Card 4: Lowest Rated Tag -->
        <div class="metric-card teal-glow">
            <div class="metric-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="metric-value">{{ lowest_rated_tag.AvgRating|float|round(1) }}</div>
            <p class="metric-label">Lowest: {{ lowest_rated_tag.TagName }}</p>
            <div class="metric-footer">
                <div class="metric-progress">
                    <div class="progress-bar progress-teal metric-progress-value" data-value="{{ lowest_rated_tag.AvgRating }}" data-max="5"></div>
                </div>
            </div>
        </div>
        
        <!-- Metric Card 5: Most Tagged Product -->
        <div class="metric-card green-glow">
            <div class="metric-icon">
                <i class="fas fa-thumbs-up"></i>
            </div>
            <div class="metric-value">{{ most_tags_count }}</div>
            <p class="metric-label">Most Tagged</p>
            <div class="metric-footer">
                <div class="metric-progress">
                    <div class="progress-bar progress-green w-100"></div>
                </div>
            </div>
        </div>
        
        <!-- Metric Card 6: Top Tag (replacing Recommendation Strength) -->
        <div class="metric-card red-glow">
            <div class="metric-icon">
                <i class="fas fa-tag"></i>
            </div>
            <div class="metric-value">{{ popular_tags[0]['TagName'] if popular_tags else 'N/A' }}</div>
            <p class="metric-label">Most Popular Tag</p>
            <div class="metric-footer">
                <div class="metric-progress">
                    <div class="progress-bar progress-red metric-progress-value" data-value="{{ popular_tags[0]['TagUsage'] if popular_tags else 0 }}" data-max="{{ popular_tags[0]['TagUsage'] * 1.5 if popular_tags else 100 }}"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="glass-panel mb-4">
        <h2 class="text-white mb-3">Filters</h2>
        <form class="row" id="filterForm">
            <div class="col-md-4 mb-3">
                <label for="tagFilter" class="form-label text-white">Tag</label>
                <select class="form-select modern-select" id="tagFilter">
                    <option value="all">All Tags</option>
                    {% for tag in tags %}
                    <option value="{{ tag.TagName }}">{{ tag.TagName }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4 mb-3">
                <label for="ratingFilter" class="form-label text-white">Minimum Rating</label>
                <select class="form-select modern-select" id="ratingFilter">
                    <option value="0">All Ratings</option>
                    <option value="1">1+ Stars</option>
                    <option value="2">2+ Stars</option>
                    <option value="3">3+ Stars</option>
                    <option value="4">4+ Stars</option>
                    <option value="4.5">4.5+ Stars</option>
                </select>
            </div>
            <div class="col-md-4 mb-3">
                <label for="sortFilter" class="form-label text-white">Sort By</label>
                <select class="form-select modern-select" id="sortFilter">
                    <option value="rating-high">Rating (High to Low)</option>
                    <option value="rating-low">Rating (Low to High)</option>
                    <option value="count-high">Review Count (High to Low)</option>
                    <option value="count-low">Review Count (Low to High)</option>
                </select>
            </div>
            <div class="col-12">
                <button type="button" class="btn btn-primary modern-btn" onclick="filterTable()">Apply Filters</button>
                <button type="reset" class="btn btn-secondary modern-btn-secondary">Reset</button>
            </div>
        </form>
    </div>
</div>

<!-- Section 2: Tag Cloud -->
<div class="glass-panel mb-4">
    <h2 class="text-white mb-3">Tag Cloud</h2>
    <p class="text-white-50 mb-4">Popular tags sized by frequency. Click on a tag to filter.</p>
    
    <div class="tag-cloud" id="tagCloud">
        {% for tag in popular_tags[:30] %}
        <span class="tag-size-{{ tag.size }}" data-tag="{{ tag.TagName }}" onclick="filterByTag('{{ tag.TagName }}')">
            <i class="fas fa-tag me-1"></i>{{ tag.TagName }}
        </span>
        {% endfor %}
    </div>
</div>

<!-- Section 3: Rating Analysis -->
<div class="glass-panel mb-4">
    <h2 class="text-white mb-3">Rating Distribution</h2>
    <p class="text-white-50 mb-4"><i class="fas fa-chart-bar me-2"></i>Analysis of product rating distribution.</p>

    <div class="row">
        <!-- Rating Distribution -->
        <div class="col-12 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title"><i class="fas fa-chart-bar me-2"></i>Rating Distribution</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="ratingDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Extra charts removed to match required specification -->
</div>

<!-- Section 4: Top Rated Products by Category -->
<div class="glass-panel mb-4">
    <h2 class="text-white mb-3">Top Rated Products by Category</h2>
    <p class="text-white-50 mb-4">Column chart showing highest rated products across categories.</p>
    
    <div class="card">
        <div class="card-header">
            <h5 class="card-title"><i class="fas fa-chart-bar me-2"></i>Top Rated Products by Category</h5>
        </div>
        <div class="card-body">
            <div class="chart-container" style="height: 350px;">
                <canvas id="topRatedProductsChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Section 5: Tag Usage Trends Over Time -->
<div class="glass-panel mb-4">
    <h2 class="text-white mb-3">Tag Usage Trends Over Time</h2>
    <p class="text-white-50 mb-4">Analysis of tag usage trends over time.</p>
    
    <div class="card">
        <div class="card-header">
            <h5 class="card-title"><i class="fas fa-chart-line me-2"></i>Tag Usage Trends</h5>
        </div>
        <div class="card-body">
            <div class="chart-container" style="height: 350px;">
                <canvas id="tagActivityChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Section 6: Deep Dive -->
<div class="glass-panel mb-4">
    <h2 class="text-white mb-3">Deep Dive Analysis</h2>
    <p class="text-white-50 mb-4">Detailed product rating analysis and top performers.</p>
    
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title"><i class="fas fa-trophy me-2"></i>Top Rated Products</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Rating</th>
                    <th>Tags</th>
                    <th>Review Count</th>
                </tr>
            </thead>
            <tbody>
                {% for product in top_products %}
                <tr>
                    <td>{{ product.ProductName }}</td>
                    <td>
                        {% set rating = product.Rating|float %}
                        {% set full_stars = (rating|int) %}
                        {% set half_star = rating - full_stars >= 0.5 %}
                        {% set empty_stars = 5 - full_stars - (1 if half_star else 0) %}
                        
                        {% for i in range(full_stars) %}
                        <i class="fas fa-star text-warning"></i>
                        {% endfor %}
                        
                        {% if half_star %}
                        <i class="fas fa-star-half-alt text-warning"></i>
                        {% endif %}
                        
                        {% for i in range(empty_stars) %}
                        <i class="far fa-star text-muted"></i>
                        {% endfor %}
                        
                        {{ rating }}
                    </td>
                    <td>
                        {% for tag in product.Tags.split(',') %}
                        <span class="badge bg-info">{{ tag }}</span>
                        {% endfor %}
                    </td>
                    <td>{{ product.ReviewCount }}</td>
                </tr>
                {% endfor %}
                </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Tag Correlation Network removed to match required specification -->

</div> <!-- Close container-fluid -->

<!-- Section 5: Top Charts and Trends -->
<!-- Removed duplicate Trends & Analysis section to match the required specification -->

    <!-- All extra charts removed to match required specification -->
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js" integrity="sha512-Tn2m0TIpgVyTzzvmxLNuqbSJH3JP8jm+Cy3hvHrW7ndTDcJ1w5mBiksqDBb8GpE2ksktFvDB/ykZ0mDpsZj20w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
// All JavaScript functions defined outside of any event listeners

// Function to update progress bar indicators
function updateBarIndicators() {
    var progressBars = document.querySelectorAll('.metric-progress-value');
    for (var i = 0; i < progressBars.length; i++) {
        var bar = progressBars[i];
        var value = parseFloat(bar.getAttribute('data-value') || 0);
        var maxValue = parseFloat(bar.getAttribute('data-max') || 5);
        var percent = Math.min(100, Math.max(0, Math.floor((value / maxValue) * 100)));
        
        // Set the width directly with inline style for visibility
        bar.style.width = percent + '%';
    }
}

// Chart initialization function
function initializeCharts() {
        // Top Rated Products by Category Chart
        var topRatedProductsChart = document.getElementById('topRatedProductsChart');
        var topRatedProductsCtx = topRatedProductsChart ? topRatedProductsChart.getContext('2d') : null;
        if (topRatedProductsCtx) {
            var categoryNames = [];
            var categoryRatings = [];
            var hasValidCategoryData = false;
            
            try {
                // Get data from backend or use sample data
                const categoryDataStr = '{{ category_names|safe }}';
                const categoryRatingsStr = '{{ category_ratings|safe }}';
                
                // Parse the JSON strings into JavaScript arrays
                if (categoryDataStr && categoryDataStr !== 'null') {
                    categoryNames = JSON.parse(categoryDataStr);
                }
                
                if (categoryRatingsStr && categoryRatingsStr !== 'null') {
                    categoryRatings = JSON.parse(categoryRatingsStr);
                }
                
                console.log('Category Names:', categoryNames);
                console.log('Category Ratings:', categoryRatings);
                
                // Check if we have at least one valid data point
                if (categoryNames && categoryNames.length > 0 && 
                    categoryRatings && categoryRatings.length > 0) {
                    hasValidCategoryData = true;
                }
            } catch (e) {
                console.error('Error parsing category data:', e);
            }
            
            if (!hasValidCategoryData) {
                console.warn('No valid category data found, using sample data');
                // Sample fallback data
                categoryNames = ['Electronics', 'Clothing', 'Home', 'Sports', 'Books', 'Beauty', 'Toys', 'Automotive', 'Health', 'Garden'];
                categoryRatings = [4.7, 4.3, 4.1, 3.9, 4.5, 4.2, 3.8, 3.5, 4.0, 3.7];
            }
            
            // Sort data by ratings in descending order
            var combinedData = [];
            for (var i = 0; i < categoryNames.length; i++) {
                combinedData.push({
                    name: categoryNames[i],
                    rating: categoryRatings[i] || 0
                });
            }
            
            combinedData.sort(function(a, b) { return b.rating - a.rating; });
            
            // Get back sorted arrays
            var sortedNames = [];
            var sortedRatings = [];
            for (var i = 0; i < combinedData.length; i++) {
                sortedNames.push(combinedData[i].name);
                sortedRatings.push(combinedData[i].rating);
            }
            
            new Chart(topRatedProductsCtx, {
                type: 'bar', // Using bar type with x axis for vertical columns
                data: {
                    labels: sortedNames,
                    datasets: [{
                        label: 'Average Rating',
                        data: sortedRatings,
                        backgroundColor: sortedRatings.map(rating => {
                            // Color gradient based on rating
                            if (rating >= 4.5) return 'rgba(0, 230, 118, 0.7)';
                            if (rating >= 4.0) return 'rgba(79, 172, 254, 0.7)';
                            if (rating >= 3.5) return 'rgba(255, 193, 7, 0.7)';
                            if (rating >= 3.0) return 'rgba(255, 152, 0, 0.7)';
                            return 'rgba(244, 67, 54, 0.7)';
                        }),
                        borderColor: sortedRatings.map(rating => {
                            if (rating >= 4.5) return 'rgba(0, 230, 118, 1)';
                            if (rating >= 4.0) return 'rgba(79, 172, 254, 1)';
                            if (rating >= 3.5) return 'rgba(255, 193, 7, 1)';
                            if (rating >= 3.0) return 'rgba(255, 152, 0, 1)';
                            return 'rgba(244, 67, 54, 1)';
                        }),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'x', // Explicitly set to 'x' for column chart
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 5,
                            title: {
                                display: true,
                                text: 'Average Rating (1-5)',
                                color: 'rgba(255, 255, 255, 0.9)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Rating Distribution Chart
            var ratingDistCtx = document.getElementById('ratingDistributionChart');
            if (ratingDistCtx) {
                ratingDistCtx = ratingDistCtx.getContext('2d');
                var ratingLabels = ['1★', '2★', '3★', '4★', '5★'];
                var ratingDistribution = [0, 0, 0, 0, 0]; // Default empty data
                
                try {
                    // Parse rating distribution data from flask
                    var ratingDistStr = '{{ rating_distribution|safe }}';
                    console.log('Raw rating distribution JSON:', ratingDistStr);
                    
                    if (ratingDistStr && ratingDistStr !== '[]' && ratingDistStr !== 'null') {
                        var parsedDist = JSON.parse(ratingDistStr);
                        if (parsedDist && parsedDist.length === 5) {
                            ratingDistribution = parsedDist;
                        }
                    }
                    
                    console.log('Parsed rating distribution:', ratingDistribution);
                } catch (e) {
                    console.error('Error parsing rating distribution:', e);
                    // Fallback sample data
                    ratingDistribution = [5, 8, 15, 30, 42];
                }
                
                new Chart(ratingDistCtx, {
                    type: 'bar',
                    data: {
                        labels: ratingLabels,
                        datasets: [{
                            label: 'Number of Ratings',
                            data: ratingDistribution,
                            backgroundColor: [
                                'rgba(244, 67, 54, 0.7)',
                                'rgba(255, 152, 0, 0.7)',
                                'rgba(255, 193, 7, 0.7)',
                                'rgba(79, 172, 254, 0.7)',
                                'rgba(0, 230, 118, 0.7)'
                            ],
                            borderColor: [
                                'rgba(244, 67, 54, 1)',
                                'rgba(255, 152, 0, 1)',
                                'rgba(255, 193, 7, 1)',
                                'rgba(79, 172, 254, 1)',
                                'rgba(0, 230, 118, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Ratings',
                                    color: 'rgba(255, 255, 255, 0.9)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
            
            // Tag Activity Chart - Line chart showing tag usage over time
            var tagActivityElement = document.getElementById('tagActivityChart');
            var tagActivityCtx = tagActivityElement ? tagActivityElement.getContext('2d') : null;
            if (tagActivityCtx) {
                var tagActivity = [];
                var activityTagNames = [];
                
                try {
                    // Get tag activity data from Flask
                    var tagActivityStr = '{{ tag_activity|safe }}';
                    var activityTagNamesStr = '{{ tag_names|safe }}';
                    
                    console.log('Raw tag activity JSON:', tagActivityStr);
                    console.log('Raw activity tag names JSON:', activityTagNamesStr);
                    
                    // Handle potential JSON parsing errors safely
                    try {
                        if (tagActivityStr && tagActivityStr !== '[]' && tagActivityStr !== 'null') {
                            tagActivity = JSON.parse(tagActivityStr);
                        }
                    } catch (parseError) {
                        console.error('Error parsing tag activity data:', parseError);
                    }
                    
                    try {
                        if (activityTagNamesStr && activityTagNamesStr !== '[]' && activityTagNamesStr !== 'null') {
                            activityTagNames = JSON.parse(activityTagNamesStr);
                        }
                    } catch (parseError) {
                        console.error('Error parsing activity tag names:', parseError);
                    }
                    
                    // If we have no data, use sample data
                    if (!tagActivity || !Array.isArray(tagActivity) || tagActivity.length === 0) {
                        console.warn('No tag activity data found or invalid format, using sample data');
                        // Sample data for 5 tags over 6 months
                        tagActivity = [
                            [12, 15, 18, 22, 25, 30],  // Tag 1
                            [8, 10, 12, 15, 18, 20],   // Tag 2
                            [20, 18, 16, 14, 15, 17],  // Tag 3
                            [5, 8, 10, 12, 15, 18],    // Tag 4
                            [15, 13, 12, 10, 8, 10]    // Tag 5
                        ];
                    }
                    
                    if (!activityTagNames || !Array.isArray(activityTagNames) || activityTagNames.length === 0) {
                        activityTagNames = ['Electronics', 'Clothing', 'Home', 'Sports', 'Books'];
                    }
                    
                    // Limit to 5 tags for readability
                    activityTagNames = activityTagNames.slice(0, 5);
                    tagActivity = tagActivity.slice(0, 5);
                    
                    console.log('Tag activity data:', tagActivity);
                    console.log('Activity tag names:', activityTagNames);
                } catch (e) {
                    console.error('Error in tag activity chart setup:', e);
                    // Sample fallback data
                    activityTagNames = ['Electronics', 'Clothing', 'Home', 'Sports', 'Books'];
                    tagActivity = [
                        [12, 15, 18, 22, 25, 30],
                        [8, 10, 12, 15, 18, 20],
                        [20, 18, 16, 14, 15, 17],
                        [5, 8, 10, 12, 15, 18],
                        [15, 13, 12, 10, 8, 10]
                    ];
                }
                
                // Generate time labels (last 6 months)
                var timeLabels = [];
                var now = new Date();
                for (var i = 5; i >= 0; i--) {
                    var month = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    var monthName = month.toLocaleString('default', { month: 'short' });
                    timeLabels.push(monthName);
                }
                
                // Create datasets for each tag
                var chartColors = [
                    'rgba(79, 172, 254, 0.7)',
                    'rgba(0, 230, 118, 0.7)',
                    'rgba(255, 193, 7, 0.7)',
                    'rgba(255, 87, 34, 0.7)',
                    'rgba(156, 39, 176, 0.7)'
                ];
                
                var chartBorders = [
                    'rgba(79, 172, 254, 1)',
                    'rgba(0, 230, 118, 1)',
                    'rgba(255, 193, 7, 1)',
                    'rgba(255, 87, 34, 1)',
                    'rgba(156, 39, 176, 1)'
                ];
                
                var tagDatasets = [];
                for (var i = 0; i < activityTagNames.length; i++) {
                    var tagName = activityTagNames[i];
                    tagDatasets.push({
                        label: tagName,
                        data: (tagActivity[i] && Array.isArray(tagActivity[i])) ? tagActivity[i] : [0, 0, 0, 0, 0, 0],
                        borderColor: chartBorders[i % chartBorders.length],
                        backgroundColor: chartColors[i % chartColors.length],
                        borderWidth: 2,
                        tension: 0.4,
                        fill: false,
                        pointRadius: 4,
                        pointBackgroundColor: chartBorders[i % chartBorders.length]
                    });
                }
                
                new Chart(tagActivityCtx, {
                    type: 'line',
                    data: {
                        labels: timeLabels,
                        datasets: tagDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Usage Count',
                                    color: 'rgba(255, 255, 255, 0.9)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.9)'
                                }
                            }
                        }
                    }
                });
            }
        }
        
// Filter table function
// Update progress bars and indicators for metric cards
function updateBarIndicators() {
    console.log('Updating progress bars and indicators...');
    
    // Get all progress bars
    var progressBars = document.querySelectorAll('.progress-bar');
    
    // Update each progress bar with smooth animation
    for (var i = 0; i < progressBars.length; i++) {
        var bar = progressBars[i];
        var value = parseFloat(bar.getAttribute('data-value')) || 0;
        var max = parseFloat(bar.getAttribute('data-max')) || 100;
        
        // Calculate percentage (0-100)
        var percent = (value / max) * 100;
        
        // Ensure a minimum width for visibility
        percent = Math.max(percent, 3);
        
        // Set width with smooth transition
        (function(bar, percent) {
            setTimeout(function() {
                bar.style.width = percent + '%';
            }, 100);
        })(bar, percent);
    }
    
    // Update circular indicators if any exist
    var indicators = document.querySelectorAll('.circular-indicator');
    for (var j = 0; j < indicators.length; j++) {
        var indicator = indicators[j];
        var value = parseFloat(indicator.getAttribute('data-value')) || 0;
        var max = parseFloat(indicator.getAttribute('data-max')) || 100;
        
        // Calculate percentage for the indicator
        var pct = Math.min((value / max) * 100, 100);
        
        // Update indicator display
        var displayElement = indicator.querySelector('.indicator-value');
        if (displayElement) {
            displayElement.textContent = Math.round(pct) + '%';
        }
    }
}

function filterTable() {
            var tagFilter = document.getElementById('tagFilter');
            var tag = 'all';
            if (tagFilter && tagFilter.value) {
                tag = tagFilter.value;
            }
            
            var ratingFilter = document.getElementById('ratingFilter');
            var minRating = 0;
            if (ratingFilter && ratingFilter.value) {
                minRating = parseFloat(ratingFilter.value);
            }
            
            var sortFilter = document.getElementById('sortFilter');
            var sortBy = 'name';
            if (sortFilter && sortFilter.value) {
                sortBy = sortFilter.value;
            }
            
            var rows = document.querySelectorAll('#productsTable tbody tr');
            var visibleCount = 0;
            
            for (var i = 0; i < rows.length; i++) {
                var row = rows[i];
                var tagsAttr = row.getAttribute('data-tags');
                var rowTags = [];
                if (tagsAttr) {
                    rowTags = tagsAttr.split(',');
                }
                
                var rating = 0;
                if (row.getAttribute('data-rating')) {
                    rating = parseFloat(row.getAttribute('data-rating'));
                }
                
                var tagMatch = (tag === 'all');
                if (!tagMatch) {
                    for (var j = 0; j < rowTags.length; j++) {
                        if (rowTags[j] === tag) {
                            tagMatch = true;
                            break;
                        }
                    }
                }
                
                var ratingMatch = (rating >= minRating);
                
                if (tagMatch && ratingMatch) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            }
            
            // Update visible count
            var countElement = document.getElementById('visibleCount');
            if (countElement) {
                countElement.textContent = visibleCount;
            }
            
            // Sort the table
            var tbody = document.querySelector('#productsTable tbody');
            if (tbody) {
                var visibleRows = [];
                for (var i = 0; i < rows.length; i++) {
                    if (rows[i].style.display !== 'none') {
                        visibleRows.push(rows[i]);
                    }
                }
                
                visibleRows.sort(function(a, b) {
                    if (sortBy === 'rating') {
                        var ratingA = 0;
                        var ratingB = 0;
                        
                        if (a.getAttribute('data-rating')) {
                            ratingA = parseFloat(a.getAttribute('data-rating'));
                        }
                        
                        if (b.getAttribute('data-rating')) {
                            ratingB = parseFloat(b.getAttribute('data-rating'));
                        }
                        
                        return ratingB - ratingA; // Descending order for ratings
                    } else if (sortBy === 'name') {
                        var nameA = '';
                        var nameB = '';
                        
                        var firstCellA = a.querySelector('td:first-child');
                        if (firstCellA && firstCellA.textContent) {
                            nameA = firstCellA.textContent;
                        }
                        
                        var firstCellB = b.querySelector('td:first-child');
                        if (firstCellB && firstCellB.textContent) {
                            nameB = firstCellB.textContent;
                        }
                        
                        return nameA.localeCompare(nameB); // Ascending order for names
                    }
                    return 0;
                });
                
                // Re-append in sorted order
                for (var i = 0; i < visibleRows.length; i++) {
                    tbody.appendChild(visibleRows[i]);
                }
            }
        }
        
// Filter by tag
function filterByTag(tagName) {
    var tagFilter = document.getElementById('tagFilter');
    
    if (tagFilter) {
        if (!tagName) {
            tagName = 'all';
        }
        tagFilter.value = tagName;
        filterTable();
    }
}

// Document ready event
document.addEventListener('DOMContentLoaded', function() {
    // Initialize video background with error handling
    var videoElement = document.querySelector('.video-background video');
    if (videoElement && videoElement.getAttribute('data-src')) {
        try {
            videoElement.src = videoElement.getAttribute('data-src');
            videoElement.addEventListener('error', function(e) {
                console.error('Error loading video:', e);
                // Add a fallback background if video fails to load
                document.querySelector('.video-background').style.backgroundColor = 'rgba(8, 23, 54, 0.9)';
            });
            videoElement.addEventListener('loadeddata', function() {
                console.log('Video loaded successfully');
            });
        } catch(e) {
            console.error('Video initialization error:', e);
            // Add fallback styling
            document.querySelector('.video-background').style.backgroundColor = 'rgba(8, 23, 54, 0.9)';
        }
    }
    
    // Update progress bars when page loads
    updateBarIndicators();
    
    // Initialize charts
    initializeCharts();
    
    // Initialize filter functionality 
    var applyFilterBtn = document.getElementById('applyFilter');
    if (applyFilterBtn) {
        applyFilterBtn.addEventListener('click', function(){
            filterTable();
        });
    }
    
    // Add tag filter functionality
    var tags = document.querySelectorAll('.tag');
    if (tags && tags.length > 0) {
        for (var i = 0; i < tags.length; i++) {
            tags[i].addEventListener('click', function() {
                filterByTag(this.textContent.trim());
            });
        }
    }
});
</script>

{% endblock content %}
