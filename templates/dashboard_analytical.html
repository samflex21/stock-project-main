{% extends "base.html" %}

{% block title %}Analytical Dashboard{% endblock %}

{% block body_attributes %}class="analytical-page"{% endblock %}
{% block html_attributes %}class="analytical-page"{% endblock %}

{% block head %}
<!-- Chart.js for data visualization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Modern design styling for Analytical Dashboard -->
<style>
    /* Global styles for analytical dashboard */
    html.analytical-page, body.analytical-page {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow-x: hidden;
        font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: transparent;
        color: #ffffff;
        scroll-behavior: smooth;
    }

    /* Video background for analytical dashboard */
    .video-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        overflow: hidden;
    }
    
    /* Modern dashboard title */
    .dashboard-title {
        font-weight: 600;
        font-size: 2.2rem;
        letter-spacing: 0.5px;
        margin-bottom: 1.5rem;
        background: linear-gradient(90deg, #ffffff, #e0e0e0);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .dashboard-subtitle {
        font-weight: 400;
        opacity: 0.8;
    }
    
    /* Modern form controls */
    .modern-select {
        background: rgba(30, 41, 59, 0.8);
        color: white;
        border: 1px solid rgba(78, 152, 227, 0.3);
        border-radius: 8px;
        padding: 10px 15px;
        transition: all 0.3s ease;
    }
    
    .modern-select:focus {
        box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.3);
        border-color: rgba(79, 172, 254, 0.5);
        outline: none;
    }
    
    .modern-btn {
        background: linear-gradient(135deg, #4facfe, #00f2fe);
        border: none;
        box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .modern-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(79, 172, 254, 0.6);
    }
    
    .modern-btn-secondary {
        background: rgba(30, 41, 59, 0.6);
        border: 1px solid rgba(78, 152, 227, 0.3);
        box-shadow: 0 4px 15px rgba(30, 41, 59, 0.3);
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 500;
        transition: all 0.3s ease;
        color: white;
    }
    
    .modern-btn-secondary:hover {
        background: rgba(30, 41, 59, 0.8);
        transform: translateY(-2px);
    }

    .video-background video {
        position: absolute;
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        object-fit: cover;
        opacity: 0.9;
    }

    /* Modern glass panels with blur effect - Now with gradient borders */
    .glass-panel {
        background: rgba(30, 41, 59, 0.65) !important;
        backdrop-filter: blur(12px) !important;
        -webkit-backdrop-filter: blur(12px) !important;
        border-radius: 20px !important;
        border: 1px solid rgba(78, 152, 227, 0.3) !important;
        box-shadow: 0 8px 32px 0 rgba(15, 23, 42, 0.5) !important;
        padding: 20px;
        margin-bottom: 24px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .glass-panel::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        z-index: 1;
    }

    .glass-panel:hover {
        box-shadow: 0 12px 40px 0 rgba(16, 24, 40, 0.6) !important;
        transform: translateY(-5px);
    }

    /* Card styling with glassmorphism - updated with modern gradients */
    .card {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-radius: 15px;
        border: 1px solid rgba(78, 152, 227, 0.2);
        box-shadow: 0 8px 24px 0 rgba(15, 23, 42, 0.3);
        overflow: hidden;
        transition: all 0.3s ease;
        height: 100%;
        margin-bottom: 20px;
        position: relative;
    }
    
    .card::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px 0 rgba(15, 23, 42, 0.4);
    }
    
    .card:hover::after {
        opacity: 1;
    }

    .card-header {
        background: rgba(30, 41, 59, 0.8);
        border-bottom: 1px solid rgba(78, 152, 227, 0.2);
        padding: 15px 20px;
    }

    .card-title {
        margin-bottom: 0;
        color: #fff;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .card-body {
        padding: 20px;
    }

    /* Chart container styling with glassmorphism */
    .chart-container {
        position: relative;
        height: 350px;
        margin-bottom: 0;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.08);
        padding: 10px;
    }
    
    /* Metric cards styles - modern vertical design */
    .metric-card {
        padding: 1.25rem;
        border-radius: 16px;
        position: relative;
        overflow: hidden;
        width: 170px;
        min-height: 220px;
        margin-right: 15px;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        background: rgba(30, 41, 59, 0.75);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(78, 152, 227, 0.2);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    /* Modern tag cloud styling */
    .tag-cloud {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        padding: 15px;
    }
    
    .tag-cloud span {
        padding: 8px 18px;
        border-radius: 20px;
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(78, 152, 227, 0.2);
        cursor: pointer;
        transition: all 0.3s ease;
        color: white;
        display: inline-block;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    
    .tag-cloud span:hover {
        background: rgba(79, 172, 254, 0.2);
        border-color: rgba(79, 172, 254, 0.4);
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(79, 172, 254, 0.2);
    }
    
    /* Tag size variants with gradient backgrounds */
    .tag-size-1 { 
        font-size: 0.8rem; 
    }
    .tag-size-1 {
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.7), rgba(30, 41, 59, 0.6));
    }
    
    .tag-size-2 { 
        font-size: 0.9rem; 
    }
    .tag-size-2 {
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.75), rgba(44, 82, 130, 0.5));
    }
    
    .tag-size-3 { 
        font-size: 1rem; 
    }
    .tag-size-3 {
        background: linear-gradient(135deg, rgba(44, 82, 130, 0.6), rgba(78, 152, 227, 0.4));
    }
    
    .tag-size-4 { 
        font-size: 1.1rem; 
    }
    .tag-size-4 {
        background: linear-gradient(135deg, rgba(78, 152, 227, 0.5), rgba(79, 172, 254, 0.4));
    }
    
    .tag-size-5 { 
        font-size: 1.2rem; 
    }
    .tag-size-5 {
        background: linear-gradient(135deg, rgba(79, 172, 254, 0.6), rgba(0, 242, 254, 0.4));
    }
    /* Tag size classes with modern sizing */
    .tag-size-1 { font-size: 0.9rem; opacity: 0.8; }
    .tag-size-2 { font-size: 1.1rem; opacity: 0.85; }
    .tag-size-3 { font-size: 1.3rem; opacity: 0.9; }
    .tag-size-4 { font-size: 1.5rem; opacity: 0.95; }
    .tag-size-5 { font-size: 1.7rem; opacity: 1; }
    
    /* Modern rating progress bar */
    .rating-progress {
        height: 10px;
        width: 100%;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.2);
        overflow: hidden;
    }
    
    .rating-bar {
        border-radius: 10px;
        background: linear-gradient(to right, #4facfe, #00f2fe) !important;
        transition: width 1s ease-in-out;
    }

    /* Modern section header styling */
    .section-header {
        background: linear-gradient(135deg, rgba(16, 57, 144, 0.2), rgba(24, 119, 242, 0.2));
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-left: 4px solid #4facfe;
        padding: 20px;
        margin-bottom: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(31, 38, 135, 0.2);
        transition: all 0.3s ease;
    }
    
    .section-header h2 {
        margin-bottom: 8px;
        color: #ffffff;
        font-weight: 700;
        letter-spacing: 1px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .section-header p {
        margin-bottom: 0;
        color: rgba(255, 255, 255, 0.85);
        font-weight: 300;
        letter-spacing: 0.5px;
    }
    
    /* Table styling */
    .table {
        color: #fff;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        overflow: hidden;
    }
    
    .table thead th {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.1);
        color: #fff;
        font-weight: 600;
        letter-spacing: 0.5px;
        padding: 15px;
    }
    
    .table td {
        border-color: rgba(255, 255, 255, 0.1);
        padding: 12px 15px;
        vertical-align: middle;
    }
    
    .table tbody tr:hover {
        background: rgba(255, 255, 255, 0.1);
    }
    
    /* Badge styling */
    .badge {
        padding: 6px 10px;
        border-radius: 30px;
        font-weight: 500;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .badge.bg-info {
        background: linear-gradient(135deg, #0093E9, #80D0C7) !important;
    }
    
    /* Star rating styling */
    .fa-star.text-warning {
        color: #FFD700 !important;
        filter: drop-shadow(0 0 2px rgba(255, 215, 0, 0.5));
    }
    
    .fa-star-half-alt.text-warning {
        color: #FFD700 !important;
        filter: drop-shadow(0 0 2px rgba(255, 215, 0, 0.5));
    }
    
    .fa-star.text-muted {
        color: rgba(255, 255, 255, 0.3) !important;
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    
    ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
    }
    
    /* Metrics card styling - vertical design as per user preference */
    .metric-card {
        width: 170px;
        min-height: 220px;
        padding: 1.25rem;
        margin-right: 15px;
        border-radius: 16px;
        background: rgba(30, 41, 59, 0.75);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
    }
    
    .metric-icon {
        position: relative;
        width: 60px;
        height: 60px;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 50%;
        margin: 0 auto 15px;
        font-size: 26px;
        /* Ensure top-center positioning */
        top: 0;
        left: 50%;
        transform: translateX(-50%);
    }
    
    .blue-glow .metric-icon {
        background: rgba(79, 172, 254, 0.2);
        box-shadow: 0 0 15px rgba(79, 172, 254, 0.5);
        color: #4facfe;
    }
    
    .green-glow .metric-icon {
        background: rgba(0, 230, 118, 0.2);
        box-shadow: 0 0 15px rgba(0, 230, 118, 0.5);
        color: #00e676;
    }
    
    .purple-glow .metric-icon {
        background: rgba(153, 102, 255, 0.2);
        box-shadow: 0 0 15px rgba(153, 102, 255, 0.5);
        color: #9966ff;
    }
    
    .orange-glow .metric-icon {
        background: rgba(255, 153, 0, 0.2);
        box-shadow: 0 0 15px rgba(255, 153, 0, 0.5);
        color: #ff9900;
    }
    
    .teal-glow .metric-icon {
        background: rgba(20, 184, 166, 0.2);
        box-shadow: 0 0 15px rgba(20, 184, 166, 0.5);
        color: #14b8a6;
    }
    
    .red-glow .metric-icon {
        background: rgba(244, 67, 54, 0.2);
        box-shadow: 0 0 15px rgba(244, 67, 54, 0.5);
        color: #f44336;
    }
    
    .metric-value {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 10px 0;
        background: linear-gradient(90deg, #ffffff 0%, #e0e0e0 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .metric-label {
        font-size: 1rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 15px;
        line-height: 1.2;
        /* Ensure label doesn't overflow in narrow cards */
        max-width: 95%;
    }
    
    .metric-footer {
        margin-top: auto;
        width: 100%;
    }
    
    .metric-progress {
        width: 100%;
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        overflow: hidden;
        margin-top: 5px;
    }
    
    /* Progress bar color variants */
    .progress-bar {
        height: 100%;
        transition: width 0.8s ease-in-out;
    }
    
    /* Custom progress bar styles */
    .w-full {
        width: 100%;
    }
    
    /* Dynamic width classes for progress bars */
    .w-20 { width: 20%; }
    .w-25 { width: 25%; }
    .w-30 { width: 30%; }
    .w-40 { width: 40%; }
    .w-50 { width: 50%; }
    .w-60 { width: 60%; }
    .w-70 { width: 70%; }
    .w-75 { width: 75%; }
    .w-80 { width: 80%; }
    .w-90 { width: 90%; }
    .w-100 { width: 100%; }
    
    .progress-blue {
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .progress-green {
        background: linear-gradient(90deg, #0ba360 0%, #3cba92 100%);
    }
    
    .progress-orange {
        background: linear-gradient(90deg, #f09819 0%, #edde5d 100%);
    }
    
    .progress-purple {
        background: linear-gradient(90deg, #8e2de2 0%, #4a00e0 100%);
    }
    
    .progress-teal {
        background: linear-gradient(90deg, #2193b0 0%, #6dd5ed 100%);
    }
    
    .progress-red {
        background: linear-gradient(90deg, #f44336 0%, #ff7961 100%);
    }
    
    /* Sidebar styles */
    .glass-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100vh;
        background: linear-gradient(135deg, rgba(40, 60, 100, 0.6), rgba(50, 70, 120, 0.7));
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 5px 0 15px rgba(0, 0, 0, 0.15);
        padding: 20px;
        z-index: 100;
        overflow-y: auto;
        transition: transform 0.3s ease;
    }
    
    /* Main content adjustment for sidebar */
    .main-content-with-sidebar {
        margin-left: 300px;
        width: calc(100% - 300px);
        transition: margin-left 0.3s ease, width 0.3s ease;
        padding: 15px;
    }
    
    /* Improved glass panel styling */
    .glass-panel {
        padding: 15px;
        margin-bottom: 20px;
    }
    
    /* Sidebar toggle button for mobile */
    .sidebar-toggle {
        display: none;
        position: fixed;
        top: 15px;
        left: 15px;
        z-index: 101;
        background: rgba(40, 60, 100, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 5px;
        padding: 5px 10px;
        color: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    
    /* Logo and site title in sidebar */
    .sidebar-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .sidebar-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: white;
        margin-top: 10px;
        letter-spacing: 1px;
        text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    /* Navigation links */
    .sidebar-nav {
        margin-bottom: 30px;
    }
    
    .sidebar-nav-item {
        display: block;
        padding: 12px 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        color: rgba(255, 255, 255, 0.9) !important;
        text-decoration: none;
        transition: all 0.2s ease;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .sidebar-nav-item:hover, .sidebar-nav-item.active {
        background: rgba(255, 255, 255, 0.2);
        color: white !important;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .sidebar-nav-item i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
    }
    
    /* Filter section in sidebar */
    .sidebar-filters {
        margin-bottom: 30px;
    }
    
    .sidebar-section-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: white;
        position: relative;
        padding-bottom: 8px;
    }
    
    .sidebar-section-title:after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 50px;
        height: 3px;
        background: linear-gradient(90deg, rgba(79, 172, 254, 0.8), rgba(0, 242, 254, 0.8));
        border-radius: 3px;
    }
    
    /* Responsive adjustments */
    @media (max-width: 992px) {
        .glass-sidebar {
            transform: translateX(-100%);
        }
        
        .glass-sidebar.show-sidebar {
            transform: translateX(0);
        }
        
        .main-content-with-sidebar {
            margin-left: 0;
            width: 100%;
        }
        
        .sidebar-toggle {
            display: block;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Video Background -->
<div class="video-background">
    <video data-src="/static/videos/Financial Background Video Data Visuals - High Resolution.mp4" muted loop playsinline autoplay preload="auto"></video>
</div>

<!-- Mobile sidebar toggle button -->
<button class="sidebar-toggle" id="sidebarToggle">
    <i class="fas fa-bars"></i>
</button>

<!-- Glass Sidebar -->
<div class="glass-sidebar" id="sidebar">
    <div class="sidebar-header">
        <i class="fas fa-chart-line fa-2x text-white"></i>
        <div class="sidebar-title">Analytical Dashboard</div>
    </div>
    
    <div class="sidebar-nav">
        <h3 class="sidebar-section-title">Navigation</h3>
        <a href="/dashboard" class="sidebar-nav-item">
            <i class="fas fa-home"></i> Overview
        </a>
        <a href="/dashboard_tactical" class="sidebar-nav-item">
            <i class="fas fa-chess"></i> Tactical Dashboard
        </a>
        <a href="/dashboard_analytical" class="sidebar-nav-item active">
            <i class="fas fa-chart-bar"></i> Analytical Dashboard
        </a>
        <a href="/dashboard_strategic" class="sidebar-nav-item">
            <i class="fas fa-chess-queen"></i> Strategic Dashboard
        </a>
    </div>
    
    <!-- Filters moved to sidebar -->
    <div class="sidebar-filters">
        <h3 class="sidebar-section-title">Filters</h3>
        <form id="filterForm">
            <div class="mb-3">
                <label for="tagFilter" class="form-label text-white">Tag</label>
                <select class="form-select modern-select" id="tagFilter">
                    <option value="all">All Tags</option>
                    {% for tag in tags %}
                    <option value="{{ tag.TagName }}">{{ tag.TagName }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label for="ratingFilter" class="form-label text-white">Minimum Rating</label>
                <select class="form-select modern-select" id="ratingFilter">
                    <option value="0">All Ratings</option>
                    <option value="1">1+ Stars</option>
                    <option value="2">2+ Stars</option>
                    <option value="3">3+ Stars</option>
                    <option value="4">4+ Stars</option>
                    <option value="4.5">4.5+ Stars</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="sortFilter" class="form-label text-white">Sort By</label>
                <select class="form-select modern-select" id="sortFilter">
                    <option value="rating-high">Rating (High to Low)</option>
                    <option value="rating-low">Rating (Low to High)</option>
                    <option value="count-high">Review Count (High to Low)</option>
                    <option value="count-low">Review Count (Low to High)</option>
                </select>
            </div>
            <div>
                <button type="button" class="btn btn-primary modern-btn w-100 mb-2" onclick="filterDashboard()">Apply Filters</button>
                <button type="button" class="btn btn-secondary modern-btn-secondary w-100" onclick="resetFilters()">Reset</button>
            </div>
        </form>
    </div>
</div>

<!-- Main Content Area with Sidebar Adjustment -->
<div class="main-content-with-sidebar">
    <h1 class="mb-4 text-white dashboard-title">Analytical Dashboard <span class="dashboard-subtitle">— Recommendation System</span></h1>
    
    <!-- Top metrics cards - vertically-oriented rectangles with horizontal scrolling --> 
    <div class="d-flex overflow-auto pb-3 mb-4">
        <!-- Metric Card 1: Total Products -->
        <div class="metric-card blue-glow">
            <div class="metric-icon">
                <i class="fas fa-box"></i>
            </div>
            <div class="metric-value">{{ total_products }}</div>
            <p class="metric-label">Total Products</p>
            <div class="metric-footer">
                <div class="metric-progress">
                    <div class="progress-bar progress-blue w-100"></div>
                </div>
            </div>
        </div>
        
        <!-- Metric Card 2: Average Rating -->
        <div class="metric-card orange-glow">
            <div class="metric-icon">
                <i class="fas fa-star"></i>
            </div>
            <div class="metric-value">{{ "%.1f"|format(avg_rating|float) }}</div>
            <p class="metric-label">Average Rating</p>
            <div class="metric-footer">
                <div class="metric-progress">
                    <div class="progress-bar progress-orange metric-progress-value" data-value="{{ avg_rating }}" data-max="5"></div>
                </div>
            </div>
        </div>
        
        <!-- Metric Card 3: Total Tags -->
        <div class="metric-card purple-glow">
            <div class="metric-icon">
                <i class="fas fa-tags"></i>
            </div>
            <div class="metric-value">{{ total_tags }}</div>
            <p class="metric-label">Product Tags</p>
            <div class="metric-footer">
                <div class="metric-progress">
                    <div class="progress-bar progress-purple w-100"></div>
                </div>
            </div>
        </div>
        
        <!-- Metric Card 4: Lowest Rated Tag -->
        <div class="metric-card teal-glow">
            <div class="metric-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="metric-value">{{ lowest_rated_tag.AvgRating|float|round(1) }}</div>
            <p class="metric-label">Lowest: {{ lowest_rated_tag.TagName }}</p>
            <div class="metric-footer">
                <div class="metric-progress">
                    <div class="progress-bar progress-teal metric-progress-value" data-value="{{ lowest_rated_tag.AvgRating }}" data-max="5"></div>
                </div>
            </div>
        </div>
        
        <!-- Metric Card 5: Most Tagged Product -->
        <div class="metric-card green-glow">
            <div class="metric-icon">
                <i class="fas fa-thumbs-up"></i>
            </div>
            <div class="metric-value">{{ most_tags_count }}</div>
            <p class="metric-label">Most Tagged</p>
            <div class="metric-footer">
                <div class="metric-progress">
                    <div class="progress-bar progress-green w-100"></div>
                </div>
            </div>
        </div>
        
        <!-- Metric Card 6: Top Tag (replacing Recommendation Strength) -->
        <div class="metric-card red-glow">
            <div class="metric-icon">
                <i class="fas fa-tag"></i>
            </div>
            <div class="metric-value">{{ popular_tags[0]['TagName'] if popular_tags else 'N/A' }}</div>
            <p class="metric-label">Most Popular Tag</p>
            <div class="metric-footer">
                <div class="metric-progress">
                    <div class="progress-bar progress-red metric-progress-value" data-value="{{ popular_tags[0]['TagUsage'] if popular_tags else 0 }}" data-max="{{ popular_tags[0]['TagUsage'] * 1.5 if popular_tags else 100 }}"></div>
                </div>
            </div>
        </div>
    </div>
    
</div>

<!-- Tag Cloud and Rating Distribution Row -->
<div class="row">
    <!-- Section 2: Tag Cloud -->
    <div class="col-lg-6 mb-4">
        <div class="glass-panel h-100">
            <h2 class="text-white mb-3">Tag Cloud</h2>
            <p class="text-white-50 mb-3">Popular tags sized by frequency. Click on a tag to filter.</p>
            
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title"><i class="fas fa-tags me-2"></i>Product Tags</h5>
                </div>
                <div class="card-body">
                    <div class="tag-cloud" id="tagCloud">
                        {% for tag in popular_tags[:30] %}
                        <span class="tag-size-{{ tag.size }}" data-tag="{{ tag.TagName }}" onclick="filterByTag('{{ tag.TagName }}')">
                            <i class="fas fa-tag me-1"></i>{{ tag.TagName }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 3: Rating Analysis -->
    <div class="col-lg-6 mb-4">
        <div class="glass-panel h-100">
            <h2 class="text-white mb-3">Rating Distribution</h2>
            <p class="text-white-50 mb-3">Analysis of product rating distribution.</p>
            
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title"><i class="fas fa-chart-bar me-2"></i>Rating Distribution</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="ratingDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section - Row with Two Charts -->
<div class="row">
    <!-- Section 4: Top Rated Products by Category -->
    <div class="col-lg-6 mb-4">
        <div class="glass-panel h-100">
            <h2 class="text-white mb-3">Top Rated Products by Category</h2>
            <p class="text-white-50 mb-4">Column chart showing highest rated products across categories.</p>
            
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title"><i class="fas fa-chart-bar me-2"></i>Top Rated Products by Category</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 320px;">
                        <canvas id="topRatedProductsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 5: Tag Usage Trends Over Time -->
    <div class="col-lg-6 mb-4">
        <div class="glass-panel h-100">
            <h2 class="text-white mb-3">Tag Usage Trends Over Time</h2>
            <p class="text-white-50 mb-4">Analysis of tag usage trends over time.</p>
            
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title"><i class="fas fa-chart-line me-2"></i>Tag Usage Trends</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 320px;">
                        <canvas id="tagActivityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Section: Category Analysis removed - was duplicate of Top Rated Products by Category -->

<!-- Section 6: Deep Dive Analysis -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="glass-panel">
            <h2 class="text-white mb-3">Deep Dive Analysis</h2>
            <p class="text-white-50 mb-4">Detailed product rating analysis and top performers.</p>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title"><i class="fas fa-trophy me-2"></i>Top Rated Products</h5>
                </div>
                <div class="card-body">
            <div class="table-responsive">
                <table class="table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Rating</th>
                    <th>Tags</th>
                    <th>Review Count</th>
                </tr>
            </thead>
            <tbody>
                {% for product in top_products %}
                <tr>
                    <td>{{ product.ProductName }}</td>
                    <td>
                        {% set rating = product.Rating|float %}
                        {% set full_stars = (rating|int) %}
                        {% set half_star = rating - full_stars >= 0.5 %}
                        {% set empty_stars = 5 - full_stars - (1 if half_star else 0) %}
                        
                        {% for i in range(full_stars) %}
                        <i class="fas fa-star text-warning"></i>
                        {% endfor %}
                        
                        {% if half_star %}
                        <i class="fas fa-star-half-alt text-warning"></i>
                        {% endif %}
                        
                        {% for i in range(empty_stars) %}
                        <i class="far fa-star text-muted"></i>
                        {% endfor %}
                        
                        {{ rating }}
                    </td>
                    <td>
                        {% for tag in product.Tags.split(',') %}
                        <span class="badge bg-info">{{ tag }}</span>
                        {% endfor %}
                    </td>
                    <td>{{ product.ReviewCount }}</td>
                </tr>
                {% endfor %}
                </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Tag Correlation Network removed to match required specification -->

</div> <!-- Close container-fluid -->

<!-- Section 5: Top Charts and Trends -->
<!-- Removed duplicate Trends & Analysis section to match the required specification -->

    <!-- All extra charts removed to match required specification -->
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js" integrity="sha512-Tn2m0TIpgVyTzzvmxLNuqbSJH3JP8jm+Cy3hvHrW7ndTDcJ1w5mBiksqDBb8GpE2ksktFvDB/ykZ0mDpsZj20w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
// All JavaScript functions defined outside of any event listeners

// Function to update progress bar indicators
function updateBarIndicators() {
    var progressBars = document.querySelectorAll('.metric-progress-value');
    for (var i = 0; i < progressBars.length; i++) {
        var bar = progressBars[i];
        var value = parseFloat(bar.getAttribute('data-value') || 0);
        var maxValue = parseFloat(bar.getAttribute('data-max') || 5);
        var percent = Math.min(100, Math.max(0, Math.floor((value / maxValue) * 100)));
        
        // Set the width directly with inline style for visibility
        bar.style.width = percent + '%';
    }
}

// Chart initialization function
function initializeCharts() {
    initCategoryChart();
    initRatingDistributionChart();
    initTagActivityChart();
}

// Initialize the Top Rated Products by Category chart
function initCategoryChart() {
    var chartElement = document.getElementById('topRatedProductsChart');
    if (!chartElement) return;
    
    var ctx = chartElement.getContext('2d');
    var productCounts = [];
    
    // Create chart with empty data initially
    window.categoryChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Average Rating',
                data: [],
                backgroundColor: 'rgba(79, 172, 254, 0.7)',
                borderColor: 'rgba(79, 172, 254, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 5,
                    title: {
                        display: true,
                        text: 'Average Rating (1-5)',
                        color: 'rgba(255, 255, 255, 0.9)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: 'rgba(255, 255, 255, 0.9)'
                    }
                },
                title: {
                    display: true,
                    text: 'Top Rated Products by Category',
                    color: 'rgba(255, 255, 255, 0.9)',
                    font: {
                        size: 16
                    }
                },
                tooltip: {
                    callbacks: {
                        afterLabel: function(context) {
                            const index = context.dataIndex;
                            if (productCounts && productCounts.length > index) {
                                return `Products: ${productCounts[index]}`;
                            }
                            return '';
                        }
                    }
                }
            }
        }
    });
    
    // Fetch data from API right after chart initialization
    fetchCategoryData();
    
    // Function to fetch category data from API endpoint
    function fetchCategoryData() {
        console.log('Fetching category data from API...');
        
        fetch('/api/category-chart-data')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('API response:', data);
                
                if (data.success && data.category_names && data.category_names.length > 0) {
                    // Successfully got data from the API
                    const categoryNames = data.category_names;
                    const categoryRatings = data.category_ratings;
                    productCounts = data.product_counts || [];
                    
                    console.log('✓ Successfully loaded category data from API');
                    console.log('Category names:', categoryNames);
                    console.log('Category ratings:', categoryRatings);
                    
                    // Update chart with the API data
                    updateCategoryChart(categoryNames, categoryRatings);
                } else {
                    console.warn('⚠️ API returned no valid category data');
                    // Use fallback data
                    useFallbackCategoryData();
                }
            })
            .catch(error => {
                console.error('Error fetching category data:', error);
                // Use fallback data on error
                useFallbackCategoryData();
            });
    }
    
    // Function to update chart with the data
    function updateCategoryChart(names, ratings) {
        if (!names || !ratings || names.length === 0 || ratings.length === 0) {
            console.error('Invalid data for category chart update');
            return;
        }
        
        // Sort data by ratings in descending order
        const combinedData = names.map((name, index) => {
            return { 
                name: name, 
                rating: ratings[index],
                count: productCounts[index] || 0
            };
        });
        
        combinedData.sort((a, b) => b.rating - a.rating);
        
        // Get sorted arrays
        const sortedNames = combinedData.map(item => item.name);
        const sortedRatings = combinedData.map(item => item.rating);
        const sortedCounts = combinedData.map(item => item.count);
        
        // Update the chart with sorted data
        window.categoryChart.data.labels = sortedNames;
        window.categoryChart.data.datasets[0].data = sortedRatings;
        
        // Update colors based on ratings
        window.categoryChart.data.datasets[0].backgroundColor = sortedRatings.map(rating => {
            if (rating >= 4.5) return 'rgba(0, 230, 118, 0.7)';
            if (rating >= 4.0) return 'rgba(79, 172, 254, 0.7)';
            if (rating >= 3.5) return 'rgba(255, 193, 7, 0.7)';
            if (rating >= 3.0) return 'rgba(255, 152, 0, 0.7)';
            return 'rgba(244, 67, 54, 0.7)';
        });
        
        window.categoryChart.data.datasets[0].borderColor = sortedRatings.map(rating => {
            if (rating >= 4.5) return 'rgba(0, 230, 118, 1)';
            if (rating >= 4.0) return 'rgba(79, 172, 254, 1)';
            if (rating >= 3.5) return 'rgba(255, 193, 7, 1)';
            if (rating >= 3.0) return 'rgba(255, 152, 0, 1)';
            return 'rgba(244, 67, 54, 1)';
        });
        
        // Update chart
        window.categoryChart.update();
        console.log('✓ Chart updated with new data');
    }
    
    // Function to use fallback sample data
    function useFallbackCategoryData() {
        console.warn('⚠️ Using fallback sample data for chart');
        const fallbackNames = ['Electronics', 'Clothing', 'Home', 'Sports', 'Books', 'Beauty', 'Toys', 'Automotive', 'Health', 'Garden'];
        const fallbackRatings = [4.7, 4.3, 4.1, 3.9, 4.5, 4.2, 3.8, 3.5, 4.0, 3.7];
        updateCategoryChart(fallbackNames, fallbackRatings);
    }
}

// Initialize the Rating Distribution Chart
function initRatingDistributionChart() {
    // Get chart element and exit if not found
    var chartElement = document.getElementById('ratingDistributionChart');
    if (!chartElement) {
        console.error('Rating distribution chart container not found');
        return;
    }
    

    try {
        var ctx = chartElement.getContext('2d');
        var parsedData;
        try {
            // Get rating distribution data from Flask
            var ratingStr = '{{ rating_distribution|safe }}';
            console.log('Raw rating distribution JSON:', ratingStr);
            
            if (ratingStr && ratingStr !== '[]' && ratingStr !== 'null') {
                parsedData = JSON.parse(ratingStr);
                console.log('Parsed rating distribution data:', parsedData);
                
                // Store the original data for filtering
                originalRatingDistribution = [...parsedData];
            } else {
                throw new Error('Invalid rating distribution data');
            }
        } catch (e) {
            console.error('Error parsing rating distribution data:', e);
            // Sample data as fallback
            parsedData = [150, 230, 180, 320, 240];
            originalRatingDistribution = [...parsedData];
        }
        
        // Create the chart
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['1 Star', '2 Stars', '3 Stars', '4 Stars', '5 Stars'],
                datasets: [{
                    label: 'Rating Distribution',
                    data: parsedData,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(255, 159, 64, 0.7)',
                        'rgba(255, 205, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(54, 162, 235, 0.7)'
                    ],
                    borderColor: [
                        'rgb(255, 99, 132)',
                        'rgb(255, 159, 64)',
                        'rgb(255, 205, 86)',
                        'rgb(75, 192, 192)',
                        'rgb(54, 162, 235)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: {
                            size: 14
                        },
                        bodyFont: {
                            size: 13
                        },
                        callbacks: {
                            label: function(context) {
                                return ' Products: ' + context.raw;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false,
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#f1f5f9'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#f1f5f9'
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error initializing Rating Distribution chart:', error);
    }
}

// Initialize the Tag Activity Chart
function initTagActivityChart() {
    var ctx = document.getElementById('tagActivityChart');
    if (!ctx) {
        console.error('Tag activity chart container not found');
        return;
    }
    ctx = ctx.getContext('2d');

    
    // Variables to hold our chart data
    var tagActivity = [];
    var activityTagNames = [];
    
    try {
        // Get tag activity data from Flask
        var tagActivityStr = '{{ tag_activity|safe }}';
        var activityTagNamesStr = '{{ tag_names|safe }}';
        
        console.log('Raw tag activity JSON: ' + tagActivityStr);
        console.log('Raw activity tag names JSON: ' + activityTagNamesStr);
        
        // Handle potential JSON parsing errors safely
        if (tagActivityStr && tagActivityStr !== '[]' && tagActivityStr !== 'null') {
            tagActivity = JSON.parse(tagActivityStr);
            
            // Handle both 1D and 2D arrays
            if (Array.isArray(tagActivity)) {
                // If first element isn't an array, we have a 1D array
                if (tagActivity.length > 0 && !Array.isArray(tagActivity[0])) {
                    console.log('Detected 1D array, converting to 2D format');
                    // Generate a simulated 6-month history for each tag
                    var tempActivity = [];
                    for (var i = 0; i < Math.min(tagActivity.length, 5); i++) {
                        var baseValue = parseInt(tagActivity[i]) || 1;
                        var monthlyData = [];
                        for (var j = 0; j < 6; j++) {
                            // Create a realistic trend with slight variations
                            var variation = Math.floor(baseValue * 0.2 * (Math.random() - 0.5));
                            monthlyData.push(Math.max(1, baseValue + variation));
                        }
                        tempActivity.push(monthlyData);
                    }
                    tagActivity = tempActivity;
                }
            } else {
                // Not an array at all, create sample data
                tagActivity = []; // Will be filled with sample data below
            }
        }
        
        // Parse tag names
        if (activityTagNamesStr && activityTagNamesStr !== '[]' && activityTagNamesStr !== 'null') {
            activityTagNames = JSON.parse(activityTagNamesStr);
            
            // Make tag names more user-friendly if they're just codes
            activityTagNames = activityTagNames.map(function(tag) {
                // If the tag is just a code (like '006'), make it more readable
                if (/^\d{3}$|^\d[A-Z]{2}$/.test(tag)) {
                    return 'Tag ' + tag; 
                }
                return tag;
            });
        }
    } catch (parseError) {
        console.error('Error parsing tag activity data:', parseError);
    }
    
    // If we still have no data, use sample data
    if (!tagActivity || !Array.isArray(tagActivity) || tagActivity.length === 0) {
        console.warn('No tag activity data found or invalid format, using sample data');
        // Sample data for 5 tags over 6 months
        tagActivity = [
            [12, 15, 18, 22, 25, 30],  // Tag 1
            [8, 10, 12, 15, 18, 20],   // Tag 2
            [20, 18, 16, 14, 15, 17],  // Tag 3
            [5, 8, 10, 12, 15, 18],    // Tag 4
            [15, 13, 12, 10, 8, 10]    // Tag 5
        ];
    }
    
    if (!activityTagNames || !Array.isArray(activityTagNames) || activityTagNames.length === 0) {
        activityTagNames = ['Electronics', 'Clothing', 'Home', 'Sports', 'Books'];
    }
    
    // Limit to 5 tags for readability
    activityTagNames = activityTagNames.slice(0, 5);
    tagActivity = tagActivity.slice(0, Math.min(5, tagActivity.length));
    
    // Make sure we have data for each tag (in case lengths don't match)
    while (activityTagNames.length > tagActivity.length) {
        tagActivity.push([5, 6, 8, 7, 9, 10]); // Default values
    }
    
    console.log('Tag activity data:', tagActivity);
    console.log('Activity tag names:', activityTagNames);
    
    // Generate month labels for the x-axis (last 6 months)
    var monthLabels = [];
    var today = new Date();
    for (var i = 5; i >= 0; i--) {
        var d = new Date(today);
        d.setMonth(today.getMonth() - i);
        monthLabels.push(d.toLocaleDateString('default', { month: 'short' }));
    }
    
    // Generate dataset colors for each tag
    var colors = [
        'rgba(75, 192, 192, 0.7)',    // Teal
        'rgba(153, 102, 255, 0.7)',   // Purple
        'rgba(255, 159, 64, 0.7)',    // Orange
        'rgba(54, 162, 235, 0.7)',     // Blue
        'rgba(255, 99, 132, 0.7)'      // Red
    ];
    
    var borderColors = [
        'rgba(75, 192, 192, 1)',    // Teal
        'rgba(153, 102, 255, 1)',   // Purple
        'rgba(255, 159, 64, 1)',    // Orange
        'rgba(54, 162, 235, 1)',     // Blue
        'rgba(255, 99, 132, 1)'      // Red
    ];
    
    // Create datasets for each tag
    var datasets = [];
    for (var i = 0; i < tagActivity.length && i < activityTagNames.length; i++) {
        datasets.push({
            label: activityTagNames[i],
            data: tagActivity[i],
            borderColor: borderColors[i % borderColors.length],
            backgroundColor: colors[i % colors.length],
            borderWidth: 2,
            tension: 0.3,  // Smooth curves
            fill: false,
            pointRadius: 3,
            pointHoverRadius: 5
        });
    }
    
    // Create the chart
    var tagActivityChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: monthLabels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Tag Activity Over Time',
                    color: '#e0e0e0',
                    font: {
                        size: 16
                    }
                },
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#e0e0e0',
                        padding: 10,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.7)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    titleFont: {
                        size: 14
                    },
                    bodyFont: {
                        size: 13
                    },
                    padding: 10,
                    displayColors: true,
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#e0e0e0'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: '#e0e0e0'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            },
            elements: {
                line: {
                    borderWidth: 2
                },
                point: {
                    radius: 3,
                    hoverRadius: 5
                }
            }
        }
    });
}

// Function to update all progress bars with smooth animations
function updateProgressBars() {
    // Get all progress bars
    var progressBars = document.querySelectorAll('.progress-bar');
    
    // Update each progress bar with smooth animation
    for (var i = 0; i < progressBars.length; i++) {
        var bar = progressBars[i];
        var value = parseFloat(bar.getAttribute('data-value')) || 0;
        var max = parseFloat(bar.getAttribute('data-max')) || 100;
        
        // Calculate percentage (0-100)
        var percent = (value / max) * 100;
        
        // Ensure a minimum width for visibility
        percent = Math.max(percent, 3);
        
        // Set width with smooth transition
        (function(bar, percent) {
            setTimeout(function() {
                bar.style.width = percent + '%';
            }, 100);
        })(bar, percent);
    }
    
    // Update circular indicators if any exist
    var indicators = document.querySelectorAll('.circular-indicator');
    for (var j = 0; j < indicators.length; j++) {
        var indicator = indicators[j];
        var value = parseFloat(indicator.getAttribute('data-value')) || 0;
        var max = parseFloat(indicator.getAttribute('data-max')) || 100;
        
        // Calculate percentage for the indicator
        var pct = Math.min((value / max) * 100, 100);
        
        // Update indicator display
        var displayElement = indicator.querySelector('.indicator-value');
        if (displayElement) {
            displayElement.textContent = Math.round(pct) + '%';
        }
    }
}

// Master filter function that affects all dashboard elements
function filterDashboard() {
    // Get filter values
    var tagFilter = document.getElementById('tagFilter');
    var tag = tagFilter && tagFilter.value ? tagFilter.value : 'all';
    
    var ratingFilter = document.getElementById('ratingFilter');
    var minRating = ratingFilter && ratingFilter.value ? parseFloat(ratingFilter.value) : 0;
    
    var sortFilter = document.getElementById('sortFilter');
    var sortBy = sortFilter && sortFilter.value ? sortFilter.value : 'rating-high';
    
    // Track filtered data for charts
    var filteredTagRatings = [];
    var filteredRatingDistribution = [0, 0, 0, 0, 0]; // For 1-5 stars
    var filteredTagActivity = [];
    var filteredCategoryData = {
        categories: [],
        ratings: [],
        counts: []
    };
    
    // 1. Filter the products table in Deep Dive Analysis
    filterProductsTable(tag, minRating, sortBy);
    
    // 2. Filter and update the Rating Distribution Chart
    updateRatingDistributionChart(tag, minRating);
    
    // 3. Filter and update the Tag Activity Chart
    updateTagActivityChart(tag, minRating);
    
    // 4. Filter and update the Category Chart
    updateCategoryChart(tag, minRating);
    
    // 5. Update progress bars with filtered data
    updateProgressBarsWithFilters(tag, minRating);
    
    // Apply visual indication that filters are active
    document.querySelectorAll('.glass-panel').forEach(panel => {
        if (tag !== 'all' || minRating > 0) {
            panel.classList.add('filtered');
        } else {
            panel.classList.remove('filtered');
        }
    });
}

// Filter the products table in Deep Dive Analysis
function filterProductsTable(tag, minRating, sortBy) {
    var rows = document.querySelectorAll('#productsTable tbody tr');
    var visibleCount = 0;
    
    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var tagsAttr = row.getAttribute('data-tags');
        var rowTags = tagsAttr ? tagsAttr.split(',') : [];
        
        var rating = row.getAttribute('data-rating') ? 
            parseFloat(row.getAttribute('data-rating')) : 0;
        
        var reviewCount = row.getAttribute('data-reviews') ?
            parseInt(row.getAttribute('data-reviews')) : 0;
        
        var visible = true;
        
        // Filter by tag
        if (tag !== 'all' && rowTags.indexOf(tag) === -1) {
            visible = false;
        }
        
        // Filter by rating
        if (visible && rating < minRating) {
            visible = false;
        }
        
        // Display or hide based on filters
        row.style.display = visible ? '' : 'none';
        if (visible) visibleCount++;
    }
    
    // Update the counter
    var counter = document.getElementById('productsCounter');
    if (counter) {
        counter.textContent = visibleCount + ' products';
    }
    
    // Sort the visible rows
    var tbody = document.querySelector('#productsTable tbody');
    if (tbody) {
        var visibleRows = Array.from(rows).filter(row => row.style.display !== 'none');
        
        // Sort based on selected criteria
        visibleRows.sort(function(a, b) {
            if (sortBy === 'rating-high') {
                var ratingA = parseFloat(a.getAttribute('data-rating') || '0');
                var ratingB = parseFloat(b.getAttribute('data-rating') || '0');
                return ratingB - ratingA; // High to Low
            } 
            else if (sortBy === 'rating-low') {
                var ratingA = parseFloat(a.getAttribute('data-rating') || '0');
                var ratingB = parseFloat(b.getAttribute('data-rating') || '0');
                return ratingA - ratingB; // Low to High
            }
            else if (sortBy === 'count-high') {
                var countA = parseInt(a.getAttribute('data-reviews') || '0');
                var countB = parseInt(b.getAttribute('data-reviews') || '0');
                return countB - countA; // High to Low
            }
            else if (sortBy === 'count-low') {
                var countA = parseInt(a.getAttribute('data-reviews') || '0');
                var countB = parseInt(b.getAttribute('data-reviews') || '0');
                return countA - countB; // Low to High
            }
            return 0;
        });
        
        // Re-append in sorted order
        visibleRows.forEach(row => tbody.appendChild(row));
    }
}

// Update Rating Distribution Chart based on filters
// Global variables to store original chart data for filtering
var originalRatingDistribution;

// Initialize global rating distribution data when chart is created
function storeRatingDistribution(data) {
    originalRatingDistribution = [...data]; // Create a copy of the array
    console.log('Stored original rating distribution:', originalRatingDistribution);
}

function updateRatingDistributionChart(tag, minRating) {
    var chart = Chart.getChart('ratingDistributionChart');
    if (!chart) return;
    
    // Use stored original data
    if (!originalRatingDistribution) {
        originalRatingDistribution = [...chart.data.datasets[0].data];
        console.log('Captured rating distribution from chart:', originalRatingDistribution);
    }
    
    // If no filters applied, restore original data
    if (tag === 'all' && minRating === 0) {
        chart.data.datasets[0].data = [...originalRatingDistribution];
        chart.update();
        return;
    }
    
    // Apply tag filter to rating data if needed
    // This is a simplified example - in a real implementation, you would need 
    // actual tag-to-rating data from backend to do this properly
    var filteredData = originalRatingDistribution.map(function(value, index) {
        // Apply minimum rating filter (index + 1 is the star rating)
        if (index + 1 < minRating) {
            return 0;
        }
        // We're using a simple approximation for tag filtering
        // In a real implementation, the backend would provide more accurate data
        return tag !== 'all' ? Math.floor(value * 0.7) : value;
    });
    
    chart.data.datasets[0].data = filteredData;
    chart.update();
}

// Update Tag Activity Chart based on filters
function updateTagActivityChart(tag, minRating) {
    var chart = Chart.getChart('tagActivityChart');
    if (!chart) return;
    
    // If no filters or filtering by the specific tag, show that tag only
    if (tag !== 'all') {
        // Find the tag index
        var tagIndex = activityTagNames.indexOf(tag);
        if (tagIndex !== -1) {
            // Hide all other datasets
            chart.data.datasets.forEach(function(dataset, i) {
                dataset.hidden = (dataset.label !== tag);
            });
        }
    } else {
        // Show all datasets
        chart.data.datasets.forEach(function(dataset) {
            dataset.hidden = false;
        });
    }
    
    chart.update();
}

// Update Category Chart based on filters
function updateCategoryChart(tag, minRating) {
    var chart = Chart.getChart('topRatedProductsChart');
    if (!chart) return;
    
    // If no filters applied, refresh data from API
    if (tag === 'all' && minRating === 0) {
        // Re-fetch data from API if available, otherwise use cached data
        fetch('/api/category-chart-data')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    chart.data.labels = data.category_names;
                    chart.data.datasets[0].data = data.category_ratings;
                    chart.data.datasets[1].data = data.product_counts;
                    chart.update();
                }
            })
            .catch(error => {
                console.error('Error fetching category data:', error);
            });
        return;
    }
    
    // Apply simple filtering for demonstration
    // In a real implementation, you'd fetch filtered data from the backend
    var reduction = minRating > 0 ? (minRating / 5) : 0;
    
    chart.data.datasets[0].data = chart.data.datasets[0].data.map(function(value) {
        return Math.max(value - reduction, 0);
    });
    
    chart.data.datasets[1].data = chart.data.datasets[1].data.map(function(value) {
        return Math.floor(value * (1 - reduction * 0.2));
    });
    
    chart.update();
}

// Update progress bars with filtered data
function updateProgressBarsWithFilters(tag, minRating) {
    // Only adjust progress if filters are applied
    if (tag !== 'all' || minRating > 0) {
        // Apply a simple reduction factor based on filters
        var reduction = minRating > 0 ? (minRating / 10) : 0;
        reduction += (tag !== 'all' ? 0.1 : 0);
        
        document.querySelectorAll('.progress-bar').forEach(function(bar) {
            var originalValue = parseFloat(bar.getAttribute('data-original') || bar.style.width);
            if (!bar.getAttribute('data-original')) {
                bar.setAttribute('data-original', bar.style.width);
            }
            
            // Calculate filtered width
            var newWidth = Math.max(originalValue * (1 - reduction), 0) + '%';
            
            // Animate the change
            bar.style.width = newWidth;
        });
    } else {
        // Restore original values
        document.querySelectorAll('.progress-bar').forEach(function(bar) {
            var originalValue = bar.getAttribute('data-original');
            if (originalValue) {
                bar.style.width = originalValue;
            }
        });
    }
}

// Function to handle filter form reset
function resetFilters() {
    document.getElementById('tagFilter').value = 'all';
    document.getElementById('ratingFilter').value = '0';
    document.getElementById('sortFilter').value = 'rating-high';
    
    // Remove filtered class from panels
    document.querySelectorAll('.glass-panel').forEach(panel => {
        panel.classList.remove('filtered');
    });
    
    // Reinitialize all charts with original data
    initializeCharts();
    
    // Update counter
    var counter = document.getElementById('productsCounter');
    if (counter) {
        var totalRows = document.querySelectorAll('#productsTable tbody tr').length;
        counter.textContent = totalRows + ' products';
    }
}

// Master initialization function for all charts
function initializeCharts() {
    // Initialize each chart
    initCategoryChart(); // Re-enabled as we kept the first chart container
    initRatingDistributionChart();
    initTagActivityChart();
    
    // Update progress bars and indicators
    updateProgressBars();
}

// Filter by tag
function filterByTag(tagName) {
    var tagFilter = document.getElementById('tagFilter');
    
    if (tagFilter) {
        if (!tagName) {
            tagName = 'all';
        }
        tagFilter.value = tagName;
        filterDashboard();
    }
}

// Master document ready event handler - consolidate all initialization code here
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing Analytical Dashboard...');
    
    // Initialize video background with improved error handling
    var videoElement = document.querySelector('.video-background video');
    
    // Disable video for performance improvement if causing errors
    if (videoElement) {
        videoElement.addEventListener('error', function(e) {
            console.log('Video error detected, disabling video for performance');
            var vidContainer = document.querySelector('.video-background');
            if (vidContainer) {
                // Replace video with a static gradient background for better performance
                vidContainer.innerHTML = '';
                vidContainer.style.background = 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)';
            }
        });
    }
    if (videoElement && videoElement.getAttribute('data-src')) {
        try {
            videoElement.src = videoElement.getAttribute('data-src');
            videoElement.addEventListener('error', function(e) {
                console.error('Error loading video:', e);
                // Add a fallback background if video fails to load
                document.querySelector('.video-background').style.backgroundColor = 'rgba(8, 23, 54, 0.9)';
            });
            videoElement.addEventListener('loadeddata', function() {
                console.log('Video loaded successfully');
            });
        } catch(e) {
            console.error('Video initialization error:', e);
            // Add fallback styling
            document.querySelector('.video-background').style.backgroundColor = 'rgba(8, 23, 54, 0.9)';
        }
    }
    
    // Update progress bars when page loads
    updateBarIndicators();
    
    // Initialize charts
    initializeCharts();
    
    // Set up filter handlers for dropdown controls
    var filters = document.querySelectorAll('.filter-control');
    filters.forEach(function(filter) {
        filter.addEventListener('change', filterDashboard);
    });
    
    // Initialize filter button functionality 
    var applyFilterBtn = document.getElementById('applyFilter');
    if (applyFilterBtn) {
        applyFilterBtn.addEventListener('click', function(){
            filterDashboard();
        });
    }
    
    // Add tag filter functionality for clickable tags
    var tags = document.querySelectorAll('.tag');
    if (tags && tags.length > 0) {
        for (var i = 0; i < tags.length; i++) {
            tags[i].addEventListener('click', function() {
                filterByTag(this.textContent.trim());
            });
        }
    }
    
    // Reset filters button handler
    var resetBtn = document.getElementById('resetFiltersBtn');
    if (resetBtn) {
        resetBtn.addEventListener('click', function() {
            resetFilters();
        });
    }
    
    // Sidebar toggle functionality for mobile responsive design
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.querySelector('.main-content-with-sidebar');
    
    if (sidebarToggle && sidebar) {
        sidebarToggle.addEventListener('click', function() {
            sidebar.classList.toggle('show-sidebar');
            
            // Add a click handler to close sidebar when clicking outside on mobile
            if (sidebar.classList.contains('show-sidebar')) {
                document.addEventListener('click', function closeSidebar(e) {
                    if (!sidebar.contains(e.target) && e.target !== sidebarToggle) {
                        sidebar.classList.remove('show-sidebar');
                        document.removeEventListener('click', closeSidebar);
                    }
                });
            }
        });
    }
});
</script>

</div> <!-- Closing main-content-with-sidebar -->

{% endblock content %}
