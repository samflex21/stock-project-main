{% extends "base.html" %}

{% block title %}Analytical Dashboard{% endblock %}

{% block body_attributes %}class="analytical-page"{% endblock %}
{% block html_attributes %}class="analytical-page"{% endblock %}

{% block head %}
<!-- Chart.js for data visualization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Modern design styling for Analytical Dashboard -->
<style>
    /* Global styles for analytical dashboard */
    html.analytical-page, body.analytical-page {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow-x: hidden;
        font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: transparent;
        color: #ffffff;
        scroll-behavior: smooth;
    }

    /* Video background for analytical dashboard */
    .video-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        overflow: hidden;
    }
    
    /* Modern dashboard title */
    .dashboard-title {
        font-weight: 600;
        font-size: 2.2rem;
        letter-spacing: 0.5px;
        margin-bottom: 1.5rem;
        background: linear-gradient(90deg, #ffffff, #e0e0e0);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .dashboard-subtitle {
        font-weight: 400;
        opacity: 0.8;
    }
    
    /* Modern form controls */
    .modern-select {
        background: rgba(30, 41, 59, 0.8);
        color: white;
        border: 1px solid rgba(78, 152, 227, 0.3);
        border-radius: 8px;
        padding: 10px 15px;
        transition: all 0.3s ease;
    }
    
    .modern-select:focus {
        box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.3);
        border-color: rgba(79, 172, 254, 0.5);
        outline: none;
    }
    
    .modern-btn {
        background: linear-gradient(135deg, #4facfe, #00f2fe);
        border: none;
        box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .modern-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(79, 172, 254, 0.6);
    }
    
    .modern-btn-secondary {
        background: rgba(30, 41, 59, 0.6);
        border: 1px solid rgba(78, 152, 227, 0.3);
        box-shadow: 0 4px 15px rgba(30, 41, 59, 0.3);
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 500;
        transition: all 0.3s ease;
        color: white;
    }
    
    .modern-btn-secondary:hover {
        background: rgba(30, 41, 59, 0.8);
        transform: translateY(-2px);
    }

    .video-background video {
        position: absolute;
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        object-fit: cover;
        opacity: 0.9;
    }

    /* Modern glass panels with blur effect - Now with gradient borders */
    .glass-panel {
        background: rgba(30, 41, 59, 0.65) !important;
        backdrop-filter: blur(12px) !important;
        -webkit-backdrop-filter: blur(12px) !important;
        border-radius: 20px !important;
        border: 1px solid rgba(78, 152, 227, 0.3) !important;
        box-shadow: 0 8px 32px 0 rgba(15, 23, 42, 0.5) !important;
        padding: 20px;
        margin-bottom: 24px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .glass-panel::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        z-index: 1;
    }

    .glass-panel:hover {
        box-shadow: 0 12px 40px 0 rgba(16, 24, 40, 0.6) !important;
        transform: translateY(-5px);
    }

    /* Card styling with glassmorphism - updated with modern gradients */
    .card {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-radius: 15px;
        border: 1px solid rgba(78, 152, 227, 0.2);
        box-shadow: 0 8px 24px 0 rgba(15, 23, 42, 0.3);
        overflow: hidden;
        transition: all 0.3s ease;
        height: 100%;
        margin-bottom: 20px;
        position: relative;
    }
    
    .card::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px 0 rgba(15, 23, 42, 0.4);
    }
    
    .card:hover::after {
        opacity: 1;
    }

    .card-header {
        background: rgba(30, 41, 59, 0.8);
        border-bottom: 1px solid rgba(78, 152, 227, 0.2);
        padding: 15px 20px;
    }

    .card-title {
        margin-bottom: 0;
        color: #fff;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .card-body {
        padding: 20px;
    }

    /* Chart container styling with glassmorphism */
    .chart-container {
        position: relative;
        height: 350px;
        margin-bottom: 0;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.08);
        padding: 10px;
    }
    
    /* Metric cards styles - modern vertical design */
    .metric-card {
        padding: 1.25rem;
        border-radius: 16px;
        position: relative;
        overflow: hidden;
        width: 170px;
        min-height: 220px;
        margin-right: 15px;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        background: rgba(30, 41, 59, 0.75);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(78, 152, 227, 0.2);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    /* Modern tag cloud styling */
    .tag-cloud {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        padding: 15px;
    }
    
    .tag-cloud span {
        padding: 8px 18px;
        border-radius: 20px;
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(78, 152, 227, 0.2);
        cursor: pointer;
        transition: all 0.3s ease;
        color: white;
        display: inline-block;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    
    .tag-cloud span:hover {
        background: rgba(79, 172, 254, 0.2);
        border-color: rgba(79, 172, 254, 0.4);
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(79, 172, 254, 0.2);
    }
    
    /* Tag size variants with gradient backgrounds */
    .tag-size-1 { 
        font-size: 0.8rem; 
    }
    .tag-size-1 {
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.7), rgba(30, 41, 59, 0.6));
    }
    
    .tag-size-2 { 
        font-size: 0.9rem; 
    }
    .tag-size-2 {
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.75), rgba(44, 82, 130, 0.5));
    }
    
    .tag-size-3 { 
        font-size: 1rem; 
    }
    .tag-size-3 {
        background: linear-gradient(135deg, rgba(44, 82, 130, 0.6), rgba(78, 152, 227, 0.4));
    }
    
    .tag-size-4 { 
        font-size: 1.1rem; 
    }
    .tag-size-4 {
        background: linear-gradient(135deg, rgba(78, 152, 227, 0.5), rgba(79, 172, 254, 0.4));
    }
    
    .tag-size-5 { 
        font-size: 1.2rem; 
    }
    .tag-size-5 {
        background: linear-gradient(135deg, rgba(79, 172, 254, 0.6), rgba(0, 242, 254, 0.4));
    }
    /* Tag size classes with modern sizing */
    .tag-size-1 { font-size: 0.9rem; opacity: 0.8; }
    .tag-size-2 { font-size: 1.1rem; opacity: 0.85; }
    .tag-size-3 { font-size: 1.3rem; opacity: 0.9; }
    .tag-size-4 { font-size: 1.5rem; opacity: 0.95; }
    .tag-size-5 { font-size: 1.7rem; opacity: 1; }
    
    /* Modern rating progress bar */
    .rating-progress {
        height: 10px;
        width: 100%;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.2);
        overflow: hidden;
    }
    
    .rating-bar {
        border-radius: 10px;
        background: linear-gradient(to right, #4facfe, #00f2fe) !important;
        transition: width 1s ease-in-out;
    }

    /* Modern section header styling */
    .section-header {
        background: linear-gradient(135deg, rgba(16, 57, 144, 0.2), rgba(24, 119, 242, 0.2));
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-left: 4px solid #4facfe;
        padding: 20px;
        margin-bottom: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(31, 38, 135, 0.2);
        transition: all 0.3s ease;
    }
    
    .section-header h2 {
        margin-bottom: 8px;
        color: #ffffff;
        font-weight: 700;
        letter-spacing: 1px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .section-header p {
        margin-bottom: 0;
        color: rgba(255, 255, 255, 0.85);
        font-weight: 300;
        letter-spacing: 0.5px;
    }
    
    /* Table styling */
    .table {
        color: #fff;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        overflow: hidden;
    }
    
    .table thead th {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.1);
        color: #fff;
        font-weight: 600;
        letter-spacing: 0.5px;
        padding: 15px;
    }
    
    .table td {
        border-color: rgba(255, 255, 255, 0.1);
        padding: 12px 15px;
        vertical-align: middle;
    }
    
    .table tbody tr:hover {
        background: rgba(255, 255, 255, 0.1);
    }
    
    /* Badge styling */
    .badge {
        padding: 6px 10px;
        border-radius: 30px;
        font-weight: 500;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .badge.bg-info {
        background: linear-gradient(135deg, #0093E9, #80D0C7) !important;
    }
    
    /* Star rating styling */
    .fa-star.text-warning {
        color: #FFD700 !important;
        filter: drop-shadow(0 0 2px rgba(255, 215, 0, 0.5));
    }
    
    .fa-star-half-alt.text-warning {
        color: #FFD700 !important;
        filter: drop-shadow(0 0 2px rgba(255, 215, 0, 0.5));
    }
    
    .fa-star.text-muted {
        color: rgba(255, 255, 255, 0.3) !important;
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    
    ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
    }
    
    /* Metrics card styling */
    .metric-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        height: 100%;
        transition: all 0.3s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
    }
    
    .metric-icon {
        position: relative;
        top: 0;
        right: 0;
        width: 60px;
        height: 60px;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 50%;
        margin: 0 auto 15px;
        font-size: 26px;
    }
    
    .blue-glow .metric-icon {
        background: rgba(79, 172, 254, 0.2);
        box-shadow: 0 0 15px rgba(79, 172, 254, 0.5);
        color: #4facfe;
    }
    
    .green-glow .metric-icon {
        background: rgba(0, 230, 118, 0.2);
        box-shadow: 0 0 15px rgba(0, 230, 118, 0.5);
        color: #00e676;
    }
    
    .purple-glow .metric-icon {
        background: rgba(153, 102, 255, 0.2);
        box-shadow: 0 0 15px rgba(153, 102, 255, 0.5);
        color: #9966ff;
    }
    
    .orange-glow .metric-icon {
        background: rgba(255, 153, 0, 0.2);
        box-shadow: 0 0 15px rgba(255, 153, 0, 0.5);
        color: #ff9900;
    }
    
    .teal-glow .metric-icon {
        background: rgba(20, 184, 166, 0.2);
        box-shadow: 0 0 15px rgba(20, 184, 166, 0.5);
        color: #14b8a6;
    }
    
    .red-glow .metric-icon {
        background: rgba(244, 67, 54, 0.2);
        box-shadow: 0 0 15px rgba(244, 67, 54, 0.5);
        color: #f44336;
    }
    
    .metric-value {
        font-size: 1.75rem;
        font-weight: 600;
        margin: 10px 0;
        background: linear-gradient(90deg, #ffffff 0%, #e0e0e0 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .metric-label {
        font-size: 1rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 15px;
    }
    
    .metric-footer {
        margin-top: auto;
        width: 100%;
    }
    
    .metric-progress {
        width: 100%;
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        overflow: hidden;
        margin-top: 5px;
    }
    
    /* Progress bar color variants */
    .progress-bar {
        height: 100%;
    }
    
    /* Custom progress bar styles */
    .w-full {
        width: 100%;
    }
    
    /* Dynamic width classes for progress bars */
    .w-20 { width: 20%; }
    .w-25 { width: 25%; }
    .w-30 { width: 30%; }
    .w-40 { width: 40%; }
    .w-50 { width: 50%; }
    .w-60 { width: 60%; }
    .w-70 { width: 70%; }
    .w-75 { width: 75%; }
    .w-80 { width: 80%; }
    .w-90 { width: 90%; }
    .w-100 { width: 100%; }
    
    .progress-blue {
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .progress-orange {
        background: linear-gradient(90deg, #ff9900 0%, #ffac38 100%);
    }
    
    .progress-purple {
        background: linear-gradient(90deg, #9966ff 0%, #a94cff 100%);
    }
    
    .progress-green {
        background: linear-gradient(90deg, #00e676 0%, #42f593 100%);
    }
    
    .progress-teal {
        background: linear-gradient(90deg, #14b8a6 0%, #22d3be 100%);
    }
    
    .progress-red {
        background: linear-gradient(90deg, #f44336 0%, #ff7961 100%);
    }
</style>
{% endblock %}

{% block content %}
<!-- Video Background -->
<div class="video-background">
    <video data-src="/static/videos/Financial Background Video Data Visuals - High Resolution.mp4" muted loop autoplay></video>
</div>

<div class="container-fluid px-4 pt-4">
    <h1 class="mb-4 text-white dashboard-title">Analytical Dashboard <span class="dashboard-subtitle">â€” Recommendation System</span></h1>
    
    <!-- Top metrics cards - vertically-oriented rectangles with horizontal scrolling --> 
    <div class="d-flex overflow-auto pb-3 mb-4">
        <!-- Metric Card 1: Total Products -->
        <div class="metric-card blue-glow">
            <div class="metric-icon">
                <i class="fas fa-box"></i>
            </div>
            <div class="metric-value">{{ total_products }}</div>
            <p class="metric-label">Total Products</p>
            <div class="metric-footer">
                <div class="metric-progress">
                    <div class="progress-bar progress-blue w-100"></div>
                </div>
            </div>
        </div>
        
        <!-- Metric Card 2: Average Rating -->
        <div class="metric-card orange-glow">
            <div class="metric-icon">
                <i class="fas fa-star"></i>
            </div>
            <div class="metric-value">{{ "%.1f"|format(avg_rating|float) }}</div>
            <p class="metric-label">Average Rating</p>
            <div class="metric-footer">
                <div class="metric-progress">
                    <div class="progress-bar progress-orange metric-progress-value" data-value="{{ avg_rating }}" data-max="5"></div>
                </div>
            </div>
        </div>
        
        <!-- Metric Card 3: Total Tags -->
        <div class="metric-card purple-glow">
            <div class="metric-icon">
                <i class="fas fa-tags"></i>
            </div>
            <div class="metric-value">{{ total_tags }}</div>
            <p class="metric-label">Product Tags</p>
            <div class="metric-footer">
                <div class="metric-progress">
                    <div class="progress-bar progress-purple w-100"></div>
                </div>
            </div>
        </div>
        
        <!-- Metric Card 4: Top Rated Category -->
        <div class="metric-card teal-glow">
            <div class="metric-icon">
                <i class="fas fa-chart-line-down"></i>
            </div>
            <div class="metric-value">{{ lowest_rated_tag.AvgRating|float|round(1) }}</div>
            <p class="metric-label">{{ lowest_rated_tag.TagName }}</p>
            <div class="metric-footer">
                <div class="metric-progress">
                    <div class="progress-bar progress-teal metric-progress-value" data-value="{{ lowest_rated_tag.AvgRating }}" data-max="5"></div>
                </div>
            </div>
        </div>
        
        <!-- Metric Card 5: Most Tagged Product -->
        <div class="metric-card green-glow">
            <div class="metric-icon">
                <i class="fas fa-thumbs-up"></i>
            </div>
            <div class="metric-value">{{ most_tags_count }}</div>
            <p class="metric-label">Most Tagged</p>
            <div class="metric-footer">
                <div class="metric-progress">
                    <div class="progress-bar progress-green w-100"></div>
                </div>
            </div>
        </div>
        
        <!-- Metric Card 6: Top Tag (replacing Recommendation Strength) -->
        <div class="metric-card teal-glow">
            <div class="metric-icon">
                <i class="fas fa-tag"></i>
            </div>
            <div class="metric-value">{{ popular_tags[0]['TagName'] if popular_tags else 'N/A' }}</div>
            <p class="metric-label">Top Tag</p>
            <div class="metric-footer">
                <div class="metric-progress">
                    <div class="progress-bar progress-teal metric-progress-value" data-value="{{ popular_tags[0]['TagUsage'] if popular_tags else 0 }}" data-max="{{ popular_tags[0]['TagUsage'] * 1.5 if popular_tags else 100 }}"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="glass-panel mb-4">
        <h2 class="text-white mb-3">Filters</h2>
        <form class="row" id="filterForm">
            <div class="col-md-4 mb-3">
                <label for="tagFilter" class="form-label text-white">Tag</label>
                <select class="form-select modern-select" id="tagFilter">
                    <option value="all">All Tags</option>
                    {% for tag in tags %}
                    <option value="{{ tag.TagName }}">{{ tag.TagName }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4 mb-3">
                <label for="ratingFilter" class="form-label text-white">Minimum Rating</label>
                <select class="form-select modern-select" id="ratingFilter">
                    <option value="0">All Ratings</option>
                    <option value="1">1+ Stars</option>
                    <option value="2">2+ Stars</option>
                    <option value="3">3+ Stars</option>
                    <option value="4">4+ Stars</option>
                    <option value="4.5">4.5+ Stars</option>
                </select>
            </div>
            <div class="col-md-4 mb-3">
                <label for="sortFilter" class="form-label text-white">Sort By</label>
                <select class="form-select modern-select" id="sortFilter">
                    <option value="rating-high">Rating (High to Low)</option>
                    <option value="rating-low">Rating (Low to High)</option>
                    <option value="count-high">Review Count (High to Low)</option>
                    <option value="count-low">Review Count (Low to High)</option>
                </select>
            </div>
            <div class="col-12">
                <button type="button" class="btn btn-primary modern-btn" onclick="filterTable()">Apply Filters</button>
                <button type="reset" class="btn btn-secondary modern-btn-secondary">Reset</button>
            </div>
        </form>
    </div>
</div>

<!-- Section 2: Tag Cloud -->
<div class="glass-panel mb-4">
    <h2 class="text-white mb-3">Tag Cloud</h2>
    <p class="text-white-50 mb-4">Popular tags sized by frequency. Click on a tag to filter.</p>
    
    <div class="tag-cloud" id="tagCloud">
        {% for tag in popular_tags[:30] %}
        <span class="tag-size-{{ tag.size }}" data-tag="{{ tag.TagName }}" onclick="filterByTag('{{ tag.TagName }}')">
            <i class="fas fa-tag me-1"></i>{{ tag.TagName }}
        </span>
        {% endfor %}
    </div>
</div>

<!-- Section 3: Rating Analysis -->
<div class="glass-panel mb-4">
    <h2 class="text-white mb-3">Rating Analysis</h2>
    <p class="text-white-50 mb-4"><i class="fas fa-chart-bar me-2"></i>Analysis of ratings by tag and distribution.</p>

    <div class="row">
        <!-- Average Rating by Tag -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title"><i class="fas fa-star me-2"></i>Average Rating by Tag</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="avgRatingByTagChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Rating Distribution -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title"><i class="fas fa-chart-pie me-2"></i>Rating Distribution</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="ratingDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Extra charts removed to match required specification -->
</div>

<!-- Section 4: Top Rated Products by Tag -->
<div class="glass-panel mb-4">
    <h2 class="text-white mb-3">Top Rated Products by Tag</h2>
    <p class="text-white-50 mb-4">View products with highest ratings filtered by selected tag.</p>
    
    <div class="table-responsive">
        <table class="table" id="topRatedTable">
            <thead>
                <tr>
                    <th>Product ID</th>
                    <th>Product Name</th>
                    <th>Tags</th>
                    <th>Rating</th>
                    <th>Reviews</th>
                </tr>
            </thead>
            <tbody>
                <!-- The table will be populated by JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<!-- Section 5: Deep Dive -->
<div class="glass-panel mb-4">
    <h2 class="text-white mb-3">Deep Dive</h2>
    <p class="text-white-50 mb-4">Detailed analysis of product ratings and tag correlations.</p>

<!-- Top Rated Products -->
<div class="glass-panel mb-4">
    <h2 class="text-white mb-3">Top Rated Products</h2>
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Rating</th>
                    <th>Tags</th>
                    <th>Review Count</th>
                </tr>
            </thead>
            <tbody>
                {% for product in top_products %}
                <tr>
                    <td>{{ product.ProductName }}</td>
                    <td>
                        {% set rating = product.Rating|float %}
                        {% set full_stars = (rating|int) %}
                        {% set half_star = rating - full_stars >= 0.5 %}
                        {% set empty_stars = 5 - full_stars - (1 if half_star else 0) %}
                        
                        {% for i in range(full_stars) %}
                        <i class="fas fa-star text-warning"></i>
                        {% endfor %}
                        
                        {% if half_star %}
                        <i class="fas fa-star-half-alt text-warning"></i>
                        {% endif %}
                        
                        {% for i in range(empty_stars) %}
                        <i class="far fa-star text-muted"></i>
                        {% endfor %}
                        
                        {{ rating }}
                    </td>
                    <td>
                        {% for tag in product.Tags.split(',') %}
                        <span class="badge bg-info">{{ tag }}</span>
                        {% endfor %}
                    </td>
                    <td>{{ product.ReviewCount }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Tag Activity Analysis -->
<div class="glass-panel mb-4">
    <h2 class="text-white mb-3">Tag Activity Analysis</h2>
    <p class="text-white-50 mb-4">Analysis of tag activity and usage trends over time.</p>
    
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title">Tag Activity Chart</h5>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="tagActivityChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Tag Correlation Network removed to match required specification -->

</div> <!-- Close container-fluid -->

<!-- Section 5: Top Charts and Trends -->
<!-- Removed duplicate Trends & Analysis section to match the required specification -->

    <!-- All extra charts removed to match required specification -->
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js" integrity="sha512-Tn2m0TIpgVyTzzvmxLNuqbSJH3JP8jm+Cy3hvHrW7ndTDcJ1w5mBiksqDBb8GpE2ksktFvDB/ykZ0mDpsZj20w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize video background
        const videoElement = document.querySelector('.video-background video');
        if (videoElement) {
            const videoSrc = videoElement.getAttribute('data-src');
            if (videoSrc) {
                videoElement.src = videoSrc;
                videoElement.play().catch(error => {
                    console.error('Video autoplay was prevented:', error);
                    document.body.classList.add('video-fallback');
                });
            }
        }
        
        // Initialize progress bars
        const progressBars = document.querySelectorAll('.metric-progress-value');
        progressBars.forEach(bar => {
            const value = parseFloat(bar.getAttribute('data-value'));
            const maxValue = parseFloat(bar.getAttribute('data-max') || '5');
            let percent = Math.round((value / maxValue) * 100);
            // Round to nearest 10
            percent = Math.floor(percent / 10) * 10;
            // Ensure minimum 20% width for visibility
            percent = Math.max(20, percent); 
            
            // Apply the width class
            bar.classList.add('w-' + percent);
        });
        
        // Initialize filters
        const tagFilter = document.getElementById('tagFilter');
        const ratingFilter = document.getElementById('ratingFilter');
        const sortFilter = document.getElementById('sortFilter');
        
        if (tagFilter) tagFilter.addEventListener('change', filterTable);
        if (ratingFilter) ratingFilter.addEventListener('change', filterTable);
        if (sortFilter) sortFilter.addEventListener('change', filterTable);
        
        // Initialize charts
        initializeCharts();
        
        // Apply initial filters
        filterTable();
    });
    
    function initializeCharts() {
        // Average Rating by Tag Chart
        const avgRatingCtx = document.getElementById('avgRatingByTagChart')?.getContext('2d');
        if (avgRatingCtx) {
            // Safely get data from template using variables already formatted as JSON
            let tagNames = [];
            let tagRatingsData = [];
            
            try {
                tagNames = JSON.parse('{{ tag_names|default("[]") }}');
                tagRatingsData = JSON.parse('{{ tag_ratings_data|default("[]") }}');
                
                // If we have no meaningful data, use sample data for visualization
                if (tagNames.length === 0 || tagRatingsData.length === 0) {
                    tagNames = ['DJF', 'WFC', 'OBL', 'ZNV', 'YMQ', 'YGX', 'XPI', 'XNZ', 'WTD', 'VVB'];
                    tagRatingsData = [4.2, 3.8, 4.0, 3.5, 4.7, 3.9, 4.1, 3.7, 4.3, 4.5];
                }
            } catch (e) {
                console.error('Error parsing tag data:', e);
                // Fallback sample data
                tagNames = ['DJF', 'WFC', 'OBL', 'ZNV', 'YMQ', 'YGX', 'XPI', 'XNZ', 'WTD', 'VVB'];
                tagRatingsData = [4.2, 3.8, 4.0, 3.5, 4.7, 3.9, 4.1, 3.7, 4.3, 4.5];
            }
            
            // Debug output to check data format
            console.log('Tag Names:', tagNames);
            console.log('Tag Ratings Data:', tagRatingsData);
            
            new Chart(avgRatingCtx, {
                type: 'bar',
                data: {
                    labels: tagNames,
                    datasets: [{
                        label: 'Average Rating',
                        data: tagRatingsData,
                        backgroundColor: 'rgba(79, 172, 254, 0.7)',
                        borderColor: 'rgba(79, 172, 254, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: 5,
                            title: {
                                display: true,
                                text: 'Rating (0-5)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: 'rgba(255, 255, 255, 0.9)'
                            }
                        }
                    }
                }
            });
        }
        
        // Rating Distribution Chart
        const ratingDistCtx = document.getElementById('ratingDistributionChart')?.getContext('2d');
        if (ratingDistCtx) {
            let ratingDistribution = [0, 0, 0, 0, 0]; // Default empty data
            
            try {
                ratingDistribution = JSON.parse('{{ rating_distribution|default("[]") }}');
                console.log('Rating Distribution Data:', ratingDistribution);
                
                // If data is empty or invalid, use sample data
                if (!ratingDistribution || ratingDistribution.length === 0 || ratingDistribution.every(val => val === 0)) {
                    ratingDistribution = [10, 15, 8, 5, 2]; // Default data
                    console.log('Using default rating distribution data');
                }
            } catch (e) {
                console.error('Error parsing rating distribution data:', e);
                ratingDistribution = [10, 15, 8, 5, 2]; // Default fallback
            }
            
            new Chart(ratingDistCtx, {
                type: 'pie',
                data: {
                    labels: ['5 Stars', '4 Stars', '3 Stars', '2 Stars', '1 Star'],
                    datasets: [{
                        data: ratingDistribution,
                        backgroundColor: [
                            'rgba(0, 230, 118, 0.7)',
                            'rgba(79, 172, 254, 0.7)',
                            'rgba(255, 193, 7, 0.7)',
                            'rgba(255, 152, 0, 0.7)',
                            'rgba(244, 67, 54, 0.7)'
                        ],
                        borderColor: [
                            'rgba(0, 230, 118, 1)',
                            'rgba(79, 172, 254, 1)',
                            'rgba(255, 193, 7, 1)',
                            'rgba(255, 152, 0, 1)',
                            'rgba(244, 67, 54, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: 'rgba(255, 255, 255, 0.9)'
                            }
                        }
                    }
                }
            });
        }
        
        // Recommendation Strength Chart removed to match the required specification
        
        // Review Count by Rating Chart removed to match the required specification
        
        // Tag Activity Chart
        const tagActivityCtx = document.getElementById('tagActivityChart')?.getContext('2d');
        if (tagActivityCtx) {
            // Safely get tag activity data
            let popularTags = [];
            let tagActivity = [];
            
            try {
                // Use already escaped tag_names for labels instead of trying to parse popular_tags
                popularTags = JSON.parse('{{ tag_names|default("[]")|safe }}');
                tagActivity = JSON.parse('{{ tag_activity|default("[]")|safe }}');
                console.log('Tag Activity Data:', tagActivity);
            } catch (e) {
                console.error('Error parsing tag activity data:', e);
                console.log('Raw tag_activity:', '{{ tag_activity|default("[]")|safe }}');
            }
            
            new Chart(tagActivityCtx, {
                type: 'radar',
                data: {
                    labels: popularTags,
                    datasets: [{
                        label: 'Tag Activity',
                        data: tagActivity,
                        backgroundColor: 'rgba(79, 172, 254, 0.2)',
                        borderColor: 'rgba(79, 172, 254, 0.8)',
                        borderWidth: 1,
                        pointBackgroundColor: 'rgba(0, 230, 118, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: 'rgba(255, 255, 255, 0.9)'
                            }
                        }
                    }
                }
            });
        }
        
        // Tag Correlation Network Chart removed to match the required specification
        // Chart completely removed to match the specified requirements
    }
    
    function filterTable() {
        const tag = document.getElementById('tagFilter')?.value || 'all';
        const minRating = parseFloat(document.getElementById('ratingFilter')?.value || '0');
        const sortOption = document.getElementById('sortFilter')?.value || 'rating';
        
        // Apply filters to table rows
        const tableRows = document.querySelectorAll('#topRatedProductsTable tbody tr');
        let filteredRows = [];
        
        tableRows.forEach(row => {
            // Handle tags safely - they might be JSON or comma-separated
            let rowTags = [];
            const tagsAttr = row.getAttribute('data-tags');
            
            if (tagsAttr) {
                try {
                    // Try to parse as JSON if it's formatted that way
                    rowTags = JSON.parse(tagsAttr);
                } catch (e) {
                    // Otherwise split by comma
                    rowTags = tagsAttr.split(',').map(t => t.trim());
                }
            }
            
            const rowRating = parseFloat(row.getAttribute('data-rating') || '0');
            
            const tagMatch = tag === 'all' || rowTags.includes(tag);
            const ratingMatch = rowRating >= minRating;
            
            if (tagMatch && ratingMatch) {
                row.style.display = '';
                filteredRows.push(row);
            } else {
                row.style.display = 'none';
            }
        });
        
        // Sort the filtered rows based on the selected sort option
        if (filteredRows.length > 0) {
            // Sort based on the selected option
            filteredRows.sort((a, b) => {
                if (sortOption === 'name') {
                    const aName = a.getAttribute('data-name') || '';
                    const bName = b.getAttribute('data-name') || '';
                    return aName.localeCompare(bName);
                } else if (sortOption === 'rating') {
                    const aRating = parseFloat(a.getAttribute('data-rating') || '0');
                    const bRating = parseFloat(b.getAttribute('data-rating') || '0');
                    return bRating - aRating; // Higher rating first
                } else { // Default to rating
                    const aRating = parseFloat(a.getAttribute('data-rating') || '0');
                    const bRating = parseFloat(b.getAttribute('data-rating') || '0');
                    return bRating - aRating;
                }
            });
            
            // Clear the table
            const tbody = document.querySelector('#topRatedProductsTable tbody');
            if (tbody) {
                tbody.innerHTML = '';
                
                // Add the sorted rows back
                filteredRows.forEach(row => {
                    tbody.appendChild(row);
                });
                
                // Update the count
                const countElement = document.getElementById('productCount');
                if (countElement) {
                    countElement.textContent = filteredRows.length;
                }
            }
        }
    }
    
    function filterByTag(tagName) {
        const tagFilter = document.getElementById('tagFilter');
        const selectedTag = document.getElementById('selectedTag');
        
        if (tagFilter) {
            tagFilter.value = tagName || 'all';
        }
        
        if (selectedTag) {
            selectedTag.textContent = tagName || 'All';
        }
        
        filterTable();
    }
</script>

<!-- Add Font Awesome for stars -->

{% endblock %}
