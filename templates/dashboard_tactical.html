{% extends "base.html" %}

{% block title %}Tactical Dashboard{% endblock %}

{% block head %}
<style>
    /* Override base template dark background */
    html, body, .container, .container-fluid, main, .content, .content-wrapper, .dashboard-wrapper,
    .row, .col, div[class^="col-"], .card-body, .card-footer, #main-content, .page-content,
    .dashboard, section, .tab-content, .tab-pane, .section-header, .sidebar,
    .card-wrapper, .dashboard-content, .chart-container {
        background-color: transparent !important;
        background: none !important;
    }
    
    /* Prevent the body::before background overlay from base.html */
    body::before {
        background-color: transparent !important;
        background: none !important;
        content: none !important;
        display: none !important;
    }

    /* Hide the default navbar for this page only */
    nav.navbar {
        display: none !important;
    }
    
    /* Reset container margin-top to account for missing navbar */
    .container.mt-4 {
        margin-top: 0 !important;
        padding-top: 0 !important;
    }
    
    /* Video background styles */
    .video-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        overflow: hidden;
        background-color: white; /* White fallback color if video doesn't load */
    }
    
    .video-background video {
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        object-fit: cover;
        opacity: 1.0; /* Fully visible video */
    }
    
    /* Glass sidebar styles */
    .glass-sidebar {
        position: fixed;
        left: 0;
        top: 0;
        width: 280px;
        height: 100vh;
        background-color: rgba(220, 220, 220, 0.7);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border-right: 1px solid rgba(0, 0, 0, 0.15);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        padding: 20px;
        overflow-y: auto;
    }
    
    .sidebar-header {
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        padding-bottom: 15px;
        margin-bottom: 20px;
    }
    
    .sidebar-logo {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .sidebar-logo i {
        font-size: 24px;
        margin-right: 10px;
        color: #000;
    }
    
    .sidebar-logo h3 {
        color: #000 !important;
        font-size: 1.25rem;
        font-weight: 700;
        margin: 0;
        text-shadow: none;
    }
    
    .sidebar-nav {
        list-style: none;
        padding: 0;
        margin-bottom: 30px;
    }
    
    .sidebar-nav li {
        margin-bottom: 5px;
    }
    
    .sidebar-nav a {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        color: rgba(0, 0, 0, 0.8);
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.3s ease;
        font-weight: 600;
    }
    
    .sidebar-nav a:hover {
        background-color: rgba(0, 0, 0, 0.05);
        transform: translateX(5px);
    }
    
    .sidebar-nav a.active {
        background-color: rgba(0, 0, 0, 0.1);
        color: #000;
        font-weight: 700;
    }
    
    .sidebar-nav i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
    }
    
    .sidebar-divider {
        height: 1px;
        background-color: rgba(0, 0, 0, 0.1);
        margin: 15px 0;
    }
    
    .filter-section {
        padding: 0;
    }
    
    .filter-section h5 {
        color: #000 !important;
        font-size: 1rem;
        margin-bottom: 15px;
        font-weight: 700;
    }
    
    .filter-section label {
        color: rgba(0, 0, 0, 0.8) !important;
        font-size: 0.9rem;
        margin-bottom: 5px;
    }
    
    .filter-section select {
        background-color: rgba(255, 255, 255, 0.6);
        border: 1px solid rgba(0, 0, 0, 0.2);
        color: #000;
        margin-bottom: 15px;
    }
    
    .filter-section select option {
        background-color: #333;
        color: white;
    }
    
    /* Semi-transparent cards that show the video background */
    .card {
        background-color: rgba(255, 255, 255, 0.85) !important;
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.2);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        border-radius: 10px;
    }
    
    /* Content wrapper adjusted for sidebar - fully transparent */
    .content-wrapper {
        margin-left: 280px;
        width: calc(100% - 280px);
        min-height: 100vh;
        padding: 20px;
        background-color: transparent !important;
    }
    
    /* Make text dark for better readability in cards */
    .card-title, .card-text {
        color: #333 !important;
    }
    
    /* Set background color to transparent for all containers */
    html, body, .container, .container-fluid, main, .content,
    .dashboard-wrapper, .row, .col, div[class^="col-"], #main-content,
    .page-content, .dashboard, section, .tab-content, .tab-pane {
        background-color: transparent !important;
    }
    
    /* Table styling with semi-transparent background */
    table, thead, tbody, tr {
        background-color: rgba(255, 255, 255, 0.7) !important;
    }
    
    th, td {
        background-color: transparent !important;
        color: #333 !important;
    }
    
    /* Style for badges to ensure visibility */
    .badge {
        font-weight: 600;
    }
    
    /* Keep some specific styling */
    .product-card {
        border-left: 4px solid transparent;
    }
    
    .expire-soon {
        border-left-color: #dc3545;
    }
    
    .expire-warning {
        border-left-color: #ffc107;
    }
    
    .expire-ok {
        border-left-color: #198754;
    }
    
    .stock-low {
        background-color: rgba(220, 53, 69, 0.1);
    }
    
    .section-header {
        background-color: transparent !important;
        border-left: 4px solid #0d6efd;
        padding: 10px 15px;
        margin-bottom: 20px;
    }
    
    /* Page title styling */
    h1.mb-4 {
        color: #fff !important;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        margin-top: 1rem;
    }
    
    /* Mobile responsiveness */
    @media (max-width: 992px) {
        .glass-sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .glass-sidebar.show {
            transform: translateX(0);
        }
        
        .content-wrapper {
            margin-left: 0;
            width: 100%;
        }
        
        .sidebar-toggle {
            display: block;
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1100;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
        }
    }
    
    @media (min-width: 993px) {
        .sidebar-toggle {
            display: none;
        }
    }
</style>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

<!-- Chart.js Matrix Plugin -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.1.1/dist/chartjs-chart-matrix.min.js"></script>
{% endblock %}

{% block content %}
<!-- Video Background -->
<div class="video-background">
    <video autoplay muted loop playsinline>
        <source src="{{ url_for('static', filename='videos/statistical-graph-with-business-finance-concept-3d-rendering-video.mp4') }}" type="video/mp4">
        Your browser does not support the video tag.
    </video>
</div>

<!-- Mobile sidebar toggle button -->
<button class="sidebar-toggle btn" id="sidebarToggle">
    <i class="fas fa-bars"></i>
</button>

<!-- Glass Sidebar -->
<div class="glass-sidebar" id="glassSidebar">
    <div class="sidebar-header">
        <div class="sidebar-logo">
            <i class="fas fa-chart-line"></i>
            <h3>Stock Management</h3>
        </div>
    </div>
    
    <!-- Navigation Links -->
    <ul class="sidebar-nav">
        <li>
            <a href="/">
                <i class="fas fa-home"></i> Home
            </a>
        </li>
        <li>
            <a href="/dashboard/strategic">
                <i class="fas fa-chess"></i> Strategic Dashboard
            </a>
        </li>
        <li>
            <a href="/dashboard/tactical" class="active">
                <i class="fas fa-tasks"></i> Tactical Dashboard
            </a>
        </li>
        <li>
            <a href="/dashboard/analytical">
                <i class="fas fa-chart-bar"></i> Analytical Dashboard
            </a>
        </li>
    </ul>
    
    <div class="sidebar-divider"></div>
    
    <!-- Filters Section -->
    <div class="filter-section">
        <h5><i class="fas fa-filter me-2"></i>Filters</h5>
        
        <label for="categoryFilter" class="form-label">Product Category</label>
        <select class="form-select" id="categoryFilter">
            <option value="all">All Categories</option>
            {% for category in categories %}
            <option value="{{ category.CategoryName }}">{{ category.CategoryName }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<!-- Main Content - completely transparent -->
<div class="content-wrapper" style="background: transparent !important; background-color: transparent !important;">
    <h1 class="mb-4">Tactical Dashboard â€” Shipment Optimization</h1>


<!-- Section 1: Context -->
<style>
    /* Circular progress indicator styles */
    /* Individual circular indicators will float on their own */
    
    .circular-indicator {
        position: relative;
        width: 180px;
        height: 180px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        filter: drop-shadow(0px 5px 15px rgba(0, 0, 0, 0.1));
    }
    
    .circle-bg {
        position: absolute;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        border: 1px solid rgba(0, 0, 0, 0.1);
        z-index: 1;
    }
    
    .circle-progress {
        position: absolute;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        z-index: 0;
    }
    
    .circle-content {
        z-index: 2;
        text-align: center;
    }
    
    .circle-value {
        font-size: 24px;
        font-weight: 700;
        color: #000;
        margin-bottom: 5px;
        text-shadow: none;
    }
    
    .circle-title {
        font-size: 12px;
        color: rgba(0, 0, 0, 0.9);
        text-align: center;
        font-weight: 600;
        max-width: 120px;
        text-shadow: none;
    }
    
    .blue-progress .circle-progress { background: conic-gradient(#1a73e8 0%, #1a73e8 calc(var(--progress) * 1%), rgba(0,0,0,0.07) calc(var(--progress) * 1%), rgba(0,0,0,0.07) 100%); }
    .blue-progress .circle-bg { border: 3px solid rgba(26, 115, 232, 0.3); }
    
    .green-progress .circle-progress { background: conic-gradient(#34a853 0%, #34a853 calc(var(--progress) * 1%), rgba(0,0,0,0.07) calc(var(--progress) * 1%), rgba(0,0,0,0.07) 100%); }
    .green-progress .circle-bg { border: 3px solid rgba(52, 168, 83, 0.3); }
    
    .orange-progress .circle-progress { background: conic-gradient(#f9ab00 0%, #f9ab00 calc(var(--progress) * 1%), rgba(0,0,0,0.07) calc(var(--progress) * 1%), rgba(0,0,0,0.07) 100%); }
    .orange-progress .circle-bg { border: 3px solid rgba(249, 171, 0, 0.3); }
    
    .purple-progress .circle-progress { background: conic-gradient(#8b46ff 0%, #8b46ff calc(var(--progress) * 1%), rgba(0,0,0,0.07) calc(var(--progress) * 1%), rgba(0,0,0,0.07) 100%); }
    .purple-progress .circle-bg { border: 3px solid rgba(139, 70, 255, 0.3); }
    
    .red-progress .circle-progress { background: conic-gradient(#ea4335 0%, #ea4335 calc(var(--progress) * 1%), rgba(0,0,0,0.07) calc(var(--progress) * 1%), rgba(0,0,0,0.07) 100%); }
    .red-progress .circle-bg { border: 3px solid rgba(234, 67, 53, 0.3); }
</style>

<!-- Removed heading per user request -->

<style>
    /* Glassmorphic container styling with gradient */
    .glassmorphic-container {
        background: linear-gradient(135deg, rgba(60, 60, 60, 0.4), rgba(140, 140, 140, 0.6)) !important;
        backdrop-filter: blur(10px) !important;
        -webkit-backdrop-filter: blur(10px) !important;
        border-radius: 15px !important;
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2) !important;
        padding: 25px !important;
        margin: 30px auto !important;
        max-width: 95% !important;
    }
    
    .context-section {
        width: 90%;
    }
    
    /* Metrics row layout */
    .metrics-row {
        display: flex;
        justify-content: space-around;
        flex-wrap: nowrap;
        width: 100%;
        overflow-x: auto;
        padding: 10px 0;
    }
    
    .metrics-row::-webkit-scrollbar {
        height: 5px;
    }
    
    .metrics-row::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
    }
    
    .metric-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 10px;
        min-width: 160px;
    }
    
    .metric-title {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 20px;
        color: black;
    }
    
    .circle-indicator {
        width: 140px;
        height: 140px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        background: white;
        box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        margin-bottom: 15px;
    }
    
    .circle-value {
        font-size: 28px;
        font-weight: 700;
        color: #000;
    }
    
    /* Distinct colored borders */
    .blue-indicator {
        border: 12px solid #1a73e8;
    }
    
    .green-indicator {
        border: 12px solid #34a853;
    }
    
    .red-indicator {
        border: 12px solid #ea4335;
    }
    
    .orange-indicator {
        border: 12px solid #f9ab00;
    }
    
    .purple-indicator {
        border: 12px solid #8b46ff;
    }
    
    /* Chart Grid Layout */
    .style .chart-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        grid-gap: 20px;
        width: 100%;
        max-width: 100%;
        padding: 10px;
    }
    
    @media (max-width: 1200px) {
        .style .chart-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .chart-container {
        position: relative;
        padding: 15px;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(5px);
        border-radius: 15px;
        padding: 15px;
        width: 100%;
        margin-bottom: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    .chart-title {
        color: black;
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 10px;
        text-align: center;
    }
    
    .chart-area {
        width: 100%;
        height: 350px; /* Shorter height but wider width */
        position: relative;
    }
    
    /* Responsive layout for smaller screens */
    @media (max-width: 992px) {
        .chart-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="glassmorphic-container context-section">
    <div class="metrics-row">
        <!-- Total Products -->
        <div class="metric-card">
            <div class="metric-title">Total Products</div>
            <div class="circle-indicator blue-indicator">
                <div class="circle-value">{{ total_products|default(0) }}</div>
            </div>
        </div>
        
        <!-- Average Stock Level -->
        <div class="metric-card">
            <div class="metric-title">Average Stock</div>
            <div class="circle-indicator green-indicator">
                <div class="circle-value">{{ avg_stock|default(0)|round(1) }}</div>
            </div>
        </div>
        
        <!-- Near Expiry Products -->
        <div class="metric-card">
            <div class="metric-title">Near Expiry</div>
            <div class="circle-indicator red-indicator">
                <div class="circle-value">{{ near_expiry_count|default(0) }}</div>
            </div>
        </div>
        
        <!-- Average Price -->
        <div class="metric-card">
            <div class="metric-title">Average Price</div>
            <div class="circle-indicator orange-indicator">
                <div class="circle-value">${{ avg_price|default(0)|round(2) }}</div>
            </div>
        </div>
        
        <!-- Top Category -->
        <div class="metric-card">
            <div class="metric-title">Top Category</div>
            <div class="circle-indicator purple-indicator">
                <div class="circle-value" style="font-size: 18px;">{{ top_category_name|default('None') }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Chart Container Row - 2x2 Grid -->
<div class="chart-grid">
    <!-- Chart 1: Stock Availability Matrix (Heatmap) -->
    <div class="glassmorphic-container chart-container">
        <h4 class="chart-title">Stock Availability Matrix</h4>
        <div class="chart-area">
            <canvas id="stockHeatmap"></canvas>
            <div class="chart-loading">Loading data...</div>
        </div>
    </div>
    
    <!-- Chart 2: Expiring Products Over Time (Area Chart) -->
    <div class="glassmorphic-container chart-container">
        <h4 class="chart-title">Expiring Products Over Time</h4>
        <div class="chart-area">
            <canvas id="expiringProductsChart"></canvas>
            <div class="chart-loading">Loading data...</div>
        </div>
    </div>
    
    <!-- Chart 3: Low Stock Warnings (Bubble Chart) -->
    <div class="glassmorphic-container chart-container">
        <h4 class="chart-title">Low Stock Warnings</h4>
        <div class="chart-area">
            <canvas id="lowStockBubbleChart"></canvas>
            <div class="chart-loading">Loading data...</div>
        </div>
    </div>
    
    <!-- Chart 4: Stock Utilization Ratio by Tag (Donut Chart) -->
    <div class="glassmorphic-container chart-container">
        <h4 class="chart-title">Stock Utilization Ratio by Tag</h4>
        <div class="chart-area">
            <canvas id="stockUtilizationChart"></canvas>
            <div class="chart-loading">Loading data...</div>
        </div>
    </div>
</div>
</div> <!-- Close the content-wrapper div -->
{% endblock %}

{% block scripts %}
<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Chart.js Heatmap plugin (for matrix chart) -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.2.0/dist/chartjs-chart-matrix.min.js"></script>

<script type="text/javascript">
// Remove all dark backgrounds immediately on page load
document.addEventListener('DOMContentLoaded', function() {
    // Force transparent background on all elements
    document.body.style.backgroundColor = 'transparent';
    document.documentElement.style.backgroundColor = 'transparent';
    document.body.style.background = 'none';
    document.documentElement.style.background = 'none';

    // Remove all background colors
    const allElements = document.querySelectorAll('*');
    allElements.forEach(el => {
        if (el.classList.contains('video-background') || 
            el.classList.contains('glass-sidebar') || 
            el.classList.contains('circular-indicator') ||
            el.classList.contains('circle-bg')) {
            // Keep these elements' backgrounds
            return;
        }
        el.style.setProperty('background-color', 'transparent', 'important');
        el.style.setProperty('background', 'none', 'important');
    });

    // Make the content wrapper completely transparent
    const contentWrapper = document.querySelector('.content-wrapper');
    if (contentWrapper) {
        contentWrapper.style.setProperty('background-color', 'transparent', 'important');
        contentWrapper.style.setProperty('background', 'none', 'important');
    }
});

// Filter products table by category
document.getElementById('categoryFilter').addEventListener('change', function() {
    const category = this.value;
    document.querySelectorAll('.product-row').forEach(row => {
        const rowCategory = row.getAttribute('data-category');
        if (category === 'all' || rowCategory === category) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Mobile sidebar toggle functionality
const sidebarToggle = document.getElementById('sidebarToggle');
const glassSidebar = document.getElementById('glassSidebar');

if (sidebarToggle && glassSidebar) {
    sidebarToggle.addEventListener('click', function() {
        glassSidebar.classList.toggle('show-sidebar');
    });
}

// Debug function to log details about chart data and rendering process
function debugLog(message, data) {
    console.log('DEBUG: ' + message, data);
}

// Add CSS for loading indicators
document.head.insertAdjacentHTML('beforeend', `
    <style>
        .chart-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(0, 0, 0, 0.7);
            font-size: 16px;
            z-index: 5;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 10px 20px;
            border-radius: 5px;
        }
    </style>
`);

// Initialize Chart.js plugins
document.addEventListener('DOMContentLoaded', function() {
    debugLog('DOM loaded, initializing charts');
    
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded! Adding script dynamically.');
        
        // Dynamically add Chart.js if missing
        const chartScript = document.createElement('script');
        chartScript.src = 'https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js';
        document.head.appendChild(chartScript);
        
        const matrixScript = document.createElement('script');
        matrixScript.src = 'https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.1.1/dist/chartjs-chart-matrix.min.js';
        document.head.appendChild(matrixScript);
        
        // Wait for scripts to load
        setTimeout(() => {
            debugLog('Dynamically loaded Chart.js, initializing charts now');
            // Fetch and create all charts
            fetchStockMatrixData();
            fetchExpiringProductsData();
            fetchLowStockData();
            fetchStockUtilizationData();
        }, 1000);
    } else {
        debugLog('Chart.js found, initializing charts');
        // Fetch and create all charts
        fetchStockMatrixData();
        fetchExpiringProductsData();
        fetchLowStockData();
        fetchStockUtilizationData();
    }
});


// Error handler for chart data fetching
function handleChartError(chartId, error) {
    console.error(`Error loading data for ${chartId}:`, error);
    const loadingElement = document.querySelector(`#${chartId}`).closest('.chart-area').querySelector('.chart-loading');
    if (loadingElement) {
        loadingElement.innerHTML = 'Failed to load data. Please refresh the page.<br><small>' + error.message + '</small>';
        loadingElement.style.backgroundColor = 'rgba(234, 67, 53, 0.7)';
    }
}

// 1. Fetch data for Stock Availability Matrix (Heatmap)
function fetchStockMatrixData() {
    debugLog('Fetching stock matrix data');
    console.log('Fetching stock matrix data from API...');
    fetch('/api/stock_availability_matrix')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            debugLog('Stock matrix data received:', data);
            // Log complete data structure for debugging
            console.log('Stock matrix API full data:', data);
            // Show that the chart container exists
            console.log('Chart container exists:', document.getElementById('stockHeatmap') !== null);
            try {
                // Pass the entire data object which contains data, categories, regions
                createStockMatrix(data);
            } catch (err) {
                console.error('Error creating stock matrix chart:', err);
                console.error('Error details:', err.message);
                console.error('Stack trace:', err.stack);
            }
        })
        .catch(error => {
            console.error('Failed to fetch matrix data:', error);
            handleChartError('stockHeatmap', error);
        });
}

// Create the Stock Availability Matrix chart
function createStockMatrix(apiData) {
    debugLog('Creating stock matrix chart with data', apiData);
    const canvas = document.getElementById('stockHeatmap');
    if (!canvas) {
        console.error('Cannot find canvas element #stockHeatmap');
        return;
    }
    const ctx = canvas.getContext('2d');
    
    // Clear any existing chart
    if (window.stockMatrixChart instanceof Chart) {
        window.stockMatrixChart.destroy();
    }
    
    createMatrixChart(ctx, apiData);
}

function createMatrixChart(ctx, apiData) {
    console.log('Creating matrix chart with data:', apiData);
    // Extract categories, regions, and data from the API response
    let categories = [];
    let regions = [];
    let data = [];
    
    // Check if apiData has the expected structure
    if (apiData && apiData.categories) {
        categories = apiData.categories;
        regions = apiData.regions;
        
        // Process data items
        if (apiData.data && Array.isArray(apiData.data)) {
            apiData.data.forEach(item => {
                const categoryIndex = categories.indexOf(item.category);
                const regionIndex = regions.indexOf(item.region);
                
                if (categoryIndex !== -1 && regionIndex !== -1) {
                    // Use 'value' field from API (which is StockPercentage) 
                    const availability = parseFloat(item.value);
                    let color;
                    
                    // Color based on availability percentage
                    if (availability >= 80) {
                        color = 'rgba(52, 168, 83, 0.8)'; // Green for high availability
                    } else if (availability >= 50) {
                        color = 'rgba(249, 171, 0, 0.8)'; // Yellow for medium availability
                    } else if (availability >= 20) {
                        color = 'rgba(234, 67, 53, 0.8)'; // Red for low availability
                    } else {
                        color = 'rgba(0, 0, 0, 0.8)'; // Black for very low or out of stock
                    }
                    
                    data.push({
                        x: regionIndex,
                        y: categoryIndex,
                        v: availability,
                        color: color
                    });
                }
            });
        }
    }
    
    // Use sample data if no data points were generated
    if (data.length === 0) {
        console.warn('No data for stock matrix, using sample data');
        categories = ['Electronics', 'Clothing', 'Home', 'Sports'];
        regions = ['North', 'South', 'East', 'West'];
        
        // Generate random sample data
        for (let i = 0; i < categories.length; i++) {
            for (let j = 0; j < regions.length; j++) {
                const availability = Math.floor(Math.random() * 100);
                let color;
                
                if (availability >= 80) {
                    color = 'rgba(52, 168, 83, 0.8)';
                } else if (availability >= 50) {
                    color = 'rgba(249, 171, 0, 0.8)';
                } else if (availability >= 20) {
                    color = 'rgba(234, 67, 53, 0.8)';
                } else {
                    color = 'rgba(0, 0, 0, 0.8)';
                }
                
                data.push({
                    x: j,
                    y: i,
                    v: availability,
                    color: color
                });
            }
        }
    }
    
    // Create new matrix chart instance
    window.stockMatrixChart = new Chart(ctx, {
        type: 'matrix',
        data: {
            datasets: [{
                label: 'Stock Availability',
                data: data,
                backgroundColor: function(ctx) { 
                    return ctx.dataset.data[ctx.dataIndex].color;
                },
                borderColor: 'rgba(255, 255, 255, 0.8)',
                borderWidth: 1,
                width: function(ctx) {
                    // Check if chartArea is defined to avoid error
                    if (!ctx.chart.chartArea) {
                        return 20; // Default width if chart area not yet available
                    }
                    const a = ctx.chart.chartArea.right - ctx.chart.chartArea.left;
                    return Math.max(0, (a / Math.max(1, regions.length)) - 2);
                },
                height: function(ctx) {
                    // Check if chartArea is defined to avoid error
                    if (!ctx.chart.chartArea) {
                        return 20; // Default height if chart area not yet available
                    }
                    const a = ctx.chart.chartArea.bottom - ctx.chart.chartArea.top;
                    return Math.max(0, (a / Math.max(1, categories.length)) - 2);
                }
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        title: function() { return ''; },
                        label: function(ctx) {
                            const value = ctx.dataset.data[ctx.dataIndex].v;
                            const category = categories[ctx.dataset.data[ctx.dataIndex].y];
                            const region = regions[ctx.dataset.data[ctx.dataIndex].x];
                            return [`Category: ${category}`, `Region: ${region}`, `Stock Level: ${value}%`];
                        }
                    }
                },
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    type: 'category',
                    labels: regions,
                    ticks: {
                        color: 'black'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                y: {
                    type: 'category',
                    labels: categories,
                    offset: true,
                    ticks: {
                        color: 'black'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                }
            }
        }
    });
    
    // Use sample data if no data points were generated
    if (data.length === 0) {
        console.warn('No data for stock matrix, using sample data');
        categories = ['Electronics', 'Clothing', 'Home', 'Sports'];
        regions = ['North', 'South', 'East', 'West'];
        
        // Generate random sample data
        for (let i = 0; i < categories.length; i++) {
            for (let j = 0; j < regions.length; j++) {
                const availability = Math.floor(Math.random() * 100);
                let color;
                
                if (availability >= 80) {
                    color = 'rgba(52, 168, 83, 0.8)';
                } else if (availability >= 50) {
                    color = 'rgba(249, 171, 0, 0.8)';
                } else if (availability >= 20) {
                    color = 'rgba(234, 67, 53, 0.8)';
                } else {
                    color = 'rgba(0, 0, 0, 0.8)';
                }
                
                data.push({
                    x: j,
                    y: i,
                    v: availability,
                    color: color
                });
            }
        }
    }
    
    // The chart has already been created and stored in window.stockMatrixChart at line ~935
    // Removing duplicate chart creation to fix rendering issues
}

// 2. Fetch data for Expiring Products Over Time (Area Chart)
function fetchExpiringProductsData() {
    debugLog('Fetching expiring products data');
    fetch('/api/expiring_products_trend')
        .then(response => {
            debugLog('Expiring products API response status:', response.status);
            if (!response.ok) {
                throw new Error(`Network response error: ${response.status}`);
            }
            return response.json().catch(err => {
                throw new Error('Failed to parse JSON response: ' + err.message);
            });
        })
        .then(data => {
            debugLog('Expiring products data received:', data);
            // Hide loading indicator
            const loadingElement = document.querySelector('#expiringProductsChart').closest('.chart-area').querySelector('.chart-loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
            try {
                createExpiringProductsChart(data);
            } catch (err) {
                throw new Error('Error creating area chart: ' + err.message);
            }
        })
        .catch(error => handleChartError('expiringProductsChart', error));
}

// Create the Expiring Products Over Time chart
function createExpiringProductsChart(apiData) {
    debugLog('Creating expiring products chart with data', apiData);
    const canvas = document.getElementById('expiringProductsChart');
    if (!canvas) {
        console.error('Cannot find canvas element #expiringProductsChart');
        return;
    }
    const ctx = canvas.getContext('2d');
    

    
    let months = [];
    let expiringProducts = [];
    
    if (apiData && Array.isArray(apiData)) {
        // Extract month labels and counts from API data
        apiData.forEach(item => {
            if (item.Month) {
                months.push(item.Month);
            }
            
            // Use the ExpCount property or fallback to ProductCount
            if (item.hasOwnProperty('ExpCount')) {
                expiringProducts.push(item.ExpCount);
            } else if (item.hasOwnProperty('ProductCount')) {
                expiringProducts.push(item.ProductCount);
            }
        });
    }
    
    // Fallback if no data
    if (months.length === 0) {
        months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    }
    
    if (expiringProducts.length === 0) {
        expiringProducts = [5, 8, 12, 15, 20, 25, 18, 22, 30, 25, 22, 18];
    }
    
    debugLog('Months:', months);
    debugLog('Expiring Products Data:', expiringProducts);
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: [{
                label: 'Expiring Products',
                data: expiringProducts,
                fill: true,
                backgroundColor: 'rgba(234, 67, 53, 0.2)',
                borderColor: 'rgba(234, 67, 53, 1)',
                borderWidth: 3,
                pointBackgroundColor: 'rgba(234, 67, 53, 1)',
                pointBorderColor: '#fff',
                pointRadius: 5,
                pointHoverRadius: 8,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: 'black'
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: 'black'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: 'black'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    title: {
                        display: true,
                        text: 'Number of Products',
                        color: 'black'
                    }
                }
            }
        }
    });
}

// 3. Fetch data for Low Stock Warnings (Bubble Chart)
function fetchLowStockData() {
    debugLog('Fetching low stock data');
    fetch('/api/low_stock_warnings')
        .then(response => {
            debugLog('Low stock API response status:', response.status);
            if (!response.ok) {
                throw new Error(`Network response error: ${response.status}`);
            }
            return response.json().catch(err => {
                throw new Error('Failed to parse JSON response: ' + err.message);
            });
        })
        .then(data => {
            debugLog('Low stock data received:', data);
            // Hide loading indicator
            const loadingElement = document.querySelector('#lowStockBubbleChart').closest('.chart-area').querySelector('.chart-loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
            try {
                createLowStockBubbleChart(data);
            } catch (err) {
                throw new Error('Error creating bubble chart: ' + err.message);
            }
        })
        .catch(error => handleChartError('lowStockBubbleChart', error));
}

// Create the Low Stock Warnings chart
function createLowStockBubbleChart(apiData) {
    debugLog('Creating low stock bubble chart with data', apiData);
    const canvas = document.getElementById('lowStockBubbleChart');
    if (!canvas) {
        console.error('Cannot find canvas element #lowStockBubbleChart');
        return;
    }
    const ctx = canvas.getContext('2d');
    

    
    let bubbleData = [];
    
    if (apiData && Array.isArray(apiData)) {
        // Transform API data into bubble chart format
        bubbleData = apiData.map(item => {
            // Calculate bubble size based on CategoryCount (or use default value)
            const bubbleSize = item.CategoryCount ? Math.min(Math.max(item.CategoryCount * 2, 5), 30) : 10;
            
            return {
                x: item.StockQuantity || 0,  // Stock quantity for x-axis
                y: item.Rating || 3.5,      // Product rating for y-axis (default to 3.5 if missing)
                r: bubbleSize,               // Bubble size represents category count
                label: item.ProductName || 'Unknown Product'
            };
        });
    }
    
    // Fallback if no data
    if (bubbleData.length === 0) {
        debugLog('Using fallback sample data for bubble chart');
        bubbleData = [
            { x: 10, y: 4.5, r: 15, label: 'Product A' },
            { x: 15, y: 3.8, r: 8, label: 'Product B' },
            { x: 8, y: 4.2, r: 20, label: 'Product C' },
            { x: 5, y: 4.9, r: 10, label: 'Product D' },
            { x: 20, y: 3.5, r: 15, label: 'Product E' },
            { x: 3, y: 4.8, r: 25, label: 'Product F' },
            { x: 12, y: 4.1, r: 12, label: 'Product G' }
        ];
    }
    
    debugLog('Processed bubble data:', bubbleData);
    
    new Chart(ctx, {
        type: 'bubble',
        data: {
            datasets: [{
                label: 'Low Stock Products',
                centerText: bubbleData.map(d => d.label),
                data: bubbleData.map(item => ({ 
                    x: item.x, 
                    y: item.y, 
                    r: item.r
                })),
                backgroundColor: 'rgba(249, 171, 0, 0.7)',
                borderColor: 'rgba(249, 171, 0, 1)',
                borderWidth: 2,
                hoverBackgroundColor: 'rgba(249, 171, 0, 0.9)',
                hoverBorderWidth: 3,
                hoverBorderColor: 'white'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const dataPoint = bubbleData[context.dataIndex];
                            return dataPoint.label + ' - Stock: ' + dataPoint.x;
                        }
                    }
                }
            },
            scales: {
                x: {
                    min: 0,
                    max: 25,
                    title: {
                        display: true,
                        text: 'Stock Quantity',
                        color: 'black'
                    },
                    ticks: {
                        color: 'black'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                y: {
                    min: 3,
                    max: 5,
                    title: {
                        display: true,
                        text: 'Rating',
                        color: 'black'
                    },
                    ticks: {
                        color: 'black'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                }
            }
        }
    });
}

// 4. Fetch data for Stock Utilization Ratio by Tag (Donut Chart)
function fetchStockUtilizationData() {
    debugLog('Fetching stock utilization data');
    fetch('/api/stock_utilization_ratio')
        .then(response => {
            debugLog('Stock utilization API response status:', response.status);
            if (!response.ok) {
                throw new Error(`Network response error: ${response.status}`);
            }
            return response.json().catch(err => {
                throw new Error('Failed to parse JSON response: ' + err.message);
            });
        })
        .then(data => {
            debugLog('Stock utilization data received:', data);
            // Hide loading indicator
            const loadingElement = document.querySelector('#stockUtilizationChart').closest('.chart-area').querySelector('.chart-loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
            try {
                createStockUtilizationChart(data);
            } catch (err) {
                throw new Error('Error creating donut chart: ' + err.message);
            }
        })
        .catch(error => handleChartError('stockUtilizationChart', error));
}

// Create the Stock Utilization Ratio by Tag chart
function createStockUtilizationChart(apiData) {
    debugLog('Creating stock utilization chart with data', apiData);
    const canvas = document.getElementById('stockUtilizationChart');
    if (!canvas) {
        console.error('Cannot find canvas element #stockUtilizationChart');
        return;
    }
    const ctx = canvas.getContext('2d');
    

    
    let labels = [];
    let data = [];
    
    if (apiData && Array.isArray(apiData)) {
        // Extract labels and values from API data
        apiData.forEach(item => {
            // Use Tag or ProductTag as the label
            if (item.Tag) {
                labels.push(item.Tag);
            } else if (item.ProductTag) {
                labels.push(item.ProductTag);
            }
            
            // Use UtilizationRatio or Percentage for the data
            if (item.hasOwnProperty('UtilizationRatio')) {
                data.push(item.UtilizationRatio);
            } else if (item.hasOwnProperty('Percentage')) {
                data.push(item.Percentage);
            } else if (item.hasOwnProperty('StockQuantity')) {
                data.push(item.StockQuantity);
            }
        });
    }
    
    // Fallback if no data
    if (labels.length === 0) {
        labels = ['Perishable', 'Non-perishable', 'Fragile', 'Heavy', 'Electronics'];
    }
    
    if (data.length === 0) {
        data = [30, 25, 15, 20, 10];
    }
    
    debugLog('Chart labels:', labels);
    debugLog('Chart data:', data);  // Utilization percentages
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: [
                    'rgba(26, 115, 232, 0.8)',
                    'rgba(52, 168, 83, 0.8)',
                    'rgba(249, 171, 0, 0.8)',
                    'rgba(234, 67, 53, 0.8)',
                    'rgba(139, 70, 255, 0.8)'
                ],
                borderColor: 'rgba(255, 255, 255, 0.9)',
                borderWidth: 3,
                hoverOffset: 15,
                hoverBorderWidth: 4,
                hoverBorderColor: 'white'
            }],
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        color: 'black'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${context.parsed}% utilized`;
                        }
                    }
                }
            },
            cutout: '65%',
            animation: {
                animateScale: true
            }
        }
    });
}

    // Close sidebar when clicking outside of it (only on mobile)
    document.addEventListener('click', function(event) {
        const isMobile = window.innerWidth < 993;
        const clickedInsideSidebar = glassSidebar.contains(event.target);
        const clickedOnToggle = sidebarToggle.contains(event.target);
        
        if (isMobile && !clickedInsideSidebar && !clickedOnToggle && glassSidebar.classList.contains('show-sidebar')) {
            glassSidebar.classList.remove('show-sidebar');
        }
    });
</script>
{% endblock %}
