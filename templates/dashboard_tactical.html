{% extends "base.html" %}

{% block title %}Tactical Dashboard{% endblock %}

{% block head %}
<style>
    /* Override base template dark background */
    html, body, .container, .container-fluid, main, .content, .content-wrapper, .dashboard-wrapper,
    .row, .col, div[class^="col-"], .card-body, .card-footer, #main-content, .page-content,
    .dashboard, section, .tab-content, .tab-pane, .section-header, .sidebar,
    .card-wrapper, .dashboard-content, .chart-container {
        background-color: transparent !important;
        background: none !important;
    }
    
    /* Prevent the body::before background overlay from base.html */
    body::before {
        background-color: transparent !important;
        background: none !important;
        content: none !important;
        display: none !important;
    }

    /* Hide the default navbar for this page only */
    nav.navbar {
        display: none !important;
    }
    
    /* Reset container margin-top to account for missing navbar */
    .container.mt-4 {
        margin-top: 0 !important;
        padding-top: 0 !important;
        margin-left: 0 !important;
        padding-left: 0 !important;
        max-width: 100% !important;
        width: 100% !important;
    }
    
    body {
        margin: 0 !important;
        padding: 0 !important;
        overflow-x: hidden;
    }
    
    /* Video background styles */
    .video-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        overflow: hidden;
        background-color: white; /* White fallback color if video doesn't load */
        margin: 0;
        padding: 0;
    }
    
    .video-background video {
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        object-fit: cover;
        opacity: 1.0; /* Fully visible video */
    }
    
    /* Glass sidebar styles */
    .glass-sidebar {
        position: fixed;
        left: 0;
        top: 0;
        width: 290px;
        height: 100vh;
        background: linear-gradient(135deg, rgba(21, 21, 40, 0.7), rgba(31, 31, 60, 0.75)) !important;
        backdrop-filter: blur(20px) !important;
        -webkit-backdrop-filter: blur(20px) !important;
        border: none;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        border-right: 1px solid rgba(255, 255, 255, 0.08);
        z-index: 1000;
        padding: 25px;
        overflow-y: auto;
        margin: 0;
    }
    
    .sidebar-header {
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        padding-bottom: 15px;
        margin-bottom: 20px;
    }
    
    .sidebar-logo {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .sidebar-logo i {
        font-size: 24px;
        margin-right: 10px;
        color: #fff;
    }
    
    .sidebar-logo h3 {
        color: #fff !important;
        font-size: 1.25rem;
        font-weight: 700;
        margin: 0;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    
    .sidebar-nav {
        list-style: none;
        padding: 0;
        margin-bottom: 30px;
    }
    
    .sidebar-nav li {
        margin-bottom: 5px;
    }
    
    .sidebar-nav a {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        color: rgba(255, 255, 255, 0.85);
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.3s ease;
        font-weight: 600;
    }
    
    .sidebar-nav a:hover {
        background-color: rgba(255, 255, 255, 0.15);
        transform: translateX(5px);
    }
    
    .sidebar-nav a.active {
        background-color: rgba(255, 255, 255, 0.2);
        color: #fff;
        font-weight: 700;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    
    .sidebar-nav i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
    }
    
    .sidebar-divider {
        height: 1px;
        background-color: rgba(255, 255, 255, 0.2);
        margin: 15px 0;
    }
    
    .filter-section {
        padding: 0;
    }
    
    .filter-section h5 {
        color: #fff !important;
        font-size: 1rem;
        margin-bottom: 15px;
        font-weight: 700;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    
    .filter-section label {
        color: rgba(255, 255, 255, 0.9) !important;
        font-size: 0.9rem;
        margin-bottom: 5px;
    }
    
    .filter-section select {
        background-color: rgba(255, 255, 255, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: #fff;
        margin-bottom: 15px;
    }
    
    .filter-section select option {
        background-color: #333;
        color: white;
    }
    
    /* Semi-transparent cards that show the video background */
    .card {
        background-color: rgba(255, 255, 255, 0.85) !important;
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.2);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        border-radius: 10px;
    }
    
    /* Content wrapper adjusted for sidebar - fully transparent - exactly like strategic */
    .content-wrapper {
        margin-left: 290px; 
        width: calc(100% - 290px); 
        background: transparent !important; 
        padding: 20px 20px 20px 40px; 
        position: absolute; 
        top: 0; 
        right: 0; 
        z-index: 1;
        overflow-x: hidden;
        min-height: 100vh;
    }
    
    /* Make text dark for better readability in cards */
    .card-title, .card-text {
        color: #333 !important;
    }
    
    /* Set background color to transparent for all containers */
    html, body, .container, .container-fluid, main, .content,
    .dashboard-wrapper, .row, .col, div[class^="col-"], #main-content,
    .page-content, .dashboard, section, .tab-content, .tab-pane {
        background-color: transparent !important;
    }
    
    /* Table styling with glassmorphic theme */
    table, thead, tbody, tr {
        background-color: transparent !important;
    }
    
    th, td {
        background-color: transparent !important;
        color: white !important;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    
    /* Low stock table glassmorphic style */
    .low-stock-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 5px;
    }
    
    .low-stock-table thead th {
        background: linear-gradient(135deg, rgba(40, 60, 100, 0.45), rgba(50, 70, 120, 0.5)) !important;
        backdrop-filter: blur(15px) !important;
        -webkit-backdrop-filter: blur(15px) !important;
        padding: 12px 15px;
        font-weight: 600;
        color: white !important;
        border-bottom: 1px solid rgba(100, 150, 220, 0.15);
        text-align: left;
    }
    
    .low-stock-table tbody tr {
        background: linear-gradient(135deg, rgba(40, 60, 100, 0.35), rgba(50, 70, 120, 0.4)) !important;
        backdrop-filter: blur(15px) !important;
        -webkit-backdrop-filter: blur(15px) !important;
        border-radius: 8px;
        margin-bottom: 8px;
        box-shadow: 0 4px 16px rgba(20, 40, 80, 0.2);
    }
    
    .low-stock-table tbody td {
        padding: 12px 15px;
        color: white !important;
        border: none;
    }
    
    /* Style for badges to ensure visibility */
    .badge {
        font-weight: 600;
        backdrop-filter: blur(10px) !important;
        -webkit-backdrop-filter: blur(10px) !important;
    }
    
    /* Stock badge styling */
    .stock-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 12px;
        color: white;
        font-weight: 700;
        text-align: center;
        min-width: 30px;
        background: linear-gradient(135deg, rgba(40, 60, 100, 0.5), rgba(50, 70, 120, 0.6)) !important;
        backdrop-filter: blur(10px) !important;
        -webkit-backdrop-filter: blur(10px) !important;
        box-shadow: 0 2px 8px rgba(20, 40, 80, 0.2);
    }
    
    .stock-badge.critical {
        background: linear-gradient(135deg, rgba(220, 53, 69, 0.7), rgba(190, 30, 45, 0.8)) !important;
    }
    
    .stock-badge.low {
        background: linear-gradient(135deg, rgba(255, 193, 7, 0.7), rgba(225, 163, 0, 0.8)) !important;
    }
    
    /* Button styling in tables */
    .table .btn-outline-primary {
        color: white !important;
        border-color: rgba(255, 255, 255, 0.5) !important;
        background: linear-gradient(135deg, rgba(40, 60, 100, 0.4), rgba(50, 70, 120, 0.5)) !important;
        backdrop-filter: blur(10px) !important;
        -webkit-backdrop-filter: blur(10px) !important;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    
    .table .btn-outline-primary:hover {
        background: linear-gradient(135deg, rgba(50, 70, 120, 0.6), rgba(60, 80, 140, 0.7)) !important;
        box-shadow: 0 4px 12px rgba(20, 40, 80, 0.3);
    }
    
    /* Keep some specific styling */
    .product-card {
        border-left: 4px solid transparent;
    }
    
    .expire-soon {
        border-left-color: #dc3545;
    }
    
    .expire-warning {
        border-left-color: #ffc107;
    }
    
    .expire-ok {
        border-left-color: #198754;
    }
    
    .stock-low {
        background-color: rgba(220, 53, 69, 0.1);
    }
    
    .section-header {
        background-color: transparent !important;
        border-left: 4px solid #0d6efd;
        padding: 10px 15px;
        margin-bottom: 20px;
    }
    
    /* Page title styling */
    h1.mb-4 {
        color: #fff !important;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        margin-top: 1rem;
    }
    
    /* Updated text colors for dark background */
    h1, h2, h3, h4, h5, h6, p, span, div, label, .chart-title, .metric-title {
        color: #fff !important;
    }
    
    /* Special contrast for chart labels and axes */
    .chart-container canvas {
        filter: brightness(1.2) contrast(1.1);
    }
    
    /* Mobile responsiveness */
    @media (max-width: 992px) {
        .glass-sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .glass-sidebar.show {
            transform: translateX(0);
        }
        
        .content-wrapper {
            margin-left: 0;
            width: 100%;
        }
        
        .sidebar-toggle {
            display: block;
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1100;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
        }
    }
    
    @media (min-width: 993px) {
        .sidebar-toggle {
            display: none;
        }
    }
</style>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

<!-- Chart.js Matrix Plugin -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.1.1/dist/chartjs-chart-matrix.min.js"></script>
{% endblock %}

{% block content %}
<!-- Video Background -->
<div class="video-background">
    <video autoplay muted loop playsinline>
        <source src="{{ url_for('static', filename='videos/graphs-and-charts-information-over-world-map-background-4k-free-video.mp4') }}" type="video/mp4">
        Your browser does not support the video tag.
    </video>
</div>

<!-- Mobile sidebar toggle button -->
<button class="sidebar-toggle btn" id="sidebarToggle">
    <i class="fas fa-bars"></i>
</button>

<!-- Glass Sidebar -->
<div class="glass-sidebar" id="glassSidebar">
    <div class="sidebar-header">
        <div class="sidebar-logo">
            <i class="fas fa-chart-line"></i>
            <h3>Stock Management</h3>
        </div>
    </div>
    
    <!-- Navigation Links -->
    <ul class="sidebar-nav">
        <li>
            <a href="/">
                <i class="fas fa-home"></i> Home
            </a>
        </li>
        <li>
            <a href="/dashboard/strategic">
                <i class="fas fa-chess"></i> Strategic Dashboard
            </a>
        </li>
        <li>
            <a href="/dashboard/tactical" class="active">
                <i class="fas fa-tasks"></i> Tactical Dashboard
            </a>
        </li>
        <li>
            <a href="/dashboard/analytical">
                <i class="fas fa-chart-bar"></i> Analytical Dashboard
            </a>
        </li>
    </ul>
    
    <div class="sidebar-divider"></div>
    
    <!-- Filters Section -->
    <div class="filter-section">
        <h5><i class="fas fa-filter me-2"></i>Filters</h5>
        
        <label for="categoryFilter" class="form-label">Product Category</label>
        <select class="form-select" id="categoryFilter">
            <option value="all">All Categories</option>
            {% for category in categories %}
            <option value="{{ category.CategoryName }}">{{ category.CategoryName }}</option>
            {% endfor %}
        </select>
        
        <div class="mt-3">
            <label for="dateRangeFilter" class="form-label">Date Range</label>
            <select class="form-select" id="dateRangeFilter">
                <option value="3">Last 3 Months</option>
                <option value="6" selected>Last 6 Months</option>
                <option value="12">Last 12 Months</option>
                <option value="24">Last 24 Months</option>
                <option value="all">All Time</option>
            </select>
        </div>
        
        <div class="mt-3">
            <label for="yearFilter" class="form-label">Year</label>
            <select class="form-select" id="yearFilter">
                <option value="all" selected>All Years</option>
                <option value="2023">2023</option>
                <option value="2022">2022</option>
                <option value="2021">2021</option>
                <option value="2020">2020</option>
            </select>
        </div>
        
        <div class="mt-3">
            <label for="stockLevelFilter" class="form-label">Stock Level</label>
            <select class="form-select" id="stockLevelFilter">
                <option value="all" selected>All Levels</option>
                <option value="critical">Critical</option>
                <option value="low">Low</option>
                <option value="normal">Normal</option>
                <option value="high">High</option>
            </select>
        </div>
        
        <div class="mt-3">
            <label for="supplierFilter" class="form-label">Supplier</label>
            <select class="form-select" id="supplierFilter">
                <option value="all" selected>All Suppliers</option>
                {% for supplier in suppliers %}
                <option value="{{ supplier.SupplierName }}">{{ supplier.SupplierName }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="mt-4">
            <button type="button" class="btn btn-primary w-100" onclick="applyFilters()">
                <i class="fas fa-check me-2"></i>Apply Filters
            </button>
            <button type="button" class="btn btn-outline-light w-100 mt-2" onclick="resetFilters()">
                <i class="fas fa-sync-alt me-2"></i>Reset Filters
            </button>
        </div>
    </div>
</div>

<!-- Main Content - using Strategic dashboard's inline styling approach -->
<div style="margin-left: 290px; width: calc(100% - 290px); background: transparent !important; padding: 0; position: relative; z-index: 1;">
    <h1 class="mb-4">Tactical Dashboard — Shipment Optimization</h1>


<!-- Section 1: Context -->
<style>
    /* Circular progress indicator styles */
    /* Individual circular indicators will float on their own */
    
    .circular-indicator {
        position: relative;
        width: 180px;
        height: 180px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        filter: drop-shadow(0px 5px 15px rgba(0, 0, 0, 0.1));
    }
    
    .circle-bg {
        position: absolute;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        border: 1px solid rgba(0, 0, 0, 0.1);
        z-index: 1;
    }
    
    .circle-progress {
        position: absolute;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        z-index: 0;
    }
    
    .circle-content {
        z-index: 2;
        text-align: center;
    }
    
    .circle-value {
        font-size: 24px;
        font-weight: 700;
        color: #000;
        margin-bottom: 5px;
        text-shadow: none;
    }
    
    .circle-title {
        font-size: 12px;
        color: rgba(0, 0, 0, 0.9);
        text-align: center;
        font-weight: 600;
        max-width: 120px;
        text-shadow: none;
    }
    
    .blue-progress .circle-progress { background: conic-gradient(#1a73e8 0%, #1a73e8 calc(var(--progress) * 1%), rgba(0,0,0,0.07) calc(var(--progress) * 1%), rgba(0,0,0,0.07) 100%); }
    .blue-progress .circle-bg { border: 3px solid rgba(26, 115, 232, 0.3); }
    
    .green-progress .circle-progress { background: conic-gradient(#34a853 0%, #34a853 calc(var(--progress) * 1%), rgba(0,0,0,0.07) calc(var(--progress) * 1%), rgba(0,0,0,0.07) 100%); }
    .green-progress .circle-bg { border: 3px solid rgba(52, 168, 83, 0.3); }
    
    .orange-progress .circle-progress { background: conic-gradient(#f9ab00 0%, #f9ab00 calc(var(--progress) * 1%), rgba(0,0,0,0.07) calc(var(--progress) * 1%), rgba(0,0,0,0.07) 100%); }
    .orange-progress .circle-bg { border: 3px solid rgba(249, 171, 0, 0.3); }
    
    .purple-progress .circle-progress { background: conic-gradient(#8b46ff 0%, #8b46ff calc(var(--progress) * 1%), rgba(0,0,0,0.07) calc(var(--progress) * 1%), rgba(0,0,0,0.07) 100%); }
    .purple-progress .circle-bg { border: 3px solid rgba(139, 70, 255, 0.3); }
    
    .red-progress .circle-progress { background: conic-gradient(#ea4335 0%, #ea4335 calc(var(--progress) * 1%), rgba(0,0,0,0.07) calc(var(--progress) * 1%), rgba(0,0,0,0.07) 100%); }
    .red-progress .circle-bg { border: 3px solid rgba(234, 67, 53, 0.3); }
</style>

<!-- Removed heading per user request -->

<style>
    /* Glassmorphic container styling with gradient */
    .glassmorphic-container {
        background: linear-gradient(135deg, rgba(40, 60, 100, 0.35), rgba(50, 70, 120, 0.4)) !important;
        backdrop-filter: blur(20px) !important;
        -webkit-backdrop-filter: blur(20px) !important;
        border-radius: 15px;
        border: 1px solid rgba(100, 150, 220, 0.15);
        box-shadow: 0 8px 32px 0 rgba(20, 40, 80, 0.25);
        padding: 15px;
        margin-bottom: 20px;
    }
    
    /* Chart container specific styles */
    .chart-container {
        min-height: 480px;
    }
    
    .chart-area {
        position: relative;
        height: 430px;
        width: 100%;
        margin: 0;
    }
    
    .chart-title {
        margin-bottom: 15px;
    }
    
    .context-section {
        width: 100%;
        padding: 10px 10px;
        margin: 0;
    }
    
    /* Metrics row layout */
    .metrics-row {
        display: flex;
        justify-content: space-around;
        flex-wrap: nowrap;
        width: 100%;
        overflow-x: auto;
        padding: 10px 0;
    }
    
    .metrics-row::-webkit-scrollbar {
        height: 5px;
    }
    
    .metrics-row::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
    }
    
    .metric-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 15px;
        min-width: 170px;
        min-height: 220px;
        background: linear-gradient(135deg, rgba(40, 60, 100, 0.35), rgba(50, 70, 120, 0.4)) !important;
        backdrop-filter: blur(20px) !important;
        -webkit-backdrop-filter: blur(20px) !important;
        border-radius: 15px;
        border: 1px solid rgba(100, 150, 220, 0.15);
        box-shadow: 0 8px 32px 0 rgba(20, 40, 80, 0.25);
        margin: 0 10px 10px 0;
    }
    
    .metric-title {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 20px;
        color: white;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    
    .circle-indicator {
        width: 140px;
        height: 140px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        background: white;
        box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        margin-bottom: 15px;
    }
    
    .circle-value {
        font-size: 28px;
        font-weight: 700;
        color: #fff;
        text-shadow: 0 0 3px rgba(0,0,0,0.5);
    }
    
    /* Distinct colored borders */
    .blue-indicator {
        border: 12px solid #1a73e8;
    }
    
    .green-indicator {
        border: 12px solid #34a853;
    }
    
    .red-indicator {
        border: 12px solid #ea4335;
    }
    
    .orange-indicator {
        border: 12px solid #f9ab00;
    }
    
    .purple-indicator {
        border: 12px solid #a142f4;
    }
    
    /* Deep Dive Section Styling */
    .deep-dive-section {
        margin-top: 15px;
        width: 100%;
        padding: 0 10px;
    }
    
    .section-title {
        color: white;
        margin-bottom: 20px;
        font-weight: 700;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
    }
    
    .deep-dive-panel {
        margin-bottom: 25px;
        padding: 20px;
        border-radius: 15px;
        background: linear-gradient(135deg, rgba(40, 60, 100, 0.35), rgba(50, 70, 120, 0.4)) !important;
        backdrop-filter: blur(20px) !important;
        -webkit-backdrop-filter: blur(20px) !important;
        border: 1px solid rgba(100, 150, 220, 0.15);
        box-shadow: 0 8px 32px 0 rgba(20, 40, 80, 0.25);
    }
    
    .panel-title .badge {
        margin-left: 10px;
        padding: 5px 10px;
        font-size: 12px;
    }
    
    .filters-row {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .filter-group {
        flex: 1;
        min-width: 150px;
    }
    
    .filter-group label {
        display: block;
        margin-bottom: 5px;
        color: white;
        font-size: 14px;
    }
    
    .filter-group select, .filter-group input {
        width: 100%;
        padding: 8px 12px;
        background: linear-gradient(135deg, rgba(40, 60, 100, 0.35), rgba(50, 70, 120, 0.4)) !important;
        backdrop-filter: blur(20px) !important;
        -webkit-backdrop-filter: blur(20px) !important;
        border: 1px solid rgba(100, 150, 220, 0.15);
        border-radius: 5px;
        color: white;
        box-shadow: 0 4px 16px rgba(20, 40, 80, 0.15);
    }
    
    .filter-button {
        align-self: flex-end;
        background: linear-gradient(135deg, rgba(13, 110, 253, 0.7), rgba(25, 135, 255, 0.8)) !important;
        border: 1px solid rgba(100, 150, 220, 0.3);
        padding: 8px 20px;
        margin-top: 19px;
        box-shadow: 0 4px 16px rgba(13, 110, 253, 0.3);
    }
    
    .deep-dive-panel {
        margin-bottom: 30px;
        padding: 20px;
        background: linear-gradient(135deg, rgba(40, 60, 100, 0.35), rgba(50, 70, 120, 0.4)) !important;
        backdrop-filter: blur(20px) !important;
        -webkit-backdrop-filter: blur(20px) !important;
        border-radius: 15px;
        border: 1px solid rgba(100, 150, 220, 0.15);
        box-shadow: 0 8px 32px 0 rgba(20, 40, 80, 0.25);
    }
    
    #lowStockTable {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        color: white;
    }
    
    #lowStockTable thead th {
        background: linear-gradient(135deg, rgba(40, 60, 100, 0.5), rgba(50, 70, 120, 0.55)) !important;
        padding: 12px 15px;
        font-weight: 600;
        border-bottom: 1px solid rgba(100, 150, 220, 0.15);
    }
    
    #lowStockTable tbody tr {
        background: linear-gradient(135deg, rgba(40, 60, 100, 0.25), rgba(50, 70, 120, 0.3)) !important;
        backdrop-filter: blur(15px) !important;
        -webkit-backdrop-filter: blur(15px) !important;
    }
    
    #lowStockTable tbody tr.low-stock {
        border-left: 4px solid #ffc107;
    }
    
    #lowStockTable tbody tr.critical-stock {
        border-left: 4px solid #dc3545;
    }
    
    #lowStockTable td {
        padding: 12px 15px;
        vertical-align: middle;
        border-bottom: 1px solid rgba(100, 150, 220, 0.1);
    }
    
    .stock-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 20px;
        font-weight: bold;
        backdrop-filter: blur(10px) !important;
        -webkit-backdrop-filter: blur(10px) !important;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .stock-badge.critical {
        background: linear-gradient(135deg, rgba(220, 53, 69, 0.3), rgba(250, 70, 80, 0.4)) !important;
        border: 1px solid rgba(220, 53, 69, 0.4);
        color: #ff8d8d;
    }
    
    .stock-badge.low {
        background: linear-gradient(135deg, rgba(255, 193, 7, 0.3), rgba(255, 205, 40, 0.4)) !important;
        border: 1px solid rgba(255, 193, 7, 0.4);
        color: #ffdb72;
    }
    
    /* Timeline Styling */
    .expiry-timeline {
        overflow-x: auto;
    }
    
    .timeline-container {
        display: flex;
        padding: 15px 0;
        min-width: 600px;
    }
    
    .timeline-group {
        flex: 1;
        padding: 0 10px;
    }
    
    .timeline-header {
        background: linear-gradient(135deg, rgba(40, 60, 100, 0.5), rgba(50, 70, 120, 0.55)) !important;
        padding: 10px 15px;
        border-radius: 5px 5px 0 0;
        color: white;
        font-weight: 500;
        text-align: center;
        border-bottom: 1px solid rgba(100, 150, 220, 0.15);
    }
    
    .timeline-items {
        background: linear-gradient(135deg, rgba(40, 60, 100, 0.35), rgba(50, 70, 120, 0.4)) !important;
        backdrop-filter: blur(20px) !important;
        -webkit-backdrop-filter: blur(20px) !important;
        padding: 10px;
        height: 250px;
        overflow-y: auto;
        border-radius: 0 0 5px 5px;
        border: 1px solid rgba(100, 150, 220, 0.15);
        border-top: none;
    }
    
    .timeline-item {
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
        border-left: 3px solid transparent;
        background: linear-gradient(135deg, rgba(40, 60, 100, 0.25), rgba(50, 70, 120, 0.3)) !important;
        backdrop-filter: blur(15px) !important;
        -webkit-backdrop-filter: blur(15px) !important;
        border: 1px solid rgba(100, 150, 220, 0.1);
    }
    
    .timeline-item.critical {
        border-left-color: #dc3545;
        box-shadow: 0 0 10px rgba(220, 53, 69, 0.25);
    }
    
    .timeline-item.warning {
        border-left-color: #ffc107;
        box-shadow: 0 0 10px rgba(255, 193, 7, 0.25);
    }
    
    .timeline-item.normal {
        border-left-color: #6c757d;
        box-shadow: 0 0 10px rgba(108, 117, 125, 0.25);
    }
    
    .item-header {
        font-weight: 600;
        color: white;
    }
    
    .item-date {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 5px;
    }
    
    /* Restock Recommendations Styling */
    .restock-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 15px;
    }
    
    .restock-item {
        background: linear-gradient(135deg, rgba(40, 60, 100, 0.35), rgba(50, 70, 120, 0.4)) !important;
        backdrop-filter: blur(20px) !important;
        -webkit-backdrop-filter: blur(20px) !important;
        padding: 15px;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        border: 1px solid rgba(100, 150, 220, 0.15);
        box-shadow: 0 8px 32px 0 rgba(20, 40, 80, 0.25);
    }
    
    .item-name {
        font-weight: 600;
        color: white;
    }
    
    .item-category {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.7);
    }
    
    .progress-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        color: rgba(255, 255, 255, 0.8);
        font-size: 13px;
    }
    
    .progress {
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
    }
    
    .btn-xs {
        padding: 1px 5px;
        font-size: 12px;
        border-radius: 3px;
        margin-top: 5px;
    }
    
    /* Chart Grid Layout */
    .chart-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        grid-gap: 15px;
        width: 100%;
        max-width: 100%;
        padding: 0 10px;
        margin: 0;
    }
    
    /* Special container for charts that must stay side by side */
    .side-by-side-charts {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        grid-gap: 15px;
        width: 100%;
        margin-bottom: 15px;
        padding: 0 10px;
        margin-top: 0;
    }
    
    /* Keep side-by-side charts together even on smaller screens */
    @media (max-width: 1200px) {
        .chart-grid {
            grid-template-columns: 1fr;
        }
        
        .side-by-side-charts {
            grid-template-columns: repeat(2, 1fr); /* Keep 2-column layout */
        }
    }
    
    /* Only on very small screens, stack the side-by-side charts */
    @media (max-width: 768px) {
        .side-by-side-charts {
            grid-template-columns: 1fr;
        }
    }
    
    .chart-container {
        position: relative;
        padding: 15px;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(5px);
        border-radius: 15px;
        padding: 15px;
        width: 100%;
        margin-bottom: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    .chart-title {
        color: white !important;
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 10px;
        text-align: center;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
    }
    
    .chart-area {
        width: 100%;
        height: 350px; /* Shorter height but wider width */
        position: relative;
    }
    
    /* Responsive layout for smaller screens */
    @media (max-width: 992px) {
        .chart-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="glassmorphic-container context-section">
    <div class="metrics-row">
        <!-- Total Products -->
        <div class="metric-card">
            <div class="metric-title">Total Products</div>
            <div class="circle-indicator blue-indicator">
                <div class="circle-value">{{ total_products|default(0) }}</div>
            </div>
        </div>
        
        <!-- Average Stock Level -->
        <div class="metric-card">
            <div class="metric-title">Average Stock</div>
            <div class="circle-indicator green-indicator">
                <div class="circle-value">{{ avg_stock|default(0)|round(1) }}</div>
            </div>
        </div>
        
        <!-- Near Expiry Products -->
        <div class="metric-card">
            <div class="metric-title">Near Expiry</div>
            <div class="circle-indicator red-indicator">
                <div class="circle-value">{{ near_expiry_count|default(0) }}</div>
            </div>
        </div>
        
        <!-- Average Price -->
        <div class="metric-card">
            <div class="metric-title">Average Price</div>
            <div class="circle-indicator orange-indicator">
                <div class="circle-value">${{ avg_price|default(0)|round(2) }}</div>
            </div>
        </div>
        
        <!-- Top Category -->
        <div class="metric-card">
            <div class="metric-title">Top Category</div>
            <div class="circle-indicator purple-indicator">
                <div class="circle-value" style="font-size: 18px;">{{ top_category_name|default('None') }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Charts that will ALWAYS stay side by side -->
<div class="side-by-side-charts">
    <!-- Chart 1: Stock Availability Matrix (Heatmap) -->
    <div class="glassmorphic-container chart-container">
        <h4 class="chart-title">Stock Availability Matrix</h4>
        <div class="chart-area">
            <canvas id="stockHeatmap"></canvas>
            <div class="chart-loading">Loading data...</div>
        </div>
    </div>
    
    <!-- Chart 2: Expiring Products Over Time (Area Chart) -->
    <div class="glassmorphic-container chart-container">
        <h4 class="chart-title">Expiring Products Over Time</h4>
        <div class="chart-area">
            <canvas id="expiringProductsChart"></canvas>
            <div class="chart-loading">Loading data...</div>
        </div>
    </div>
</div>

<!-- Remaining charts in regular grid -->
<div class="chart-grid">
    <!-- Chart 3: Low Stock Warnings (Bubble Chart) -->
    <div class="glassmorphic-container chart-container">
        <h4 class="chart-title">Low Stock Warnings</h4>
        <div class="chart-area">
            <canvas id="lowStockBubbleChart"></canvas>
            <div class="chart-loading">Loading data...</div>
        </div>
    </div>
    
    <!-- Chart 4: Stock Utilization Ratio by Tag (Donut Chart) -->
    <div class="glassmorphic-container chart-container">
        <h4 class="chart-title">Stock Utilization Ratio by Tag</h4>
        <div class="chart-area">
            <canvas id="stockUtilizationChart"></canvas>
            <div class="chart-loading">Loading data...</div>
        </div>
    </div>
</div>

<!-- Deep Dive Section -->
<div class="glassmorphic-container deep-dive-section">
    <h3 class="section-title">Deep Dive Analysis</h3>
    
    <!-- Filters Row -->
    <div class="filters-row mb-4">
        <div class="filter-group">
            <label for="categoryFilter">Category</label>
            <select id="categoryFilter" class="form-select filter-select">
                <option value="all">All Categories</option>
                <option value="electronics">Electronics</option>
                <option value="food">Food & Beverage</option>
                <option value="clothing">Clothing</option>
                <option value="health">Health & Beauty</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="stockLevelFilter">Stock Level</label>
            <select id="stockLevelFilter" class="form-select filter-select">
                <option value="all">All Levels</option>
                <option value="critical">Critical (< 5)</option>
                <option value="low">Low (< 10)</option>
                <option value="medium">Medium (< 20)</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="expiryRangeFilter">Expiry Range</label>
            <select id="expiryRangeFilter" class="form-select filter-select">
                <option value="all">All Ranges</option>
                <option value="7days">Next 7 Days</option>
                <option value="14days">Next 14 Days</option>
                <option value="30days">Next 30 Days</option>
            </select>
        </div>
        
        <button id="applyFilters" class="btn btn-primary filter-button">
            Apply Filters
        </button>
    </div>
    
    <!-- Low Stock Products Table -->
    <div class="deep-dive-panel">
        <h4 class="panel-title">Low Stock Products <span class="badge bg-danger">Urgent</span></h4>
        <div class="table-responsive">
            <table id="lowStockTable" class="table table-borderless low-stock-table">
                <thead>
                    <tr>
                        <th>Product Name</th>
                        <th>Stock Qty</th>
                        <th>Category</th>
                        <th>Rating</th>
                        <th>Expiry Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="lowStockTableBody">
                    <!-- Sample rows, will be populated with actual data -->
                    <tr class="critical-stock">
                        <td>Organic Whole Milk</td>
                        <td><span class="stock-badge critical">2</span></td>
                        <td>Food & Beverage</td>
                        <td>★★★★☆</td>
                        <td>Jun 20, 2025</td>
                        <td><button class="btn btn-sm btn-outline-primary">Restock</button></td>
                    </tr>
                    <tr class="low-stock">
                        <td>Premium Wireless Earbuds</td>
                        <td><span class="stock-badge low">8</span></td>
                        <td>Electronics</td>
                        <td>★★★★★</td>
                        <td>N/A</td>
                        <td><button class="btn btn-sm btn-outline-primary">Restock</button></td>
                    </tr>
                    <tr class="critical-stock">
                        <td>Natural Face Moisturizer</td>
                        <td><span class="stock-badge critical">3</span></td>
                        <td>Health & Beauty</td>
                        <td>★★★★☆</td>
                        <td>Dec 15, 2025</td>
                        <td><button class="btn btn-sm btn-outline-primary">Restock</button></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Expiring Soon Timeline -->
    <div class="deep-dive-panel">
        <h4 class="panel-title">Expiring Soon Products <span class="badge bg-warning text-dark">Action Needed</span></h4>
        <div class="expiry-timeline">
            <div class="timeline-container" id="expiryTimeline">
                <!-- Will be populated with actual data -->
                <div class="timeline-group">
                    <div class="timeline-header">Next 7 Days</div>
                    <div class="timeline-items">
                        <div class="timeline-item critical">
                            <div class="item-header">Fresh Yogurt (20 units)</div>
                            <div class="item-date">June 18, 2025</div>
                            <button class="btn btn-xs btn-danger">Priority Ship</button>
                        </div>
                        <div class="timeline-item critical">
                            <div class="item-header">Organic Eggs (15 units)</div>
                            <div class="item-date">June 19, 2025</div>
                            <button class="btn btn-xs btn-danger">Priority Ship</button>
                        </div>
                    </div>
                </div>
                
                <div class="timeline-group">
                    <div class="timeline-header">8-14 Days</div>
                    <div class="timeline-items">
                        <div class="timeline-item warning">
                            <div class="item-header">Whole Wheat Bread (10 units)</div>
                            <div class="item-date">June 23, 2025</div>
                            <button class="btn btn-xs btn-warning">Plan Shipment</button>
                        </div>
                    </div>
                </div>
                
                <div class="timeline-group">
                    <div class="timeline-header">15-30 Days</div>
                    <div class="timeline-items">
                        <div class="timeline-item normal">
                            <div class="item-header">Organic Milk (25 units)</div>
                            <div class="item-date">July 10, 2025</div>
                            <button class="btn btn-xs btn-secondary">Monitor</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Restock Recommendations -->
    <div class="deep-dive-panel">
        <h4 class="panel-title">Restock Recommendations</h4>
        <div class="restock-container" id="restockRecommendations">
            <!-- Will be populated with actual data -->
            <div class="restock-item">
                <div class="restock-info">
                    <div class="item-name">Premium Coffee Beans</div>
                    <div class="item-category">Food & Beverage</div>
                </div>
                <div class="restock-progress">
                    <div class="progress-label">
                        <span>Current: 3</span>
                        <span>Recommended: 20</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar bg-danger" role="progressbar" style="width: 15%" aria-valuenow="3" aria-valuemin="0" aria-valuemax="20"></div>
                    </div>
                </div>
                <button class="btn btn-sm btn-primary">Order Now</button>
            </div>
            
            <div class="restock-item">
                <div class="restock-info">
                    <div class="item-name">Wireless Headphones</div>
                    <div class="item-category">Electronics</div>
                </div>
                <div class="restock-progress">
                    <div class="progress-label">
                        <span>Current: 5</span>
                        <span>Recommended: 15</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar bg-warning" role="progressbar" style="width: 33%" aria-valuenow="5" aria-valuemin="0" aria-valuemax="15"></div>
                    </div>
                </div>
                <button class="btn btn-sm btn-primary">Order Now</button>
            </div>
        </div>
    </div>
</div>
</div> <!-- Close the content-wrapper div -->
{% endblock %}

{% block scripts %}
<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Chart.js Heatmap plugin (for matrix chart) -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.2.0/dist/chartjs-chart-matrix.min.js"></script>

<script type="text/javascript">
// Remove all dark backgrounds immediately on page load
document.addEventListener('DOMContentLoaded', function() {
    // Force transparent background on all elements
    document.body.style.backgroundColor = 'transparent';
    document.documentElement.style.backgroundColor = 'transparent';
    document.body.style.background = 'none';
    document.documentElement.style.background = 'none';

    // Remove all background colors
    const allElements = document.querySelectorAll('*');
    allElements.forEach(el => {
        if (el.classList.contains('video-background') || 
            el.classList.contains('glass-sidebar') || 
            el.classList.contains('circular-indicator') ||
            el.classList.contains('circle-bg')) {
            // Keep these elements' backgrounds
            return;
        }
        el.style.setProperty('background-color', 'transparent', 'important');
        el.style.setProperty('background', 'none', 'important');
    });

    // Make the content wrapper completely transparent
    const contentWrapper = document.querySelector('.content-wrapper');
    if (contentWrapper) {
        contentWrapper.style.setProperty('background-color', 'transparent', 'important');
        contentWrapper.style.setProperty('background', 'none', 'important');
    }
});

// Filter products table by category
document.getElementById('categoryFilter').addEventListener('change', function() {
    const category = this.value;
    document.querySelectorAll('.product-row').forEach(row => {
        const rowCategory = row.getAttribute('data-category');
        if (category === 'all' || rowCategory === category) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Mobile sidebar toggle functionality
const sidebarToggle = document.getElementById('sidebarToggle');
const glassSidebar = document.getElementById('glassSidebar');

if (sidebarToggle && glassSidebar) {
    sidebarToggle.addEventListener('click', function() {
        glassSidebar.classList.toggle('show-sidebar');
    });
}

// Debug function to log details about chart data and rendering process
function debugLog(message, data) {
    console.log('DEBUG: ' + message, data);
}

// Add CSS for loading indicators
document.head.insertAdjacentHTML('beforeend', `
    <style>
        .chart-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(0, 0, 0, 0.7);
            font-size: 16px;
            z-index: 5;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 10px 20px;
            border-radius: 5px;
        }
    </style>
`);

// Initialize Chart.js plugins
document.addEventListener('DOMContentLoaded', function() {
    debugLog('DOM loaded, initializing charts');
    
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded! Adding script dynamically.');
        
        // Dynamically add Chart.js if missing
        const chartScript = document.createElement('script');
        chartScript.src = 'https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js';
        document.head.appendChild(chartScript);
        
        const matrixScript = document.createElement('script');
        matrixScript.src = 'https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.1.1/dist/chartjs-chart-matrix.min.js';
        document.head.appendChild(matrixScript);
        
        // Wait for scripts to load
        setTimeout(() => {
            debugLog('Dynamically loaded Chart.js, initializing charts now');
            // Fetch and create all charts
            fetchStockMatrixData();
            fetchExpiringProductsData();
            fetchLowStockData();
            fetchStockUtilizationData();
        }, 1000);
    } else {
        debugLog('Chart.js found, initializing charts');
        // Fetch and create all charts
        fetchStockMatrixData();
        fetchExpiringProductsData();
        fetchLowStockData();
        fetchStockUtilizationData();
    }
});


// Error handler for chart data fetching
function handleChartError(chartId, error) {
    console.error(`Error loading data for ${chartId}:`, error);
    const loadingElement = document.querySelector(`#${chartId}`).closest('.chart-area').querySelector('.chart-loading');
    if (loadingElement) {
        loadingElement.innerHTML = 'Failed to load data. Please refresh the page.<br><small>' + error.message + '</small>';
        loadingElement.style.backgroundColor = 'rgba(234, 67, 53, 0.7)';
    }
}

// 1. Fetch data for Stock Availability Matrix (Heatmap)
function fetchStockMatrixData() {
    debugLog('Fetching stock matrix data');
    console.log('Fetching stock matrix data from API...');
    fetch('/api/stock_availability_matrix')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            debugLog('Stock matrix data received:', data);
            // Log complete data structure for debugging
            console.log('Stock matrix API full data:', data);
            // Show that the chart container exists
            console.log('Chart container exists:', document.getElementById('stockHeatmap') !== null);
            try {
                // Pass the entire data object which contains data, categories, regions
                createStockMatrix(data);
            } catch (err) {
                console.error('Error creating stock matrix chart:', err);
                console.error('Error details:', err.message);
                console.error('Stack trace:', err.stack);
            }
        })
        .catch(error => {
            console.error('Failed to fetch matrix data:', error);
            handleChartError('stockHeatmap', error);
        });
}

// Create the Stock Availability Matrix chart
function createStockMatrix(apiData) {
    debugLog('Creating stock matrix chart with data', apiData);
    const canvas = document.getElementById('stockHeatmap');
    if (!canvas) {
        console.error('Cannot find canvas element #stockHeatmap');
        return;
    }
    const ctx = canvas.getContext('2d');
    
    // Clear any existing chart
    if (window.stockMatrixChart instanceof Chart) {
        window.stockMatrixChart.destroy();
    }
    
    createMatrixChart(ctx, apiData);
}

function createMatrixChart(ctx, apiData) {
    console.log('Creating matrix chart with data:', apiData);
    // Extract categories, regions, and data from the API response
    let categories = [];
    let regions = [];
    let data = [];
    
    // Check if apiData has the expected structure
    if (apiData && apiData.categories) {
        categories = apiData.categories;
        regions = apiData.regions;
        
        // Process data items
        if (apiData.data && Array.isArray(apiData.data)) {
            apiData.data.forEach(item => {
                const categoryIndex = categories.indexOf(item.category);
                const regionIndex = regions.indexOf(item.region);
                
                if (categoryIndex !== -1 && regionIndex !== -1) {
                    // Use 'value' field from API (which is StockPercentage) 
                    const availability = parseFloat(item.value);
                    let color;
                    
                    // Color based on availability percentage
                    if (availability >= 80) {
                        color = 'rgba(52, 168, 83, 0.8)'; // Green for high availability
                    } else if (availability >= 50) {
                        color = 'rgba(249, 171, 0, 0.8)'; // Yellow for medium availability
                    } else if (availability >= 20) {
                        color = 'rgba(234, 67, 53, 0.8)'; // Red for low availability
                    } else {
                        color = 'rgba(0, 0, 0, 0.8)'; // Black for very low or out of stock
                    }
                    
                    data.push({
                        x: regionIndex,
                        y: categoryIndex,
                        v: availability,
                        color: color
                    });
                }
            });
        }
    }
    
    // Use sample data if no data points were generated
    if (data.length === 0) {
        console.warn('No data for stock matrix, using sample data');
        categories = ['Electronics', 'Clothing', 'Home', 'Sports'];
        regions = ['North', 'South', 'East', 'West'];
        
        // Generate random sample data
        for (let i = 0; i < categories.length; i++) {
            for (let j = 0; j < regions.length; j++) {
                const availability = Math.floor(Math.random() * 100);
                let color;
                
                if (availability >= 80) {
                    color = 'rgba(52, 168, 83, 0.8)';
                } else if (availability >= 50) {
                    color = 'rgba(249, 171, 0, 0.8)';
                } else if (availability >= 20) {
                    color = 'rgba(234, 67, 53, 0.8)';
                } else {
                    color = 'rgba(0, 0, 0, 0.8)';
                }
                
                data.push({
                    x: j,
                    y: i,
                    v: availability,
                    color: color
                });
            }
        }
    }
    
    // Create new matrix chart instance
    window.stockMatrixChart = new Chart(ctx, {
        type: 'matrix',
        data: {
            datasets: [{
                label: 'Stock Availability',
                data: data,
                backgroundColor: function(ctx) { 
                    return ctx.dataset.data[ctx.dataIndex].color;
                },
                borderColor: 'rgba(255, 255, 255, 0.8)',
                borderWidth: 1,
                width: function(ctx) {
                    // Check if chartArea is defined to avoid error
                    if (!ctx.chart.chartArea) {
                        return 20; // Default width if chart area not yet available
                    }
                    const a = ctx.chart.chartArea.right - ctx.chart.chartArea.left;
                    return Math.max(0, (a / Math.max(1, regions.length)) - 2);
                },
                height: function(ctx) {
                    // Check if chartArea is defined to avoid error
                    if (!ctx.chart.chartArea) {
                        return 20; // Default height if chart area not yet available
                    }
                    const a = ctx.chart.chartArea.bottom - ctx.chart.chartArea.top;
                    return Math.max(0, (a / Math.max(1, categories.length)) - 2);
                }
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        title: function() { return ''; },
                        label: function(ctx) {
                            const value = ctx.dataset.data[ctx.dataIndex].v;
                            const category = categories[ctx.dataset.data[ctx.dataIndex].y];
                            const region = regions[ctx.dataset.data[ctx.dataIndex].x];
                            return [`Category: ${category}`, `Region: ${region}`, `Stock Level: ${value}%`];
                        }
                    }
                },
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    type: 'category',
                    labels: regions,
                    ticks: {
                        color: 'white'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.2)'
                    }
                },
                y: {
                    type: 'category',
                    labels: categories,
                    offset: true,
                    ticks: {
                        color: 'white'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.2)'
                    }
                }
            }
        }
    });
    
    // Use sample data if no data points were generated
    if (data.length === 0) {
        console.warn('No data for stock matrix, using sample data');
        categories = ['Electronics', 'Clothing', 'Home', 'Sports'];
        regions = ['North', 'South', 'East', 'West'];
        
        // Generate random sample data
        for (let i = 0; i < categories.length; i++) {
            for (let j = 0; j < regions.length; j++) {
                const availability = Math.floor(Math.random() * 100);
                let color;
                
                if (availability >= 80) {
                    color = 'rgba(52, 168, 83, 0.8)';
                } else if (availability >= 50) {
                    color = 'rgba(249, 171, 0, 0.8)';
                } else if (availability >= 20) {
                    color = 'rgba(234, 67, 53, 0.8)';
                } else {
                    color = 'rgba(0, 0, 0, 0.8)';
                }
                
                data.push({
                    x: j,
                    y: i,
                    v: availability,
                    color: color
                });
            }
        }
    }
    
    // The chart has already been created and stored in window.stockMatrixChart at line ~935
    // Removing duplicate chart creation to fix rendering issues
}

// 2. Fetch data for Expiring Products Over Time (Area Chart)
function fetchExpiringProductsData() {
    debugLog('Fetching expiring products data');
    fetch('/api/expiring_products_trend')
        .then(response => {
            debugLog('Expiring products API response status:', response.status);
            if (!response.ok) {
                throw new Error(`Network response error: ${response.status}`);
            }
            return response.json().catch(err => {
                throw new Error('Failed to parse JSON response: ' + err.message);
            });
        })
        .then(data => {
            debugLog('Expiring products data received:', data);
            // Hide loading indicator
            const loadingElement = document.querySelector('#expiringProductsChart').closest('.chart-area').querySelector('.chart-loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
            try {
                createExpiringProductsChart(data);
            } catch (err) {
                throw new Error('Error creating area chart: ' + err.message);
            }
        })
        .catch(error => handleChartError('expiringProductsChart', error));
}

// Create the Expiring Products Over Time chart
function createExpiringProductsChart(apiData) {
    debugLog('Creating expiring products chart with data', apiData);
    const canvas = document.getElementById('expiringProductsChart');
    if (!canvas) {
        console.error('Cannot find canvas element #expiringProductsChart');
        return;
    }
    const ctx = canvas.getContext('2d');
    

    
    let months = [];
    let expiringProducts = [];
    
    if (apiData && Array.isArray(apiData)) {
        // Extract month labels and counts from API data
        apiData.forEach(item => {
            if (item.Month) {
                months.push(item.Month);
            }
            
            // Use the ExpCount property or fallback to ProductCount
            if (item.hasOwnProperty('ExpCount')) {
                expiringProducts.push(item.ExpCount);
            } else if (item.hasOwnProperty('ProductCount')) {
                expiringProducts.push(item.ProductCount);
            }
        });
    }
    
    // Fallback if no data
    if (months.length === 0) {
        months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    }
    
    if (expiringProducts.length === 0) {
        expiringProducts = [5, 8, 12, 15, 20, 25, 18, 22, 30, 25, 22, 18];
    }
    
    debugLog('Months:', months);
    debugLog('Expiring Products Data:', expiringProducts);
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: [{
                label: 'Expiring Products',
                data: expiringProducts,
                fill: true,
                backgroundColor: 'rgba(234, 67, 53, 0.2)',
                borderColor: 'rgba(234, 67, 53, 1)',
                borderWidth: 3,
                pointBackgroundColor: 'rgba(234, 67, 53, 1)',
                pointBorderColor: '#fff',
                pointRadius: 5,
                pointHoverRadius: 8,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: 'white'
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: 'white'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.2)'
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: 'white'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.2)'
                    },
                    title: {
                        display: true,
                        text: 'Number of Products',
                        color: 'white',
                        font: {
                            weight: 'bold'
                        }
                    }
                }
            }
        }
    });
}

// 3. Fetch data for Low Stock Warnings (Bubble Chart)
function fetchLowStockData() {
    debugLog('Fetching low stock data');
    fetch('/api/low_stock_warnings')
        .then(response => {
            debugLog('Low stock API response status:', response.status);
            if (!response.ok) {
                throw new Error(`Network response error: ${response.status}`);
            }
            return response.json().catch(err => {
                throw new Error('Failed to parse JSON response: ' + err.message);
            });
        })
        .then(data => {
            debugLog('Low stock data received:', data);
            // Hide loading indicator
            const loadingElement = document.querySelector('#lowStockBubbleChart').closest('.chart-area').querySelector('.chart-loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
            try {
                createLowStockBubbleChart(data);
            } catch (err) {
                throw new Error('Error creating bubble chart: ' + err.message);
            }
        })
        .catch(error => handleChartError('lowStockBubbleChart', error));
}

// Create the Low Stock Warnings chart
function createLowStockBubbleChart(apiData) {
    debugLog('Creating low stock bubble chart with data', apiData);
    const canvas = document.getElementById('lowStockBubbleChart');
    if (!canvas) {
        console.error('Cannot find canvas element #lowStockBubbleChart');
        return;
    }
    const ctx = canvas.getContext('2d');
    

    
    let bubbleData = [];
    
    if (apiData && Array.isArray(apiData)) {
        // Transform API data into bubble chart format
        bubbleData = apiData.map(item => {
            // Calculate bubble size based on CategoryCount (or use default value)
            const bubbleSize = item.CategoryCount ? Math.min(Math.max(item.CategoryCount * 2, 5), 30) : 10;
            
            return {
                x: item.StockQuantity || 0,  // Stock quantity for x-axis
                y: item.Rating || 3.5,      // Product rating for y-axis (default to 3.5 if missing)
                r: bubbleSize,               // Bubble size represents category count
                label: item.ProductName || 'Unknown Product'
            };
        });
    }
    
    // Fallback if no data
    if (bubbleData.length === 0) {
        debugLog('Using fallback sample data for bubble chart');
        bubbleData = [
            { x: 10, y: 4.5, r: 15, label: 'Product A' },
            { x: 15, y: 3.8, r: 8, label: 'Product B' },
            { x: 8, y: 4.2, r: 20, label: 'Product C' },
            { x: 5, y: 4.9, r: 10, label: 'Product D' },
            { x: 20, y: 3.5, r: 15, label: 'Product E' },
            { x: 3, y: 4.8, r: 25, label: 'Product F' },
            { x: 12, y: 4.1, r: 12, label: 'Product G' }
        ];
    }
    
    debugLog('Processed bubble data:', bubbleData);
    
    new Chart(ctx, {
        type: 'bubble',
        data: {
            datasets: [{
                label: 'Low Stock Products',
                centerText: bubbleData.map(d => d.label),
                data: bubbleData.map(item => ({ 
                    x: item.x, 
                    y: item.y, 
                    r: item.r
                })),
                backgroundColor: 'rgba(249, 171, 0, 0.7)',
                borderColor: 'rgba(249, 171, 0, 1)',
                borderWidth: 2,
                hoverBackgroundColor: 'rgba(249, 171, 0, 0.9)',
                hoverBorderWidth: 3,
                hoverBorderColor: 'white'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const dataPoint = bubbleData[context.dataIndex];
                            return dataPoint.label + ' - Stock: ' + dataPoint.x;
                        }
                    }
                }
            },
            scales: {
                x: {
                    min: 0,
                    max: 25,
                    title: {
                        display: true,
                        text: 'Stock Quantity',
                        color: 'white'
                    },
                    ticks: {
                        color: 'white'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.2)'
                    }
                },
                y: {
                    min: 3,
                    max: 5,
                    title: {
                        display: true,
                        text: 'Rating',
                        color: 'white'
                    },
                    ticks: {
                        color: 'white'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.2)'
                    }
                }
            }
        }
    });
}

// 4. Fetch data for Stock Utilization Ratio by Tag (Donut Chart)
function fetchStockUtilizationData() {
    debugLog('Fetching stock utilization data');
    fetch('/api/stock_utilization_ratio')
        .then(response => {
            debugLog('Stock utilization API response status:', response.status);
            if (!response.ok) {
                throw new Error(`Network response error: ${response.status}`);
            }
            return response.json().catch(err => {
                throw new Error('Failed to parse JSON response: ' + err.message);
            });
        })
        .then(data => {
            debugLog('Stock utilization data received:', data);
            // Hide loading indicator
            const loadingElement = document.querySelector('#stockUtilizationChart').closest('.chart-area').querySelector('.chart-loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
            try {
                createStockUtilizationChart(data);
            } catch (err) {
                throw new Error('Error creating donut chart: ' + err.message);
            }
        })
        .catch(error => handleChartError('stockUtilizationChart', error));
}

// Create the Stock Utilization Ratio by Tag chart
function createStockUtilizationChart(apiData) {
    debugLog('Creating stock utilization chart with data', apiData);
    const canvas = document.getElementById('stockUtilizationChart');
    if (!canvas) {
        console.error('Cannot find canvas element #stockUtilizationChart');
        return;
    }
    const ctx = canvas.getContext('2d');
    

    
    let labels = [];
    let data = [];
    
    if (apiData && Array.isArray(apiData)) {
        // Extract labels and values from API data
        apiData.forEach(item => {
            // Use Tag or ProductTag as the label
            if (item.Tag) {
                labels.push(item.Tag);
            } else if (item.ProductTag) {
                labels.push(item.ProductTag);
            }
            
            // Use UtilizationRatio or Percentage for the data
            if (item.hasOwnProperty('UtilizationRatio')) {
                data.push(item.UtilizationRatio);
            } else if (item.hasOwnProperty('Percentage')) {
                data.push(item.Percentage);
            } else if (item.hasOwnProperty('StockQuantity')) {
                data.push(item.StockQuantity);
            }
        });
    }
    
    // Fallback if no data
    if (labels.length === 0) {
        labels = ['Perishable', 'Non-perishable', 'Fragile', 'Heavy', 'Electronics'];
    }
    
    if (data.length === 0) {
        data = [30, 25, 15, 20, 10];
    }
    
    debugLog('Chart labels:', labels);
    debugLog('Chart data:', data);  // Utilization percentages
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: [
                    'rgba(26, 115, 232, 0.8)',
                    'rgba(52, 168, 83, 0.8)',
                    'rgba(249, 171, 0, 0.8)',
                    'rgba(234, 67, 53, 0.8)',
                    'rgba(139, 70, 255, 0.8)'
                ],
                borderColor: 'rgba(255, 255, 255, 0.9)',
                borderWidth: 3,
                hoverOffset: 15,
                hoverBorderWidth: 4,
                hoverBorderColor: 'white'
            }],
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        color: 'white',
                        font: {
                            weight: 'bold'
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${context.parsed}% utilized`;
                        }
                    }
                }
            },
            cutout: '65%',
            animation: {
                animateScale: true
            }
        }
    });
}

    // Close sidebar when clicking outside of it (only on mobile)
    document.addEventListener('click', function(event) {
        const isMobile = window.innerWidth < 993;
        const clickedInsideSidebar = glassSidebar.contains(event.target);
        const clickedOnToggle = sidebarToggle.contains(event.target);
        
        if (isMobile && !clickedInsideSidebar && !clickedOnToggle && glassSidebar.classList.contains('show-sidebar')) {
            glassSidebar.classList.remove('show-sidebar');
        }
    });
    
    // Deep Dive Section Functionality
    // Initialize the deep dive section
    function initDeepDiveSection() {
        // Set up event listeners for filters
        document.getElementById('applyFilters').addEventListener('click', applyFilters);
        
        // Initially load data
        fetchLowStockProducts();
        fetchExpiryProducts();
        fetchRestockRecommendations();
    }

    // Filter application function
function applyFilters() {
    // Get values from sidebar filters
    const categoryFilter = document.getElementById('categoryFilter').value;
    const dateRangeFilter = document.getElementById('dateRangeFilter').value;
    const yearFilter = document.getElementById('yearFilter').value;
    const stockLevelFilter = document.getElementById('stockLevelFilter').value;
    const supplierFilter = document.getElementById('supplierFilter').value;
    
    // Get values from deep-dive section filters if they exist
    const deepDiveCategory = document.getElementById('categoryFilter') ? document.getElementById('categoryFilter').value : 'all';
    const deepDiveStockLevel = document.getElementById('stockLevelFilter') ? document.getElementById('stockLevelFilter').value : 'all';
    const expiryRangeFilter = document.getElementById('expiryRangeFilter') ? document.getElementById('expiryRangeFilter').value : 'all';
    
    // Apply filters to charts and data visualizations
    // Replace these with actual function calls to update your charts
    updateChartsWithFilters(categoryFilter, dateRangeFilter, yearFilter, stockLevelFilter, supplierFilter);
    
    // Apply filters to low stock products table
    fetchLowStockProducts(categoryFilter, stockLevelFilter, supplierFilter);
    
    // Apply filters to expiry timeline
    fetchExpiryProducts(categoryFilter, expiryRangeFilter, dateRangeFilter);
    
    // Apply filters to restock recommendations
    fetchRestockRecommendations(categoryFilter, stockLevelFilter, supplierFilter);
    
    console.log(`Filters applied: Category=${categoryFilter}, DateRange=${dateRangeFilter}, Year=${yearFilter}, Stock=${stockLevelFilter}, Supplier=${supplierFilter}`);
}

// Reset all filters to default values
function resetFilters() {
    // Reset sidebar filters
    document.getElementById('categoryFilter').value = 'all';
    document.getElementById('dateRangeFilter').value = '6'; // Default to last 6 months
    document.getElementById('yearFilter').value = 'all';
    document.getElementById('stockLevelFilter').value = 'all';
    document.getElementById('supplierFilter').value = 'all';
    
    // Reset deep-dive section filters if they exist
    if (document.getElementById('expiryRangeFilter')) {
        document.getElementById('expiryRangeFilter').value = 'all';
    }
    
    // Apply the reset filters
    applyFilters();
    
    console.log('All filters have been reset to default values');
}

    // Fetch low stock products
    function fetchLowStockProducts(category = 'all', stockLevel = 'all', tag = 'all') {
        // In a real application, you would fetch this data from your API
        // For demonstration, we're using sample data
        const sampleData = [
            {
                name: 'Organic Whole Milk',
                stock: 2,
                category: 'Food & Beverage',
                rating: 4,
                expiry: 'Jun 20, 2025',
                critical: true
            },
            {
                name: 'Premium Wireless Earbuds',
                stock: 8,
                category: 'Electronics',
                rating: 5,
                expiry: 'N/A',
                critical: false
            },
            {
                name: 'Natural Face Moisturizer',
                stock: 3,
                category: 'Health & Beauty',
                rating: 4,
                expiry: 'Dec 15, 2025',
                critical: true
            },
            {
                name: 'Organic Protein Bars',
                stock: 5,
                category: 'Food & Beverage',
                rating: 3,
                expiry: 'Sep 10, 2025',
                critical: false
            },
            {
                name: 'Bluetooth Smart Speaker',
                stock: 4,
                category: 'Electronics',
                rating: 5,
                expiry: 'N/A',
                critical: true
            }
        ];
        
        // Filter the data based on selected filters
        let filteredData = sampleData;
        
        if (category !== 'all') {
            filteredData = filteredData.filter(item => item.category === category);
        }
        
        if (stockLevel !== 'all') {
            switch (stockLevel) {
                case 'critical':
                    filteredData = filteredData.filter(item => item.stock < 5);
                    break;
                case 'low':
                    filteredData = filteredData.filter(item => item.stock < 10);
                    break;
                case 'medium':
                    filteredData = filteredData.filter(item => item.stock < 20);
                    break;
            }
        }
        
        // Update the table with filtered data
        updateLowStockTable(filteredData);
    }

    // Update low stock table
    function updateLowStockTable(data) {
        const tableBody = document.getElementById('lowStockTableBody');
        tableBody.innerHTML = '';
        
        data.forEach(item => {
            const row = document.createElement('tr');
            row.className = item.critical ? 'critical-stock' : 'low-stock';
            
            // Generate rating stars
            const stars = '\u2605'.repeat(item.rating) + '\u2606'.repeat(5 - item.rating);
            
            row.innerHTML = `
                <td>${item.name}</td>
                <td><span class="stock-badge ${item.critical ? 'critical' : 'low'}">${item.stock}</span></td>
                <td>${item.category}</td>
                <td>${stars}</td>
                <td>${item.expiry}</td>
                <td><button class="btn btn-sm btn-outline-primary">Restock</button></td>
            `;
            
            tableBody.appendChild(row);
        });
    }

    // Fetch expiry products
    function fetchExpiryProducts(category = 'all', expiryRange = 'all') {
        // Sample data for demonstration
        // In a real application, you would fetch this from your API
        const next7Days = [
            {
                name: 'Fresh Yogurt',
                units: 20,
                date: 'June 18, 2025',
                critical: true
            },
            {
                name: 'Organic Eggs',
                units: 15,
                date: 'June 19, 2025',
                critical: true
            }
        ];
        
        const next14Days = [
            {
                name: 'Whole Wheat Bread',
                units: 10,
                date: 'June 23, 2025',
                critical: false
            },
            {
                name: 'Fresh Orange Juice',
                units: 12,
                date: 'June 25, 2025',
                critical: false
            }
        ];
        
        const next30Days = [
            {
                name: 'Organic Milk',
                units: 25,
                date: 'July 10, 2025',
                critical: false
            },
            {
                name: 'Chocolate Bars',
                units: 30,
                date: 'July 15, 2025',
                critical: false
            }
        ];
        
        // Filter based on selected expiry range
        let filteredData = {
            next7Days,
            next14Days,
            next30Days
        };
        
        // Update the timeline with filtered data
        updateExpiryTimeline(filteredData);
    }

    // Update expiry timeline
    function updateExpiryTimeline(data) {
        const timeline = document.getElementById('expiryTimeline');
        timeline.innerHTML = '';
        
        // Create 7 days section
        const group7Days = document.createElement('div');
        group7Days.className = 'timeline-group';
        group7Days.innerHTML = `
            <div class="timeline-header">Next 7 Days</div>
            <div class="timeline-items" id="timeline7Days"></div>
        `;
        timeline.appendChild(group7Days);
        
        const items7Days = document.getElementById('timeline7Days');
        data.next7Days.forEach(item => {
            const timelineItem = document.createElement('div');
            timelineItem.className = `timeline-item ${item.critical ? 'critical' : 'normal'}`;
            timelineItem.innerHTML = `
                <div class="item-header">${item.name} (${item.units} units)</div>
                <div class="item-date">${item.date}</div>
                <button class="btn btn-xs btn-danger">Priority Ship</button>
            `;
            items7Days.appendChild(timelineItem);
        });
        
        // Create 8-14 days section
        const group14Days = document.createElement('div');
        group14Days.className = 'timeline-group';
        group14Days.innerHTML = `
            <div class="timeline-header">8-14 Days</div>
            <div class="timeline-items" id="timeline14Days"></div>
        `;
        timeline.appendChild(group14Days);
        
        const items14Days = document.getElementById('timeline14Days');
        data.next14Days.forEach(item => {
            const timelineItem = document.createElement('div');
            timelineItem.className = 'timeline-item warning';
            timelineItem.innerHTML = `
                <div class="item-header">${item.name} (${item.units} units)</div>
                <div class="item-date">${item.date}</div>
                <button class="btn btn-xs btn-warning">Plan Shipment</button>
            `;
            items14Days.appendChild(timelineItem);
        });
        
        // Create 15-30 days section
        const group30Days = document.createElement('div');
        group30Days.className = 'timeline-group';
        group30Days.innerHTML = `
            <div class="timeline-header">15-30 Days</div>
            <div class="timeline-items" id="timeline30Days"></div>
        `;
        timeline.appendChild(group30Days);
        
        const items30Days = document.getElementById('timeline30Days');
        data.next30Days.forEach(item => {
            const timelineItem = document.createElement('div');
            timelineItem.className = 'timeline-item normal';
            timelineItem.innerHTML = `
                <div class="item-header">${item.name} (${item.units} units)</div>
                <div class="item-date">${item.date}</div>
                <button class="btn btn-xs btn-secondary">Monitor</button>
            `;
            items30Days.appendChild(timelineItem);
        });
    }

    // Fetch restock recommendations
    function fetchRestockRecommendations(category = 'all', stockLevel = 'all') {
        // Sample data for demonstration
        const sampleData = [
            {
                name: 'Premium Coffee Beans',
                category: 'Food & Beverage',
                current: 3,
                recommended: 20,
                percentage: 15
            },
            {
                name: 'Wireless Headphones',
                category: 'Electronics',
                current: 5,
                recommended: 15,
                percentage: 33
            },
            {
                name: 'Vitamin Supplements',
                category: 'Health & Beauty',
                current: 7,
                recommended: 25,
                percentage: 28
            },
            {
                name: 'Organic Tea Bags',
                category: 'Food & Beverage',
                current: 4,
                recommended: 18,
                percentage: 22
            }
        ];
        
        // Filter based on selected category
        let filteredData = sampleData;
        
        if (category !== 'all') {
            filteredData = filteredData.filter(item => item.category === category);
        }
        
        // Update the restock recommendations
        updateRestockRecommendations(filteredData);
    }

    // Update restock recommendations
    function updateRestockRecommendations(data) {
        const container = document.getElementById('restockRecommendations');
        container.innerHTML = '';
        
        data.forEach(item => {
            const restockItem = document.createElement('div');
            restockItem.className = 'restock-item';
            
            // Determine color class based on percentage
            let colorClass = 'bg-danger';
            if (item.percentage > 30) {
                colorClass = 'bg-warning';
            } else if (item.percentage > 60) {
                colorClass = 'bg-success';
            }
            
            restockItem.innerHTML = `
                <div class="restock-info">
                    <div class="item-name">${item.name}</div>
                    <div class="item-category">${item.category}</div>
                </div>
                <div class="restock-progress">
                    <div class="progress-label">
                        <span>Current: ${item.current}</span>
                        <span>Recommended: ${item.recommended}</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar ${colorClass}" role="progressbar" 
                             style="width: ${item.percentage}%" 
                             aria-valuenow="${item.current}" 
                             aria-valuemin="0" 
                             aria-valuemax="${item.recommended}"></div>
                    </div>
                </div>
                <button class="btn btn-sm btn-primary">Order Now</button>
            `;
            
            container.appendChild(restockItem);
        });
    }

    // Initialize the Deep Dive section when the page is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initDeepDiveSection, 1000); // Slight delay to ensure all other scripts have run
    });
    
    // Function to update all charts based on filter selections
    function updateChartsWithFilters(category, dateRange, year, stockLevel, supplier) {
        // Re-fetch data for each chart with the new filters applied
        console.log('Updating charts with filters:', { category, dateRange, year, stockLevel, supplier });
        
        // Update each chart with filtered data
        // The exact implementation will depend on your API structure
        // These are placeholder functions - adjust according to your actual implementation
        
        // 1. Stock Availability Matrix
        fetchStockMatrixData({
            category: category,
            dateRange: dateRange,
            year: year,
            stockLevel: stockLevel,
            supplier: supplier
        });
        
        // 2. Expiring Products Chart
        fetchExpiringProductsData({
            category: category,
            dateRange: dateRange,
            year: year,
            supplier: supplier
        });
        
        // 3. Low Stock Bubble Chart
        fetchLowStockData({
            category: category,
            stockLevel: stockLevel,
            supplier: supplier
        });
        
        // 4. Stock Utilization Chart
        fetchStockUtilizationData({
            category: category,
            dateRange: dateRange,
            year: year
        });
    }
</script>
{% endblock %}
